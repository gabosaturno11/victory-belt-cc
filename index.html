<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE ART OF CALISTHENICS | Victory Belt Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/kjua/0.9.0/kjua.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-void: #0a0a0c;
            --bg-deep: #0f1014;
            --bg-surface: #151519;
            --bg-elevated: #1a1a1f;
            --border-subtle: rgba(255,255,255,0.06);
            --border-hover: rgba(255,255,255,0.12);
            --border-active: rgba(255,170,0,0.4);
            --accent-gold: #ffaa00;
            --accent-glow: rgba(255,170,0,0.12);
            --accent-success: #00ff88;
            --accent-warning: #ff6b35;
            --accent-danger: #ff4466;
            --accent-blue: #00cfff;
            --accent-purple: #a855f7;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.6);
            --text-tertiary: rgba(255,255,255,0.3);
            --font-display: 'Sora', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Monaco', monospace;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            /* 8px spacing grid */
            --sp-1: 4px;
            --sp-2: 8px;
            --sp-3: 12px;
            --sp-4: 16px;
            --sp-5: 24px;
            --sp-6: 32px;
            --sp-8: 48px;
            /* readable line-length */
            --content-max: 960px;
            --prose-max: 720px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-display); background: var(--bg-void); color: var(--text-secondary); min-height: 100vh; -webkit-font-smoothing: antialiased; display: flex; flex-direction: column; overflow: hidden; height: 100vh; }

        .glaze { background: linear-gradient(135deg, rgba(255,255,255,0.015) 0%, rgba(255,255,255,0.005) 100%); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .panel { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); transition: border-color 0.25s; }
        .panel:hover { border-color: var(--border-hover); }

        .header { height: 52px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--sp-4); background: linear-gradient(135deg, var(--bg-void) 0%, #12100a 50%, var(--bg-void) 100%); flex-shrink: 0; }
        .logo { display: flex; align-items: center; gap: var(--sp-3); }
        .logo-icon { width: var(--sp-6); height: var(--sp-6); background: linear-gradient(135deg, var(--accent-gold), #cc8800); border-radius: var(--sp-2); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 16px rgba(255,170,0,0.2); flex-shrink: 0; }
        .logo-title { font-size: 14px; font-weight: 700; color: var(--text-primary); letter-spacing: 0.5px; }
        .logo-sub { font-size: 9px; color: var(--text-tertiary); letter-spacing: 0.5px; }

        .tabs { display: flex; gap: var(--sp-1); flex-wrap: wrap; }
        .tab { padding: var(--sp-2) var(--sp-3); border: none; background: transparent; color: var(--text-tertiary); font-family: var(--font-display); font-size: 10px; font-weight: 500; cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s; letter-spacing: 0.3px; white-space: nowrap; }
        .tab:hover { color: var(--text-secondary); background: var(--bg-surface); }
        .tab.active { background: var(--accent-glow); color: var(--accent-gold); }

        .kernel { height: 40px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: center; gap: var(--sp-6); flex-shrink: 0; }
        .kernel-item { display: flex; align-items: center; gap: var(--sp-2); font-size: 11px; }
        .kernel-dot { width: 6px; height: 6px; border-radius: 50%; }
        .kernel-label { color: var(--text-tertiary); font-family: var(--font-mono); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; }
        .kernel-value { color: var(--text-primary); font-weight: 600; }

        .main { flex: 1; overflow: hidden; display: flex; position: relative; }
        .section { width: 100%; height: 100%; display: none; position: relative; }
        .section.active { display: flex; }

        .sidebar { width: 220px; border-right: 1px solid var(--border-subtle); padding: var(--sp-4); display: flex; flex-direction: column; gap: var(--sp-2); background: var(--bg-deep); overflow-y: auto; flex-shrink: 0; }
        .sidebar-label { font-family: var(--font-mono); font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary); margin-bottom: var(--sp-1); }
        .sidebar-wide { width: 260px; }

        .content { flex: 1; overflow-y: auto; padding: var(--sp-5); }
        .content-split { flex: 1; display: flex; overflow: hidden; }
        .content-half { flex: 1; overflow-y: auto; padding: var(--sp-4); }
        .content-half + .content-half { border-left: 1px solid var(--border-subtle); }

        .btn { padding: var(--sp-2) var(--sp-3); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); background: var(--bg-surface); color: var(--text-secondary); font-family: var(--font-display); font-size: 10px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: var(--sp-1); line-height: 1; }
        .btn:hover { border-color: var(--border-active); color: var(--text-primary); transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(135deg, var(--accent-gold), #cc8800); color: #000; border: none; font-weight: 600; }
        .btn-primary:hover { box-shadow: 0 4px 12px rgba(255,170,0,0.3); }
        .btn-sm { padding: var(--sp-1) var(--sp-2); font-size: 9px; }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
        .btn-group { display: flex; gap: var(--sp-1); }

        input, select, textarea { background: var(--bg-deep); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font-display); padding: var(--sp-2) var(--sp-3); font-size: 11px; line-height: 1.4; transition: all 0.2s; width: 100%; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--border-active); box-shadow: 0 0 0 2px var(--accent-glow); }

        .badge { font-family: var(--font-mono); font-size: 8px; letter-spacing: 0.5px; text-transform: uppercase; padding: var(--sp-1) var(--sp-2); border-radius: 3px; background: var(--accent-glow); color: var(--accent-gold); line-height: 1; }
        .badge-green { background: rgba(0,255,136,0.12); color: var(--accent-success); }
        .badge-orange { background: rgba(255,107,53,0.12); color: var(--accent-warning); }
        .badge-red { background: rgba(255,68,102,0.12); color: var(--accent-danger); }
        .badge-blue { background: rgba(0,207,255,0.12); color: var(--accent-blue); }
        .badge-purple { background: rgba(168,85,247,0.12); color: var(--accent-purple); }

        /* TOC hierarchy: Part > Chapter > Section */
        .toc-item { background: var(--bg-deep); border: 1px solid var(--border-subtle); border-left: 2px solid #27272a; border-radius: var(--radius-sm); padding: var(--sp-2) var(--sp-3); cursor: grab; transition: all 0.15s; display: flex; align-items: center; gap: var(--sp-2); }
        .toc-item:hover { border-color: var(--border-hover); background: var(--bg-surface); }
        .toc-item .type-tag { font-family: var(--font-mono); font-size: 8px; color: var(--text-tertiary); min-width: 30px; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; }
        .toc-item .title { font-size: 12px; flex: 1; color: rgba(255,255,255,0.85); font-weight: 400; line-height: 1.4; }
        /* Part = Level 0: prominent, gradient accent, no indent */
        .toc-item.is-part { background: linear-gradient(135deg, rgba(102,126,234,0.08) 0%, rgba(118,75,162,0.08) 100%); border: 2px solid rgba(255,255,255,0.15); border-left: 4px solid #667eea; padding: 14px 16px; margin-top: var(--sp-3); border-radius: 10px; }
        .toc-item.is-part:hover { background: linear-gradient(135deg, rgba(102,126,234,0.14) 0%, rgba(118,75,162,0.14) 100%); border-color: rgba(255,255,255,0.25); }
        .toc-item.is-part .title { font-size: 15px; color: #ffffff; font-weight: 800; letter-spacing: 0.3px; text-transform: uppercase; }
        .toc-item.is-part .type-tag { color: #667eea; font-size: 9px; font-weight: 700; min-width: 36px; }
        /* Chapter = Level 1: indent, colored number, expandable */
        .toc-item.is-chapter { margin-left: 20px; border: 1px solid rgba(255,255,255,0.08); border-left: 3px solid rgba(102,126,234,0.4); background: rgba(255,255,255,0.02); padding: 10px 14px; border-radius: 8px; margin-top: 2px; }
        .toc-item.is-chapter:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.15); }
        .toc-item.is-chapter .title { font-size: 13px; color: rgba(255,255,255,0.9); font-weight: 600; }
        .toc-item.is-chapter .type-tag { color: #667eea; font-weight: 600; }
        /* Section = Level 2: deeper indent, subdued */
        .toc-item.is-section { margin-left: 48px; border: 1px solid rgba(255,255,255,0.04); border-left: 2px solid rgba(136,136,136,0.2); background: transparent; padding: 6px 12px; border-radius: 6px; margin-top: 1px; }
        .toc-item.is-section:hover { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); }
        .toc-item.is-section .title { font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 400; }
        .toc-item.is-section .type-tag { color: rgba(136,136,136,0.5); font-size: 7px; }
        .toc-item .movement-badges { display: flex; gap: 3px; flex-wrap: wrap; }
        .toc-item .movement-badge { font-size: 7px; padding: 1px 4px; border-radius: 2px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.4); font-family: var(--font-mono); }
        .toc-item.mismatch { border-color: var(--accent-danger); background: rgba(255,68,102,0.06); }
        /* Collapse chevron */
        .toc-chevron { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; cursor: pointer; color: rgba(255,255,255,0.35); font-size: 11px; transition: transform 0.3s ease, color 0.2s; flex-shrink: 0; border-radius: 4px; }
        .toc-chevron:hover { color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.06); }
        .toc-chevron.collapsed { transform: rotate(-90deg); }
        .toc-item.toc-collapsed-child { display: none; }
        .ghost { opacity: 0.3; }
        .drag-chosen { box-shadow: 0 4px 16px rgba(0,0,0,0.4); }

        .card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--sp-4); transition: all 0.25s; }
        .card:hover { border-color: var(--border-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sp-3); }
        .card-title { font-size: 13px; font-weight: 600; color: var(--text-primary); line-height: 1.3; }

        .research-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: var(--sp-4); transition: all 0.25s; }
        .research-card:hover { border-color: var(--border-active); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .research-card.used { opacity: 0.45; }

        .research-block { border-radius: var(--radius-sm); padding: var(--sp-2) var(--sp-3); margin-bottom: var(--sp-2); font-size: 11px; line-height: 1.6; }
        .research-block-label { font-family: var(--font-mono); font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--sp-1); opacity: 0.7; }
        .research-block-a { background: rgba(116,185,255,0.1); border-left: 3px solid #74b9ff; }
        .research-block-b { background: rgba(85,239,196,0.1); border-left: 3px solid #55efc4; }
        .research-block-c { background: rgba(255,234,167,0.1); border-left: 3px solid #ffeaa7; }
        .research-block-d { background: rgba(255,118,117,0.1); border-left: 3px solid #ff7675; }

        .exercise-item { background: var(--bg-deep); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: var(--sp-2) var(--sp-3); cursor: grab; transition: all 0.15s; font-size: 11px; line-height: 1.4; }
        .exercise-item:hover { border-color: var(--border-active); background: var(--bg-surface); }

        .mindmap-canvas { position: relative; flex:1; min-width:0; height: 100%; background: var(--bg-deep); overflow: hidden; cursor: crosshair; }
        .mm-viewport { position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform; }
        .mm-zoom-controls { display:flex;flex-direction:row;align-items:center;gap:2px;margin-left:4px;padding-left:6px;border-left:1px solid var(--border-subtle); }
        .mm-zoom-btn { width:30px;height:24px;background:transparent;border:none;color:var(--text-tertiary);font-size:13px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center; }
        .mm-zoom-btn:hover { background:rgba(255,255,255,0.05);color:var(--text-secondary); }
        .mm-zoom-pct { font-size:8px;color:var(--text-tertiary);font-family:var(--font-mono);cursor:pointer;user-select:none; }
        .mm-zoom-pct:hover { color:var(--text-secondary); }
        .mm-grid { position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0; }
        .mm-grid-toggle { width:28px;height:28px;background:transparent;border:none;color:var(--text-tertiary);font-size:10px;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);letter-spacing:-0.5px; }
        .mm-grid-toggle:hover { background:rgba(255,255,255,0.05);color:var(--text-secondary); }
        .mm-grid-toggle.active { color:var(--accent-gold);background:rgba(255,170,0,0.06); }
        .mindmap-node { position: absolute; padding: 8px 14px; background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); cursor: move; font-size: 12px; font-weight: 500; transition: box-shadow 0.15s, border-color 0.15s; user-select: none; min-width: 60px; max-width: 300px; text-align: center; overflow-wrap: break-word; word-break: break-word; }
        .mindmap-node:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-color: var(--border-hover); }
        .mindmap-node.mm-selected { border-color: var(--accent-gold) !important; box-shadow: 0 0 0 1px var(--accent-gold), 0 4px 16px rgba(255,170,0,0.15); }
        .mindmap-node .mm-del { position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--accent-danger);color:#fff;font-size:11px;line-height:18px;text-align:center;cursor:pointer;opacity:0;transition:opacity 0.15s;z-index:2; }
        .mindmap-node:hover .mm-del { opacity:1; }
        .mindmap-node .mm-rsz { position:absolute;bottom:-4px;right:-4px;width:10px;height:10px;background:var(--accent-gold);border-radius:2px;cursor:se-resize;opacity:0;transition:opacity 0.15s; }
        .mindmap-node.mm-selected .mm-rsz { opacity:0.7; }
        .mindmap-node.mm-selected .mm-rsz:hover { opacity:1; }
        .mm-ctx { position:fixed;z-index:9999;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:4px 0;min-width:160px;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:none; }
        .mm-ctx.open { display:block; }
        .mm-ctx-item { padding:6px 14px;font-size:11px;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background 0.1s; }
        .mm-ctx-item:hover { background:rgba(255,255,255,0.05);color:var(--text-primary); }
        .mm-ctx-sep { height:1px;background:var(--border-subtle);margin:4px 0; }
        .mm-inline-edit { background:transparent;border:none;color:inherit;font:inherit;text-align:center;outline:none;width:100%;min-width:40px; }
        .mm-tools { position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:100;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:12px;display:flex;flex-direction:row;align-items:center;padding:4px 6px;gap:2px;box-shadow:0 4px 24px rgba(0,0,0,0.4); }
        .mm-tool { width:36px;height:36px;border:none;background:transparent;color:var(--text-tertiary);font-size:15px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;position:relative; }
        .mm-tool:hover { background:rgba(255,255,255,0.05);color:var(--text-secondary); }
        .mm-tool.active { background:rgba(255,170,0,0.08);color:var(--accent-gold); }
        .mm-tool-sep { width:1px;height:24px;background:var(--border-subtle);margin:0 4px; }
        .mm-tool-sub { position:absolute;left:50%;top:calc(100% + 6px);transform:translateX(-50%);background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:8px;padding:4px;display:none;flex-direction:row;gap:2px;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:10;white-space:nowrap; }
        .mm-tool-sub.open { display:flex; }
        .mm-sub-btn { width:30px;height:30px;background:transparent;color:var(--text-tertiary);font-size:14px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none; }
        .mm-sub-btn:hover { background:rgba(255,255,255,0.08);color:var(--text-primary); }
        .mm-sub-btn.active { color:var(--accent-gold); }
        .mindmap-canvas[data-tool="select"] { cursor:default; }
        .mindmap-canvas[data-tool="hand"] { cursor:grab; }
        .mindmap-canvas[data-tool="shape"],.mindmap-canvas[data-tool="line"],.mindmap-canvas[data-tool="sticky"] { cursor:crosshair; }
        .mindmap-canvas[data-tool="text"] { cursor:text; }
        .mindmap-canvas[data-tool="select"] .mindmap-node { cursor:move; }
        .mindmap-canvas[data-tool="select"] .mindmap-node:active { cursor:move; }
        .mindmap-canvas[data-tool="hand"] .mindmap-node { cursor:grab; }
        .mm-sticky-node { border-radius:4px !important;padding:10px 14px !important; }
        .mm-text-node { border-color:transparent !important;background:transparent !important;padding:2px 4px !important;min-width:20px !important;max-width:none !important; }
        .mm-text-node:hover { box-shadow:none !important;border-color:transparent !important; }
        .mm-text-node.mm-selected { border-color:rgba(255,170,0,0.3) !important;box-shadow:none !important; }
        .mm-text-node .mm-del { top:-6px;right:-6px;width:14px;height:14px;font-size:9px;line-height:14px; }
        .mm-text-node .mm-rsz { display:none; }
        .mm-sel-rect { position:absolute;border:1px solid rgba(255,170,0,0.5);background:rgba(255,170,0,0.06);pointer-events:none;z-index:50;display:none; }
        .mindmap-node.mm-multi { border-color:var(--accent-gold) !important;box-shadow:0 0 0 1px var(--accent-gold), 0 2px 8px rgba(255,170,0,0.1);cursor:grab !important; }
        .mindmap-node.mm-multi:active { cursor:grabbing !important; }
        .mm-ntitle { font-weight:500;font-size:12px;line-height:1.3;overflow-wrap:break-word;word-break:break-word; }
        .mm-nbody { font-size:10px;line-height:1.6;color:var(--text-secondary);white-space:pre-wrap;word-break:break-word;margin-top:4px;border-top:1px solid rgba(255,255,255,0.06);padding-top:4px;text-align:left; }
        .mm-nbody:empty { display:none; }
        .mm-locked { cursor:default !important; opacity:0.85; }
        .mm-locked .mm-rsz { display:none; }
        .mm-lock { position:absolute;bottom:-4px;left:-4px;font-size:9px;opacity:0.4;pointer-events:none; }
        .mm-body-ta { width:100%;height:36px;background:transparent;border:none;color:var(--text-secondary);font-size:10px;line-height:1.6;font-family:var(--font-display);resize:none;outline:none;margin-top:4px;border-top:1px solid rgba(255,255,255,0.06);padding-top:4px;text-align:left;overflow-y:auto;box-sizing:border-box; }

        /* Gradient Notes Panel */
        .toc-notes-wrap { flex:1;overflow-y:auto;padding:var(--sp-5);display:none; }
        .toc-notes-wrap.active { display:block; }
        .toc-part-card { margin-bottom:var(--sp-5);border-radius:var(--radius-lg);overflow:hidden; }
        .toc-part-header { padding:var(--sp-4) var(--sp-5);font-size:13px;font-weight:700;color:var(--text-primary);letter-spacing:0.5px;text-transform:uppercase;position:relative; }
        .toc-ch-card { background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:var(--radius-md);margin:var(--sp-2) var(--sp-3);padding:var(--sp-3) var(--sp-4);transition:border-color 0.2s; }
        .toc-ch-card:hover { border-color:var(--border-hover); }
        .toc-ch-title { font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:var(--sp-1);cursor:pointer; }
        .toc-ch-sections { font-size:10px;color:var(--text-tertiary);line-height:1.8;padding-left:var(--sp-3);border-left:2px solid var(--border-subtle);margin:var(--sp-2) 0; }
        .toc-ch-note { width:100%;min-height:36px;max-height:160px;background:var(--bg-deep);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);color:var(--text-secondary);font-size:10px;line-height:1.6;padding:var(--sp-2) var(--sp-3);resize:vertical;outline:none;font-family:var(--font-display);transition:border-color 0.2s;margin-top:var(--sp-2); }
        .toc-ch-note:focus { border-color:var(--border-active);box-shadow:0 0 0 2px var(--accent-glow); }
        .toc-ch-note::placeholder { color:var(--text-tertiary); }
        .toc-view-toggle { display:flex;gap:0;border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--border-subtle); }
        .toc-view-btn { flex:1;padding:var(--sp-1) var(--sp-2);font-size:9px;font-family:var(--font-display);font-weight:500;color:var(--text-tertiary);background:transparent;border:none;cursor:pointer;text-align:center;transition:all 0.15s; }
        .toc-view-btn.active { background:var(--accent-glow);color:var(--accent-gold); }
        .toc-view-btn:hover:not(.active) { color:var(--text-secondary); }

        .collapsible-header { display: flex; align-items: center; justify-content: space-between; padding: var(--sp-3) var(--sp-4); cursor: pointer; border-radius: var(--radius-md); transition: background 0.2s; }
        .collapsible-header:hover { background: var(--bg-surface); }
        .collapsible-arrow { transition: transform 0.2s; font-size: 10px; color: var(--text-tertiary); }
        .collapsible-body { overflow: hidden; transition: max-height 0.3s ease; }
        .collapsed .collapsible-body { max-height: 0 !important; }
        .collapsed .collapsible-arrow { transform: rotate(-90deg); }

        .ql-toolbar { background: var(--bg-surface) !important; border-color: var(--border-subtle) !important; border-radius: var(--radius-md) var(--radius-md) 0 0; padding: var(--sp-2) var(--sp-3) !important; }
        .ql-container { border-color: var(--border-subtle) !important; background: var(--bg-deep) !important; color: var(--text-primary) !important; min-height: 300px; border-radius: 0 0 var(--radius-md) var(--radius-md); }
        .ql-editor { font-family: 'Georgia', serif; font-size: 15px; line-height: 1.9; padding: var(--sp-5); max-width: var(--prose-max); }
        .ql-editor p { margin-bottom: 0.8em; }
        .ql-snow .ql-stroke { stroke: var(--text-tertiary) !important; }
        .ql-snow .ql-fill { fill: var(--text-tertiary) !important; }
        .ql-snow .ql-picker { color: var(--text-tertiary) !important; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.12); }

        .grid { display: grid; gap: var(--sp-4); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-auto { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: var(--sp-2); }
        .gap-3 { gap: var(--sp-3); }
        .gap-4 { gap: var(--sp-4); }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .mt-3 { margin-top: var(--sp-3); }
        .mb-3 { margin-bottom: var(--sp-3); }
        .mb-4 { margin-bottom: var(--sp-4); }
        .space-y > * + * { margin-top: var(--sp-2); }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--sp-5); width: 360px; }

        /* Matrix layout */
        .matrix-layout { display: flex; width: 100%; height: 100%; position: relative; }
        .matrix-sidebar { width: 200px; border-right: 1px solid var(--border-subtle); padding: 14px; display: flex; flex-direction: column; gap: 10px; background: var(--bg-deep); overflow-y: auto; flex-shrink: 0; }
        .matrix-center { flex: 1; position: relative; overflow: hidden; }
        #cy-container { width: 100%; height: 100%; }
        .context-panel { width: 320px; position: absolute; right: 0; top: 0; bottom: 0; background: var(--bg-surface); border-left: 1px solid var(--border-subtle); transform: translateX(100%); transition: transform 300ms ease; overflow-y: auto; padding: 16px; z-index: 10; }
        .context-panel.open { transform: translateX(0); }
        .context-panel-close { position: absolute; top: 10px; right: 10px; cursor: pointer; background: none; border: none; color: var(--text-tertiary); font-size: 16px; }
        .context-panel-close:hover { color: var(--text-primary); }
        .node-detail-label { font-family: var(--font-mono); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 3px; margin-top: 10px; }
        .node-detail-value { font-size: 12px; color: var(--text-primary); margin-bottom: 6px; }
        .prereq-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; background: var(--bg-deep); border: 1px solid var(--border-subtle); font-size: 10px; color: var(--text-secondary); margin: 2px; }

        /* Matrix filter section */
        .matrix-filter-group { margin-bottom: 8px; }
        .matrix-filter-title { font-family: var(--font-mono); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); margin-bottom: 6px; }
        .matrix-filter-group label { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text-secondary); cursor: pointer; padding: 2px 0; }
        .matrix-filter-group input[type="checkbox"] { width: auto; accent-color: var(--accent-gold); }

        /* Taxonomy table */
        .taxonomy-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .taxonomy-table thead { position: sticky; top: 0; z-index: 2; }
        .taxonomy-table th { background: var(--bg-surface); border-bottom: 2px solid var(--border-subtle); padding: 10px 12px; text-align: left; font-family: var(--font-mono); font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-tertiary); }
        .taxonomy-table td { padding: 8px 12px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
        .taxonomy-table tr:hover td { background: var(--bg-surface); color: var(--text-primary); }
        .taxonomy-table .stage-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* Export cards */
        .export-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; transition: all 0.25s; }
        .export-card:hover { border-color: var(--border-active); transform: translateY(-2px); }
        .export-card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }
        .export-card-desc { font-size: 10px; color: var(--text-tertiary); margin-bottom: 12px; }

        /* Barcode */
        .qr-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; text-align: center; }
        .qr-card canvas { border-radius: var(--radius-md); margin-top: 10px; }
        .qr-label { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .qr-url { font-family: var(--font-mono); font-size: 9px; color: var(--text-tertiary); word-break: break-all; }

        /* Writing mode pills — minimal */
        .wm-bar { display:flex;gap:0; }
        .wm-sq { width:28px;height:28px;border:1px solid rgba(255,255,255,0.06);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;position:relative;padding:0; }
        .wm-sq:first-child { border-radius:4px 0 0 4px; }
        .wm-sq:last-child { border-radius:0 4px 4px 0; }
        .wm-sq + .wm-sq { border-left:none; }
        .wm-sq:hover { background:rgba(255,255,255,0.04); }
        .wm-sq.active { background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.15); }
        .wm-sq .wm-dot { width:6px;height:6px;border-radius:1px;opacity:0.3;transition:opacity 0.15s; }
        .wm-sq:hover .wm-dot { opacity:0.7; }
        .wm-sq.active .wm-dot { opacity:1; }
        /* Legacy pill removed — all modes use .wm-sq */
        input[type="range"] { -webkit-appearance:none; appearance:none; width:100%; height:4px; background:#27272a; border-radius:2px; outline:none; border:none; padding:0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent-gold); cursor:pointer; box-shadow: 0 0 6px rgba(255,170,0,0.3); }
        input[type="range"]::-moz-range-thumb { width:14px; height:14px; border-radius:50%; background:var(--accent-gold); cursor:pointer; border:none; box-shadow: 0 0 6px rgba(255,170,0,0.3); }

        /* Internal tab */
        .internal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .internal-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: var(--sp-5); }
        .internal-card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--sp-3); }
        .locked-item { font-size: 10px; color: var(--text-tertiary); line-height: 2; }
        .locked-status { color: var(--accent-success); font-weight: 600; }
        .locked-status-active { color: var(--accent-gold); font-weight: 600; }

        /* ── MOBILE RESPONSIVE ── */
        @media (max-width: 1024px) {
            .header { height: auto; min-height: 48px; flex-wrap: wrap; gap: var(--sp-2); padding: var(--sp-2) var(--sp-3); }
            .tabs { gap: 1px; }
            .tab { padding: 6px var(--sp-2); font-size: 9px; }
            .kernel { height: auto; min-height: 36px; padding: var(--sp-2) var(--sp-3); gap: var(--sp-4); flex-wrap: wrap; }
            .sidebar, .sidebar-wide { width: 180px; padding: var(--sp-3); }
            .content { padding: var(--sp-4); }
            .internal-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            body { overflow: auto; height: auto; }
            .header { flex-direction: column; align-items: flex-start; padding: var(--sp-3); }
            .tabs { width: 100%; overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; padding-bottom: var(--sp-1); }
            .tab { flex-shrink: 0; }
            .kernel { display: none; }
            .main { flex-direction: column; overflow: auto; }
            .section.active { flex-direction: column; height: auto; min-height: 80vh; }
            .sidebar, .sidebar-wide { width: 100%; max-height: 240px; border-right: none; border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
            .content { padding: var(--sp-4); }
            .content-split { flex-direction: column; }
            .content-half + .content-half { border-left: none; border-top: 1px solid var(--border-subtle); }
            .voice-modes { flex-wrap: wrap; gap: var(--sp-1) !important; }
            .wm-sq { width:24px; height:24px; }
            .internal-grid { grid-template-columns: 1fr; }
            .matrix-layout { flex-direction: column; }
            .matrix-sidebar { width: 100%; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border-subtle); }
            .matrix-center { min-height: 400px; }
            .modal { width: 92vw !important; max-width: 92vw; padding: var(--sp-4); }
            #gallery-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important; }
        }
        @media (max-width: 480px) {
            .logo-title { font-size: 12px; }
            .tab { font-size: 8px; padding: 5px 6px; }
            .sidebar, .sidebar-wide { max-height: 180px; }
            .wm-sq { width:20px; height:20px; }
            #gallery-grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><circle cx="12" cy="12" r="5.5"/><ellipse cx="12" cy="12" rx="11" ry="3.5"/></svg>
            </div>
            <div>
                <div class="logo-title">THE ART OF CALISTHENICS</div>
                <div class="logo-sub">Victory Belt Publishing | Gabo Saturno</div>
            </div>
        </div>
        <nav class="tabs">
            <button class="tab active" data-tab="toc">TOC</button>
            <button class="tab" data-tab="writing">Writing</button>
            <button class="tab" data-tab="decisions">Decisions</button>
            <button class="tab" data-tab="research">Research</button>
            <button class="tab" data-tab="htmls">HTMLs</button>
            <button class="tab" data-tab="matrix">Matrix</button>
            <button class="tab" data-tab="taxonomy">Taxonomy</button>
            <button class="tab" data-tab="workout">Workout</button>
            <button class="tab" data-tab="mindmap">Mind Map</button>
            <button class="tab" data-tab="barcode">Barcode</button>
            <button class="tab" data-tab="vault">Vault</button>
            <button class="tab" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="calendar">Calendar</button>
            <button class="tab" data-tab="export">Export</button>
            <button class="tab" data-tab="internal">Internal</button>
        </nav>
        <div class="flex items-center gap-2">
            <span class="badge">V3</span>
            <button class="btn-icon btn" onclick="resetToLastSaved()" title="Reset to Last Saved">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 105.64-11.36L1 10"/></svg>
            </button>
            <button class="btn-icon btn" onclick="exportAllState()" title="Export State">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
            </button>
            <button class="btn-icon btn" onclick="openInternal()" title="Internal Section" style="font-family:var(--font-mono);font-size:11px;font-weight:700;color:var(--accent-gold);">S</button>
        </div>
    </header>

    <!-- KERNEL BAR -->
    <div class="kernel glaze">
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-success)"></div><span class="kernel-label">Book</span><span class="kernel-value">The Art of Calisthenics</span></div>
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-gold)"></div><span class="kernel-label">Chapters</span><span class="kernel-value" id="k-chapters">27</span></div>
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-blue)"></div><span class="kernel-label">Parts</span><span class="kernel-value" id="k-parts">7</span></div>
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-success)"></div><span class="kernel-label">Status</span><span class="kernel-value" style="color:var(--accent-success)">Active</span></div>
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-purple)"></div><span class="kernel-label">Decisions</span><span class="kernel-value" id="k-decisions">0</span></div>
        <div class="kernel-item"><div class="kernel-dot" style="background:var(--accent-warning)"></div><span class="kernel-label">Nodes</span><span class="kernel-value" id="k-nodes">95</span></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">

        <!-- === TOC TAB === -->
        <section id="sec-toc" class="section active">
            <div class="sidebar">
                <div class="sidebar-label">TOC Versions</div>
                <select id="toc-v-left" onchange="loadTOC('left')">
                    <option value="v1">v1 - Canonical (27 Ch)</option>
                    <option value="v2">v2 - Parts + Chapters</option>
                    <option value="v3">v3 - Working Draft</option>
                </select>
                <select id="toc-v-right" onchange="loadTOC('right')">
                    <option value="v1" selected>v1 - Canonical (27 Ch)</option>
                    <option value="v2">v2 - Parts + Chapters</option>
                    <option value="v3">v3 - Working Draft</option>
                </select>
                <div style="border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:4px"></div>
                <button class="btn w-full" onclick="addTOCVersion()">+ New Version</button>
                <div class="toc-view-toggle">
                    <button class="toc-view-btn active" onclick="setTocView('compare')">Compare</button>
                    <button class="toc-view-btn" onclick="setTocView('notes')">Notes</button>
                </div>
                <button class="btn w-full" onclick="compareTOCs()">Compare</button>
                <button class="btn w-full" onclick="exportTOC()">Export JSON</button>
                <button class="btn w-full" onclick="exportTOCMarkdown()">Export MD</button>
                <button class="btn w-full" onclick="exportTOCWord()">Export Word</button>
                <button class="btn w-full" onclick="exportTOCPDF()">Export PDF</button>
                <button class="btn btn-primary w-full" onclick="loadExternalTOC()">Load toc.json</button>
                <div style="border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:8px">
                    <div class="sidebar-label">Cloud Links</div>
                    <a class="btn w-full" href="https://www.dropbox.com/home" target="_blank" rel="noopener" style="text-decoration:none;justify-content:center;margin-bottom:4px">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 8l10 6 10-6L12 2z"/><path d="M2 16l10 6 10-6"/><path d="M2 12l10 6 10-6"/></svg>
                        Dropbox
                    </a>
                    <a class="btn w-full" href="https://onedrive.live.com/" target="_blank" rel="noopener" style="text-decoration:none;justify-content:center">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
                        OneDrive
                    </a>
                    <a class="btn w-full" href="https://gabosaturno11.github.io/interactive-toc-editor/" target="_blank" rel="noopener" style="text-decoration:none;justify-content:center;margin-top:4px">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h16M4 18h12"/></svg>
                        Dynamic TOC Editor
                    </a>
                </div>
                <div style="border-top:1px solid var(--border-subtle);padding-top:8px;margin-top:8px">
                    <div class="sidebar-label">TOC Analytics</div>
                    <div id="toc-analytics" style="font-size:10px;color:var(--text-tertiary);line-height:2"></div>
                </div>
                <div style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border-subtle)">
                    <div style="font-size:9px;color:var(--text-tertiary);line-height:1.5">Drag items to reorder.<br>Red = mismatch between versions.</div>
                </div>
            </div>
            <div class="content-split" id="toc-compare-view">
                <div class="content-half">
                    <div class="flex items-center justify-between mb-3">
                        <span class="sidebar-label" style="margin:0" id="toc-left-label">TOC v1</span>
                        <button class="btn btn-sm" onclick="addChapter('left')">+ Chapter</button>
                    </div>
                    <div id="toc-left" class="space-y"></div>
                </div>
                <div class="content-half">
                    <div class="flex items-center justify-between mb-3">
                        <span class="sidebar-label" style="margin:0" id="toc-right-label">TOC v2</span>
                        <button class="btn btn-sm" onclick="addChapter('right')">+ Chapter</button>
                    </div>
                    <div id="toc-right" class="space-y"></div>
                </div>
            </div>
            <div class="toc-notes-wrap" id="toc-notes-view"></div>
        </section>

        <!-- === WRITING TAB === -->
        <section id="sec-writing" class="section">
            <div class="sidebar sidebar-wide">
                <div class="sidebar-label">Document Structure</div>
                <div id="writing-toc" class="space-y"></div>
                <div style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border-subtle)">
                    <div class="sidebar-label">Export As</div>
                    <div class="grid grid-2 gap-2" style="margin-top:6px">
                        <button class="btn" onclick="exportAs('md')">MD</button>
                        <button class="btn" onclick="exportAs('txt')">TXT</button>
                        <button class="btn" onclick="exportAs('html')">HTML</button>
                        <button class="btn" onclick="exportAs('yaml')">YAML</button>
                        <button class="btn" onclick="exportAs('word')">Word</button>
                        <button class="btn" onclick="exportAs('pdf')">PDF</button>
                    </div>
                </div>
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-subtle)">
                    <div class="sidebar-label">Save to Vault</div>
                    <button class="btn w-full" onclick="saveToVault()" style="margin-top:6px">Save to Vault</button>
                </div>
            </div>
            <div class="content flex-col" style="display:flex;flex:1">
                <div class="flex items-center justify-between mb-3">
                    <input type="text" id="doc-title" value="Chapter 1: What, How, Why & Who" style="background:transparent;border:none;font-size:16px;font-weight:600;color:var(--text-primary);width:50%;padding:0">
                    <div class="flex items-center gap-2">
                        <div id="wc-display" style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);cursor:pointer" onclick="setWordTarget()" title="Click to set target">0 words</div>
                        <div class="btn-group">
                            <button class="btn" id="preview-toggle" onclick="togglePreview()">Preview</button>
                            <button class="btn" onclick="saveDocument()">Save</button>
                            <button class="btn btn-primary" onclick="exportAs('md')">Export</button>
                        </div>
                    </div>
                </div>
                <!-- M3: Word count progress bar -->
                <div id="wc-progress-wrap" style="display:none;margin-bottom:6px">
                    <div style="height:3px;background:var(--bg-deep);border-radius:2px;overflow:hidden">
                        <div id="wc-bar" style="height:100%;width:0%;background:var(--accent-gold);transition:width 0.3s"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:2px">
                        <span id="wc-target-label" style="font-size:8px;color:var(--text-tertiary);font-family:var(--font-mono)"></span>
                        <span id="wc-autosave" style="font-size:8px;color:var(--accent-success);font-family:var(--font-mono)"></span>
                    </div>
                </div>
                <!-- U1: Voice mode selector (simplified) -->
                <div class="voice-modes" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <div class="wm-bar">
                        <button class="wm-sq active" data-mode="raw" onclick="setWritingMode('raw')" title="Raw — Unfiltered, stream of consciousness"><span class="wm-dot" style="background:#ef4444"></span></button>
                        <button class="wm-sq" data-mode="teacher" onclick="setWritingMode('teacher')" title="Teacher — Clear, structured, patient"><span class="wm-dot" style="background:#22c55e"></span></button>
                        <button class="wm-sq" data-mode="philosopher" onclick="setWritingMode('philosopher')" title="Philosopher — Deep, reflective, questioning"><span class="wm-dot" style="background:#3b82f6"></span></button>
                        <button class="wm-sq" data-mode="prophet" onclick="setWritingMode('prophet')" title="Prophet — Bold, visionary, declarative"><span class="wm-dot" style="background:#eab308"></span></button>
                        <button class="wm-sq" data-mode="mystic" onclick="setWritingMode('mystic')" title="Mystic — Poetic, metaphorical, layered"><span class="wm-dot" style="background:#a855f7"></span></button>
                        <button class="wm-sq" data-mode="companion" onclick="setWritingMode('companion')" title="Companion — Warm, conversational, supportive"><span class="wm-dot" style="background:#f97316"></span></button>
                        <button class="wm-sq" data-mode="confessor" onclick="setWritingMode('confessor')" title="Confessor — Honest, vulnerable, authentic"><span class="wm-dot" style="background:#6b7280"></span></button>
                        <button class="wm-sq" data-mode="rebel" onclick="setWritingMode('rebel')" title="Rebel — Provocative, challenging, sharp"><span class="wm-dot" style="background:#e5e7eb"></span></button>
                    </div>
                    <span id="wm-status" style="font-size:9px;color:var(--text-tertiary);margin-left:auto;font-style:italic"></span>
                </div>
                <div style="flex:1;display:flex;gap:0;overflow:hidden">
                    <div id="editor-wrap" style="flex:1"><div id="editor"></div></div>
                    <div id="preview-panel" style="display:none;flex:1;overflow-y:auto;padding:20px 24px;border-left:1px solid var(--border-subtle);background:var(--bg-deep);font-family:Georgia,serif;font-size:14px;line-height:1.8;color:var(--text-secondary)"></div>
                </div>
                <!-- U2: Refinement + Commands toolbar -->
                <div style="display:flex;align-items:center;gap:0;border-top:1px solid var(--border-subtle);margin-top:4px">
                    <div style="display:flex;align-items:center;gap:6px;padding:8px 0 4px;flex:1">
                        <span style="font-size:9px;color:var(--text-tertiary);font-family:var(--font-mono);margin-right:4px">CMD</span>
                        <button class="btn btn-sm" onclick="writingCommand('compress')" title="Remove 30% wordcount, preserve meaning">Compress</button>
                        <button class="btn btn-sm" onclick="writingCommand('expand')" title="Add 50% detail and examples">Expand</button>
                        <button class="btn btn-sm" onclick="writingCommand('simplify')" title="8th grade reading level">Simplify</button>
                        <button class="btn btn-sm" onclick="writingCommand('deepen')" title="Add philosophical depth">Deepen</button>
                        <button class="btn btn-sm" onclick="writingCommand('polish')" title="Professional publishing voice">Polish</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;padding:4px 0 4px 16px;border-left:1px solid var(--border-subtle)">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:8px;color:var(--text-tertiary);font-family:var(--font-mono);text-transform:uppercase">Compression</span>
                            <input type="range" id="refine-compression" min="0" max="100" value="50" style="width:80px" oninput="document.getElementById('compression-val').textContent=this.value+'%';S._compression=parseInt(this.value);save()">
                            <span id="compression-val" style="font-size:9px;color:var(--text-secondary);font-family:var(--font-mono);min-width:28px">50%</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-size:8px;color:var(--text-tertiary);font-family:var(--font-mono);text-transform:uppercase">Technical</span>
                            <input type="range" id="refine-technical" min="0" max="100" value="50" style="width:80px" oninput="document.getElementById('technical-val').textContent=this.value+'%';S._technical=parseInt(this.value);save()">
                            <span id="technical-val" style="font-size:9px;color:var(--text-secondary);font-family:var(--font-mono);min-width:28px">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === DECISIONS TAB === -->
        <section id="sec-decisions" class="section" style="flex-direction:column">
            <div class="content" style="flex:1">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Decision Log & internal notes</div>
                        <div style="font-size:11px;color:var(--text-tertiary)">Track every decision and blocker</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addTask()">+ Task</button>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header"><span class="card-title flex items-center gap-2"><span class="kernel-dot" style="background:var(--accent-success)"></span> Decisions Made</span></div>
                        <div id="Task-list" class="space-y"></div>
                    </div>
                    <div class="card" style="display:flex;flex-direction:column">
                        <div class="card-header"><span class="card-title flex items-center gap-2"><span class="kernel-dot" style="background:var(--accent-warning)"></span> Notes</span></div>
                        <div style="display:flex;gap:0;flex:1;min-height:200px">
                            <div style="flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border-subtle)">
                                <textarea id="bn-scratchpad" placeholder="Write a note..." style="flex:1;background:transparent;border:none;color:var(--text-primary);font-size:11px;line-height:1.6;padding:10px;resize:none;outline:none;font-family:var(--font-display)"></textarea>
                                <div style="padding:4px 10px;border-top:1px solid var(--border-subtle)">
                                    <button class="btn btn-sm" onclick="saveNote()" style="font-size:9px;width:100%">Save Note</button>
                                </div>
                            </div>
                            <div id="bottlenecks-list" class="space-y" style="flex:1;overflow-y:auto;padding:8px;max-height:320px"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === RESEARCH TAB === -->
        <section id="sec-research" class="section" style="flex-direction:column">
            <div class="content" style="flex:1">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Research Frameworks</div>
                        <div style="font-size:11px;color:var(--text-tertiary)">Evidence-based claims with A/B/C/D blocks</div>
                    </div>
                    <div class="flex gap-2">
                        <select id="research-filter" onchange="renderResearch(this.value)" style="width:160px">
                            <option value="all">All Categories</option>
                        </select>
                        <select id="research-usage-filter" onchange="renderResearch(document.getElementById('research-filter').value)" style="width:100px">
                            <option value="all">All</option>
                            <option value="used">Used</option>
                            <option value="unused">Unused</option>
                        </select>
                        <button class="btn" onclick="loadExternalResearch()">Load JSON</button>
                        <button class="btn" onclick="addResearchCard()">+ Add</button>
                    </div>
                </div>
                <div id="research-grid" class="grid grid-auto"></div>
            </div>
        </section>

        <!-- === HTMLS TAB === -->
        <section id="sec-htmls" class="section">
            <div class="sidebar sidebar-wide">
                <div class="sidebar-label">Visual Gallery</div>
                <div style="border:2px dashed #27272a;border-radius:8px;padding:16px;text-align:center;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('html-file-upload').click()" id="html-drop-zone">
                    <input type="file" id="html-file-upload" accept=".html,.htm,.png,.jpg,.jpeg,.gif,.svg,.webp" multiple style="display:none" onchange="handleHTMLUpload(event)">
                    <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);text-transform:uppercase;margin-bottom:4px">Upload Files</div>
                    <div style="font-size:9px;color:var(--text-tertiary)">HTML or images · drag &amp; drop</div>
                </div>
                <input type="text" id="html-search" placeholder="Search gallery..." oninput="filterHTMLs()" style="margin-bottom:8px">
                <select id="html-tag-filter" onchange="filterHTMLs()" style="margin-bottom:8px;font-size:10px">
                    <option value="all">All Tags</option>
                </select>
                <select id="html-type-filter" onchange="filterHTMLs()" style="margin-bottom:8px;font-size:10px">
                    <option value="all">All Types</option>
                    <option value="HTML">HTML</option>
                    <option value="PNG">PNG / Image</option>
                </select>
                <div id="html-tag-counts" style="font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary);margin-bottom:6px"></div>
                <div id="html-list" class="space-y" style="overflow-y:auto;flex:1"></div>
                <button class="btn w-full" style="margin-top:8px" onclick="addHTML()">+ Add URL</button>
            </div>
            <div class="content" style="flex:1;overflow-y:auto;padding:16px" id="gallery-content">
                <div id="gallery-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px"></div>
            </div>
        </section>

        <!-- === MATRIX TAB === -->
        <section id="sec-matrix" class="section">
            <div class="matrix-layout">
                <div class="matrix-sidebar">
                    <div class="sidebar-label">Matrix Filters</div>
                    <div class="matrix-filter-group">
                        <div class="matrix-filter-title">Stage <span style="font-size:8px;opacity:0.5">(dbl-click to rename)</span></div>
                        <label><input type="checkbox" class="matrix-filter" data-type="stage" data-val="0" checked> <span ondblclick="editStageName(0)">Stage 0</span></label>
                        <label><input type="checkbox" class="matrix-filter" data-type="stage" data-val="1" checked> <span ondblclick="editStageName(1)">Stage 1</span></label>
                        <label><input type="checkbox" class="matrix-filter" data-type="stage" data-val="2" checked> <span ondblclick="editStageName(2)">Stage 2</span></label>
                        <label><input type="checkbox" class="matrix-filter" data-type="stage" data-val="3" checked> <span ondblclick="editStageName(3)">Stage 3</span></label>
                    </div>
                    <div class="matrix-filter-group" id="matrix-pattern-filters">
                        <div class="matrix-filter-title">Pattern</div>
                    </div>
                    <div class="matrix-filter-group" id="matrix-discipline-filters">
                        <div class="matrix-filter-title">Discipline</div>
                    </div>
                    <div class="matrix-filter-group" id="matrix-type-filters">
                        <div class="matrix-filter-title">Node Type</div>
                    </div>
                    <div class="matrix-filter-group">
                        <div class="matrix-filter-title">Nodes</div>
                        <input type="text" id="matrix-node-search" placeholder="Search nodes..." oninput="filterMatrixNodeList()" onkeyup="filterMatrixNodeList(event)" style="margin-bottom:6px;padding:5px 8px;font-size:10px">
                        <div id="matrix-node-list" style="max-height:200px;overflow-y:auto"></div>
                    </div>
                    <div style="margin-top:auto;padding-top:8px;border-top:1px solid var(--border-subtle)">
                        <div id="matrix-filter-count" style="font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary);text-align:center;margin-bottom:6px"></div>
                        <button class="btn w-full btn-primary" onclick="openQueryEngine()">Query Engine</button>
                        <button class="btn w-full mt-3" onclick="resetMatrixFilters()">Reset Filters</button>
                        <button class="btn w-full mt-3" onclick="refitMatrix()">Re-fit Graph</button>
                        <button class="btn w-full mt-3" onclick="parseAllCSVs()">Rebuild from CSV</button>
                    </div>
                </div>
                <div class="matrix-center">
                    <div id="cy-container"></div>
                    <div class="context-panel" id="node-detail-panel">
                        <button class="context-panel-close" onclick="closeNodePanel()">&times;</button>
                        <div id="node-detail-content"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === TAXONOMY TAB === -->
        <section id="sec-taxonomy" class="section" style="flex-direction:column;position:relative">
            <div style="padding:12px 16px;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;gap:10px;flex-shrink:0;background:var(--bg-deep)">
                <input type="text" id="tax-search" placeholder="Search movements..." oninput="renderTaxonomy()" style="width:240px">
                <select id="tax-pattern" onchange="renderTaxonomy()" style="width:160px">
                    <option value="all">All Patterns</option>
                </select>
                <select id="tax-stage" onchange="renderTaxonomy()" style="width:220px">
                    <option value="all">All Stages</option>
                    <option value="0">Stage 0 — Mobility & Preparation</option>
                    <option value="1">Stage 1 — Creating the Base</option>
                    <option value="2">Stage 2 — Building the Structure</option>
                    <option value="3">Stage 3 — Continuous Mastering</option>
                </select>
                <select id="tax-type" onchange="renderTaxonomy()" style="width:130px">
                    <option value="all">All Types</option>
                </select>
                <select id="tax-discipline" onchange="renderTaxonomy()" style="width:160px">
                    <option value="all">All Disciplines</option>
                </select>
                <span id="tax-count" style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary);margin-left:auto"></span>
            </div>
            <div style="flex:1;padding:0;position:relative;overflow:hidden">
                <div style="width:100%;height:100%;overflow-y:auto">
                    <table class="taxonomy-table">
                        <thead><tr>
                            <th style="cursor:pointer" onclick="sortTaxonomy('id')">ID</th>
                            <th style="cursor:pointer" onclick="sortTaxonomy('name')">Name</th>
                            <th style="cursor:pointer" onclick="sortTaxonomy('type')">Type</th>
                            <th style="cursor:pointer" onclick="sortTaxonomy('pattern')">Pattern</th>
                            <th style="cursor:pointer" onclick="sortTaxonomy('stage')">Stage</th>
                            <th style="cursor:pointer" onclick="sortTaxonomy('discipline')">Discipline</th>
                            <th>Function</th>
                        </tr></thead>
                        <tbody id="tax-tbody"></tbody>
                    </table>
                </div>
                <div class="context-panel" id="tax-inspector">
                    <button class="context-panel-close" onclick="closeTaxInspector()">&times;</button>
                    <div id="tax-inspector-content"></div>
                </div>
            </div>
        </section>

        <!-- === WORKOUT TAB === -->
        <section id="sec-workout" class="section">
            <div class="sidebar sidebar-wide">
                <div class="sidebar-label">Exercise Library <span style="font-size:8px;opacity:0.5" id="ex-count"></span></div>
                <input type="text" id="ex-search" placeholder="Search exercises..." oninput="filterExercises()" style="margin-bottom:6px">
                <select id="ex-pattern-filter" onchange="filterExercises()" style="margin-bottom:4px">
                    <option value="all">All Patterns</option>
                    <option value="Horizontal Push">Horizontal Push</option>
                    <option value="Horizontal Pull">Horizontal Pull</option>
                    <option value="Downward Press">Downward Press</option>
                    <option value="Vertical Pull">Vertical Pull</option>
                    <option value="Overhead Press">Overhead Press</option>
                    <option value="Knee-Dominant">Knee-Dominant</option>
                    <option value="Hip-Dominant">Hip-Dominant</option>
                    <option value="Core">Core</option>
                    <option value="Mobility">Mobility</option>
                    <option value="Scapular Control">Scapular Control</option>
                </select>
                <select id="ex-stage-filter" onchange="filterExercises()" style="margin-bottom:8px">
                    <option value="all">All Stages</option>
                </select>
                <div id="ex-library" class="space-y" style="overflow-y:auto;flex:1"></div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border-subtle)">
                    <button class="btn btn-sm w-full" onclick="syncExercisesFromTaxonomy()">Sync from Taxonomy</button>
                </div>
            </div>
            <div class="content flex-col" style="display:flex">
                <div class="flex items-center justify-between mb-3">
                    <input type="text" id="workout-name" value="New Workout" style="background:transparent;border:none;font-size:16px;font-weight:600;color:var(--text-primary);width:250px;padding:0">
                    <div class="flex items-center gap-2">
                        <select id="saved-workouts-select" onchange="loadSavedWorkout()" style="width:150px;font-size:10px">
                            <option value="">— Saved Workouts —</option>
                        </select>
                        <select id="wo-template-select" onchange="if(this.value!=='')loadWorkoutTemplate(this.value);this.value='';" style="width:140px;font-size:10px">
                            <option value="">— Templates —</option>
                            <option value="0">Full Body Foundation</option>
                            <option value="1">Push Day</option>
                            <option value="2">Pull Day</option>
                            <option value="3">Leg Day</option>
                            <option value="4">Mobility Flow</option>
                            <option value="5">Core Circuit</option>
                        </select>
                        <div class="btn-group">
                            <button class="btn" onclick="exportWorkoutTxt()">TXT</button>
                            <button class="btn" onclick="exportWorkout()">CSV</button>
                            <button class="btn" onclick="exportWorkoutPDF()">PDF</button>
                            <button class="btn btn-primary" onclick="saveWorkout()">Save</button>
                        </div>
                    </div>
                </div>
                <div id="workout-builder" style="flex:1;border:1px dashed var(--border-subtle);border-radius:var(--radius-md);padding:12px;min-height:200px;overflow-y:auto" class="space-y">
                    <div style="color:var(--text-tertiary);font-size:12px;text-align:center;padding:40px">Drag exercises here or select a template</div>
                </div>
                <!-- O3: Workout analytics bar -->
                <div id="wo-analytics" style="padding:8px 0;border-top:1px solid var(--border-subtle);margin-top:4px;display:flex;align-items:center;gap:16px;font-size:10px;color:var(--text-tertiary)">
                    <span>Click Save or add exercises to see analytics</span>
                </div>
            </div>
        </section>

        <!-- === MINDMAP TAB === -->
        <section id="sec-mindmap" class="section" style="flex-direction:column">
            <div style="padding:5px 16px;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
                <span style="font-size:9px;color:var(--text-tertiary);font-family:var(--font-mono)" id="mm-hint">Click to select &middot; Drag to move &middot; Dbl-click to write</span>
                <div class="flex items-center gap-2">
                    <select id="mm-saved" onchange="loadNamedMindmap()" style="width:130px;font-size:10px">
                        <option value="">— Current —</option>
                    </select>
                    <div class="btn-group">
                        <button class="btn" onclick="saveNamedMindmap()">Save As</button>
                        <button class="btn" onclick="exportMindmap('json')">JSON</button>
                        <button class="btn" onclick="exportMindmapPNG()">PNG</button>
                        <button class="btn" onclick="exportMindmapSVG()">SVG</button>
                        <button class="btn" onclick="clearMindmap()">Clear</button>
                    </div>
                </div>
            </div>
            <div style="flex:1;overflow:hidden;position:relative">
                <div class="mindmap-canvas" id="mm-canvas" data-tool="select" oncontextmenu="mmContextMenu(event)" ondblclick="mmCanvasDblClick(event)" onclick="mmCanvasClick(event)" onmousedown="mmCanvasDown(event)">
                    <div class="mm-tools" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" ondblclick="event.stopPropagation()" oncontextmenu="event.stopPropagation()" onwheel="event.stopPropagation()">
                        <div class="mm-tool active" data-tool="select" onclick="setMmTool('select')" title="Select (V)"><span style="font-size:16px">&#8598;</span></div>
                        <div class="mm-tool" data-tool="hand" onclick="setMmTool('hand')" title="Hand (H)"><span style="font-size:14px">&#9995;</span></div>
                        <div class="mm-tool-sep"></div>
                        <div class="mm-tool" data-tool="shape" onclick="setMmTool('shape')" title="Shape (R)">
                            <span style="font-size:16px">&#9645;</span>
                            <div class="mm-tool-sub" id="mm-sub-shape">
                                <div class="mm-sub-btn active" onclick="event.stopPropagation();mmSetSub('shape','rectangle',this)" title="Rectangle">&#9645;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('shape','circle',this)" title="Circle">&#9679;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('shape','diamond',this)" title="Diamond">&#9670;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('shape','pill',this)" title="Pill">&#9644;</div>
                            </div>
                        </div>
                        <div class="mm-tool" data-tool="line" onclick="setMmTool('line')" title="Connect (L)">
                            <span style="font-size:18px;transform:rotate(-45deg);display:inline-block">&#8594;</span>
                            <div class="mm-tool-sub" id="mm-sub-line">
                                <div class="mm-sub-btn active" onclick="event.stopPropagation();mmSetArr('triangle',this)" title="Triangle" style="font-size:11px">▶</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetArr('open',this)" title="Open" style="font-size:13px">›</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetArr('diamond',this)" title="Diamond" style="font-size:11px">◆</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetArr('circle',this)" title="Dot" style="font-size:10px">●</div>
                            </div>
                        </div>
                        <div class="mm-tool" data-tool="text" onclick="setMmTool('text')" title="Text (T)"><span style="font-weight:700;font-size:14px;font-family:serif">T</span></div>
                        <div class="mm-tool" data-tool="sticky" onclick="setMmTool('sticky')" title="Sticky Note (N)">
                            <span style="font-size:16px;color:#ffaa00">&#9632;</span>
                            <div class="mm-tool-sub" id="mm-sub-sticky">
                                <div class="mm-sub-btn active" onclick="event.stopPropagation();mmSetSub('sticky','#ffaa00',this)" style="color:#ffaa00" title="Gold">&#9632;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('sticky','#55efc4',this)" style="color:#55efc4" title="Green">&#9632;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('sticky','#74b9ff',this)" style="color:#74b9ff" title="Blue">&#9632;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('sticky','#ff7675',this)" style="color:#ff7675" title="Red">&#9632;</div>
                                <div class="mm-sub-btn" onclick="event.stopPropagation();mmSetSub('sticky','#a29bfe',this)" style="color:#a29bfe" title="Purple">&#9632;</div>
                            </div>
                        </div>
                        <div class="mm-zoom-controls">
                            <div class="mm-zoom-btn" onclick="mmZoomIn()" title="Zoom In (+ or &#8984;+)">+</div>
                            <div class="mm-zoom-pct" id="mm-zoom-pct" onclick="mmResetZoom()" title="Reset Zoom (0)">100%</div>
                            <div class="mm-zoom-btn" onclick="mmZoomOut()" title="Zoom Out (&minus; or &#8984;&minus;)">&minus;</div>
                            <div class="mm-zoom-btn" onclick="mmFitView()" title="Fit to View" style="font-size:10px">&#8862;</div>
                            <div class="mm-zoom-btn" onclick="mmCenterView()" title="Center View (C)" style="font-size:12px">&#8982;</div>
                            <div class="mm-tool-sep" style="width:1px;height:20px;margin:0 2px"></div>
                            <div class="mm-grid-toggle" id="mm-grid-btn" onclick="mmToggleGrid()" title="Toggle Grid (G)">&#9638;</div>
                            <div class="mm-grid-toggle" id="mm-snap-btn" onclick="mmToggleSnap()" title="Toggle Snap (S)" style="font-size:9px">&#8689;</div>
                        </div>
                    </div>
                    <canvas id="mm-grid" class="mm-grid"></canvas>
                    <div id="mm-sel-rect" class="mm-sel-rect"></div>
                    <div id="mm-viewport" class="mm-viewport">
                        <svg id="mm-svg" style="position:absolute;top:0;left:0;width:10000px;height:10000px;pointer-events:none;overflow:visible"></svg>
                        <div id="mm-nodes"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === BARCODE TAB === -->
        <section id="sec-barcode" class="section" style="flex-direction:column">
            <div class="content" style="flex:1">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">QR Code Generator</div>
                        <div style="font-size:11px;color:var(--text-tertiary)">Generate QR codes for project URLs</div>
                    </div>
                </div>
                <div style="margin-bottom:20px">
                    <div class="sidebar-label" style="margin-bottom:8px">Custom URL</div>
                    <div class="flex gap-2">
                        <input type="text" id="qr-custom-url" placeholder="https://example.com" style="flex:1">
                        <button class="btn btn-primary" onclick="generateCustomQR()">Generate</button>
                    </div>
                    <div id="qr-custom-output" style="margin-top:12px;text-align:center"></div>
                </div>
                <div class="sidebar-label" style="margin-bottom:10px">Preset QR Codes</div>
                <div class="grid grid-3" id="qr-presets"></div>
            </div>
        </section>

        <!-- === KNOWLEDGE VAULT TAB === -->
        <section id="sec-vault" class="section">
            <div class="sidebar" style="width:220px;min-width:220px">
                <div class="sidebar-label">Folders</div>
                <div id="vault-folders" style="margin-bottom:12px"></div>
                <button class="btn btn-sm w-full" onclick="addVaultFolder()" style="margin-bottom:12px;font-size:9px">+ New Folder</button>
                <div style="border-top:1px solid var(--border-subtle);padding-top:8px">
                    <div class="sidebar-label">Quick Upload</div>
                    <div id="vault-dropzone" ondragover="event.preventDefault();this.style.borderColor='var(--accent-gold)'" ondragleave="this.style.borderColor='var(--border-subtle)'" ondrop="handleVaultDrop(event)" style="border:1px dashed var(--border-subtle);border-radius:4px;padding:8px;text-align:center;cursor:pointer;transition:all 0.2s" onclick="document.getElementById('vault-file-input').click()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto;display:block;opacity:0.4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <div style="font-size:8px;color:var(--text-tertiary);margin-top:2px">Drop .md .txt</div>
                        <input type="file" id="vault-file-input" accept=".md,.txt" multiple style="display:none" onchange="handleVaultFiles(this.files)">
                    </div>
                </div>
                <div style="margin-top:auto;padding-top:8px;border-top:1px solid var(--border-subtle)">
                    <div style="font-size:9px;color:var(--text-tertiary)" id="vault-stats">0 docs</div>
                </div>
            </div>
            <div style="width:240px;min-width:240px;border-right:1px solid var(--border-subtle);display:flex;flex-direction:column;background:var(--bg-surface)">
                <div style="padding:8px;border-bottom:1px solid var(--border-subtle)">
                    <input type="text" id="vault-search" placeholder="Search..." oninput="filterVault()" style="width:100%;font-size:10px;padding:6px 8px">
                </div>
                <div id="vault-list" style="overflow-y:auto;flex:1;padding:4px"></div>
                <div style="padding:6px;border-top:1px solid var(--border-subtle)">
                    <button class="btn btn-sm w-full" onclick="addVaultDoc()" style="font-size:9px">+ Add Note</button>
                </div>
            </div>
            <div class="content flex-col" style="display:flex;flex:1">
                <div id="vault-viewer" style="flex:1;overflow-y:auto;display:flex;align-items:center;justify-content:center;color:var(--text-tertiary);font-size:11px">
                    Select a document to view
                </div>
                <div id="vault-xref" style="display:none;border-top:1px solid var(--border-subtle);padding:8px;max-height:100px;overflow-y:auto">
                    <div style="font-size:8px;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Cross-References</div>
                    <div id="vault-xref-list"></div>
                </div>
            </div>
        </section>

        <!-- === DASHBOARD TAB === -->
        <section id="sec-dashboard" class="section" style="flex-direction:column">
            <div class="content" style="flex:1;overflow-y:auto">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Dashboard Overview</div>
                        <div style="font-size:11px;color:var(--text-tertiary)">The Art of Calisthenics — production at a glance</div>
                    </div>
                    <div class="flex gap-2">
                        <span class="badge">V3</span>
                        <button class="btn btn-sm" onclick="initDashboard()">Refresh</button>
                    </div>
                </div>
                <div class="grid grid-3" id="dash-stats" style="margin-bottom:16px"></div>
                <div class="grid grid-2" style="gap:12px">
                    <div class="card" style="padding:16px">
                        <div class="card-header"><span class="card-title">Writing Progress</span></div>
                        <div id="dash-writing-progress" style="margin-top:8px"></div>
                    </div>
                    <div class="card" style="padding:16px">
                        <div class="card-header"><span class="card-title">Matrix Coverage</span></div>
                        <div id="dash-matrix-coverage" style="margin-top:8px"></div>
                    </div>
                    <div class="card" style="padding:16px">
                        <div class="card-header"><span class="card-title">Recent Decisions</span></div>
                        <div id="dash-recent-decisions" style="margin-top:8px"></div>
                    </div>
                    <div class="card" style="padding:16px">
                        <div class="card-header"><span class="card-title">Active Bottlenecks</span></div>
                        <div id="dash-bottlenecks" style="margin-top:8px"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- === CALENDAR TAB === -->
        <section id="sec-calendar" class="section" style="flex-direction:column">
            <div class="sidebar sidebar-wide" style="flex-direction:column">
                <div class="sidebar-label">CF Program Parser</div>
                <div style="border:2px dashed #27272a;border-radius:8px;padding:16px;text-align:center;margin-bottom:10px;cursor:pointer" onclick="document.getElementById('excel-file-upload').click()" id="excel-drop-zone">
                    <input type="file" id="excel-file-upload" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelUpload(event)">
                    <div style="font-size:10px;color:var(--text-tertiary);font-family:var(--font-mono);text-transform:uppercase;margin-bottom:4px">Upload Excel / CSV</div>
                    <div style="font-size:9px;color:var(--text-tertiary)">Click to upload .xlsx .xls .csv</div>
                </div>
                <div class="sidebar-label" style="margin-top:8px">Sheets</div>
                <div id="excel-sheet-list" style="overflow-y:auto;flex:1"></div>
                <div style="margin-top:auto;padding-top:8px;border-top:1px solid var(--border-subtle)">
                    <button class="btn w-full" onclick="exportCalendarPDF()">Export PDF</button>
                    <button class="btn w-full mt-3" onclick="exportCalendarCSV()">Export CSV</button>
                    <button class="btn w-full mt-3" onclick="buildWorkoutFromCalendar()">Build Workout</button>
                </div>
            </div>
            <div class="content" style="flex:1;overflow-y:auto" id="calendar-content">
                <div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-tertiary);font-size:12px;font-family:var(--font-mono)">Upload an Excel file to parse CF programs</div>
            </div>
        </section>

        <!-- === EXPORT TAB === -->
        <section id="sec-export" class="section" style="flex-direction:column">
            <div class="content" style="flex:1">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Export Hub</div>
                        <div style="font-size:11px;color:var(--text-tertiary)">Centralized export for all data</div>
                    </div>
                </div>
                <div class="grid grid-3" id="export-grid">
                    <div class="export-card">
                        <div class="export-card-title">TOC</div>
                        <div class="export-card-desc">Table of Contents structure</div>
                        <div class="grid grid-2 gap-2">
                            <button class="btn" onclick="exportTOCJson()">JSON</button>
                            <button class="btn" onclick="exportTOCMarkdown()">MD</button>
                            <button class="btn" onclick="exportTOCWord()">Word</button>
                            <button class="btn" onclick="exportTOCPDF()">PDF</button>
                        </div>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Matrix</div>
                        <div class="export-card-desc">Movement graph data</div>
                        <div class="flex gap-2">
                            <button class="btn" style="flex:1" onclick="exportMatrixJson()">JSON</button>
                            <button class="btn" style="flex:1" onclick="exportMatrixCsv()">CSV</button>
                        </div>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Research</div>
                        <div class="export-card-desc">Research frameworks data</div>
                        <button class="btn w-full" onclick="exportResearchJson()">Export JSON</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Writing - Word</div>
                        <div class="export-card-desc">Export current document as .doc</div>
                        <button class="btn w-full" onclick="exportAs('word')">Export Word</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Writing - PDF</div>
                        <div class="export-card-desc">Export current document as PDF</div>
                        <button class="btn w-full" onclick="exportAs('pdf')">Export PDF</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Writing - MD</div>
                        <div class="export-card-desc">Export as Markdown</div>
                        <button class="btn w-full" onclick="exportAs('md')">Export MD</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Writing - HTML</div>
                        <div class="export-card-desc">Export as standalone HTML</div>
                        <button class="btn w-full" onclick="exportAs('html')">Export HTML</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Full State Backup</div>
                        <div class="export-card-desc">Complete app state as JSON</div>
                        <button class="btn btn-primary w-full" onclick="exportAllState()">Backup All</button>
                    </div>
                    <div class="export-card">
                        <div class="export-card-title">Mindmap</div>
                        <div class="export-card-desc">Mindmap nodes and connections</div>
                        <button class="btn w-full" onclick="exportMindmap('json')">Export JSON</button>
                    </div>
                    <div class="export-card" style="border-color:var(--accent-gold);grid-column:1/-1">
                        <div class="export-card-title" style="color:var(--accent-gold)">Export Bundle</div>
                        <div class="export-card-desc">Download all exports at once — TOC, Matrix, Research, Writing, State Backup</div>
                        <button class="btn btn-primary w-full" onclick="exportBundle()">Export All</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- === INTERNAL TAB === -->
        <section id="sec-internal" class="section" style="flex-direction:column">
            <div class="content" style="flex:1">
                <div id="internal-tab-locked" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px">
                    <div style="font-size:48px;opacity:0.2">&#x1f512;</div>
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary)">Internal Section Locked</div>
                    <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:8px">Enter password to access deployment tools</div>
                    <div class="flex gap-2" style="width:300px">
                        <input type="password" id="internal-tab-pw" placeholder="Password..." style="flex:1">
                        <button class="btn btn-primary" onclick="unlockInternalTab()">Unlock</button>
                    </div>
                </div>
                <div id="internal-tab-content" style="display:none">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div style="font-size:15px;font-weight:600;color:var(--text-primary)">Internal Deployment Forge</div>
                            <div style="font-size:11px;color:var(--text-tertiary)">Deployment tools and system status</div>
                        </div>
                        <button class="btn" onclick="lockInternalTab()">Lock</button>
                    </div>
                    <div class="internal-grid">
                        <div class="internal-card">
                            <div class="internal-card-title">Quick Deploy</div>
                            <button class="btn w-full mb-3" onclick="alert('Run: npx gh-pages -d .')">GitHub Pages</button>
                            <button class="btn w-full mb-3" onclick="alert('Push to GitHub for Vercel auto-deploy')">Vercel</button>
                            <button class="btn w-full" onclick="alert('Run: netlify deploy --prod')">Netlify</button>
                        </div>
                        <div class="internal-card">
                            <div class="internal-card-title">Storage Usage</div>
                            <div style="font-size:10px;color:var(--text-tertiary);margin-bottom:6px">localStorage Usage</div>
                            <div style="height:6px;background:var(--bg-deep);border-radius:3px;overflow:hidden"><div id="storage-bar-tab" style="height:100%;background:var(--accent-gold);border-radius:3px;width:2%"></div></div>
                            <div style="font-size:10px;color:var(--text-tertiary);margin-top:4px" id="storage-label-tab">0 KB</div>
                            <button class="btn w-full mt-3" onclick="if(confirm('Clear all cached data?')){localStorage.clear();location.reload();}">Clear Cache</button>
                        </div>
                        <div class="internal-card">
                            <div class="internal-card-title">Locked Structures</div>
                            <div class="locked-item">Mobility Big 7: <span class="locked-status">LOCKED V4</span></div>
                            <div class="locked-item">Movement Patterns: <span class="locked-status">LOCKED V2</span></div>
                            <div class="locked-item">Six Disciplines: <span class="locked-status">LOCKED</span></div>
                            <div class="locked-item">Three Stages: <span class="locked-status">LOCKED</span></div>
                            <div class="locked-item">TOC (7 Parts/25 Ch): <span class="locked-status-active">ACTIVE</span></div>
                        </div>
                        <div class="internal-card">
                            <div class="internal-card-title">Build Info</div>
                            <div style="font-size:10px;color:var(--text-tertiary);line-height:2">
                                Version: <span style="color:var(--text-primary)">V3.0</span><br>
                                Engine: <span style="color:var(--text-primary)">TITAN Design</span><br>
                                Libraries: <span style="color:var(--text-primary)">Quill, Sortable, Cytoscape, pdfmake, kjua</span><br>
                                State Key: <span style="color:var(--text-primary)">vbcc1</span><br>
                                Build Date: <span style="color:var(--text-primary)" id="build-date"></span>
                            </div>
                        </div>
                        <div class="internal-card">
                            <div class="internal-card-title">Data Status</div>
                            <div style="font-size:10px;color:var(--text-tertiary);line-height:2">
                                Matrix Nodes: <span style="color:var(--text-primary)" id="int-matrix-nodes">0</span><br>
                                Matrix Edges: <span style="color:var(--text-primary)" id="int-matrix-edges">0</span><br>
                                Research Cards: <span style="color:var(--text-primary)" id="int-research-count">0</span><br>
                                Decisions: <span style="color:var(--text-primary)" id="int-decisions-count">0</span><br>
                                TOC Items: <span style="color:var(--text-primary)" id="int-toc-count">0</span>
                            </div>
                        </div>
                        <div class="internal-card">
                            <div class="internal-card-title">Actions</div>
                            <button class="btn w-full mb-3" onclick="exportAllState()">Export Full State</button>
                            <button class="btn w-full mb-3" onclick="importState()">Import State</button>
                            <input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(event)">
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <div class="mm-ctx" id="mm-ctx"></div>

    <!-- INTERNAL SECTION MODAL (for S button) -->
    <!-- EDGE MODAL -->
    <div class="modal-overlay" id="edge-modal">
        <div class="modal" style="width:400px">
            <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:4px">Add Relationship</div>
            <div style="font-size:10px;color:var(--text-tertiary);margin-bottom:16px">From: <strong id="edge-source-label"></strong></div>
            <input type="hidden" id="edge-source-id">
            <div style="margin-bottom:8px">
                <div class="node-detail-label">Target Node</div>
                <select id="edge-target" style="width:100%"></select>
            </div>
            <div style="margin-bottom:8px">
                <div class="node-detail-label">Edge Type</div>
                <select id="edge-type" style="width:100%"></select>
            </div>
            <div style="margin-bottom:12px">
                <div class="node-detail-label">Transfer Scale</div>
                <select id="edge-scale" style="width:100%"></select>
            </div>
            <div class="flex gap-2">
                <button class="btn btn-primary" style="flex:1" onclick="saveNewEdge()">Create Edge</button>
                <button class="btn" style="flex:1" onclick="closeEdgeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Gallery Preview Modal -->
    <div class="modal-overlay" id="gallery-preview-modal">
        <div style="position:relative;width:92vw;height:90vh;display:flex;flex-direction:column">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--bg-surface);border-radius:var(--radius-lg) var(--radius-lg) 0 0;border:1px solid var(--border-subtle);border-bottom:none">
                <div>
                    <span id="gallery-preview-title" style="font-size:13px;font-weight:600;color:var(--text-primary)"></span>
                    <span id="gallery-preview-type" class="badge" style="margin-left:8px"></span>
                </div>
                <div style="display:flex;align-items:center;gap:6px">
                    <button class="btn btn-sm" onclick="openGalleryExternal()">Open External</button>
                    <button class="btn btn-sm" style="font-size:14px;padding:4px 10px" onclick="closeGalleryPreview()">&times;</button>
                </div>
            </div>
            <div id="gallery-preview-body" style="flex:1;background:#fff;border-radius:0 0 var(--radius-lg) var(--radius-lg);border:1px solid var(--border-subtle);border-top:none;overflow:hidden;position:relative"></div>
        </div>
    </div>

    <!-- Y1: Query Engine Modal -->
    <div class="modal-overlay" id="query-modal">
        <div class="modal" style="width:560px;max-height:80vh;overflow-y:auto">
            <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:4px">Matrix Query Engine</div>
            <div style="font-size:10px;color:var(--text-tertiary);margin-bottom:16px">Build queries to explore movement relationships</div>
            <div style="margin-bottom:8px">
                <div class="node-detail-label">Query Type</div>
                <select id="query-type" style="width:100%" onchange="updateQueryUI()">
                    <option value="prerequisites">Prerequisites — What do I need before X?</option>
                    <option value="unlocks">Unlocks — What does X lead to?</option>
                    <option value="path">Path — Shortest path from A to B</option>
                    <option value="cluster">Cluster — All nodes connected to X within N steps</option>
                    <option value="pattern">Pattern — All movements in a pattern</option>
                    <option value="stage">Stage — All movements at a stage</option>
                    <option value="orphans">Orphans — Nodes with no connections</option>
                </select>
            </div>
            <div id="query-params" style="margin-bottom:12px"></div>
            <div class="flex gap-2" style="margin-bottom:12px">
                <button class="btn btn-primary" style="flex:1" onclick="runQuery()">Run Query</button>
                <button class="btn" style="flex:1" onclick="closeQueryEngine()">Close</button>
            </div>
            <div id="query-results" style="max-height:300px;overflow-y:auto"></div>
        </div>
    </div>

    <div class="modal-overlay" id="internal-modal">
        <div class="modal">
            <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:16px">Internal Section</div>
            <input type="password" id="internal-pw" placeholder="Password..." style="margin-bottom:12px">
            <div class="flex gap-2">
                <button class="btn btn-primary" style="flex:1" onclick="validateInternal()">Enter</button>
                <button class="btn" style="flex:1" onclick="closeInternal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INTERNAL SECTION OVERLAY (for S button) -->
    <div id="internal-section" style="display:none;position:fixed;inset:0;background:var(--bg-void);z-index:90;overflow:auto">
        <div class="header" style="border-bottom:1px solid var(--border-subtle)">
            <div class="flex items-center gap-3">
                <div class="logo-icon" style="width:28px;height:28px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2.5"><circle cx="12" cy="12" r="5.5"/><ellipse cx="12" cy="12" rx="11" ry="3.5"/></svg></div>
                <span style="font-size:13px;font-weight:600;color:var(--text-primary)">INTERNAL DEPLOYMENT FORGE</span>
            </div>
            <button class="btn" onclick="exitInternal()">Exit</button>
        </div>
        <div style="padding:24px">
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-title mb-3">Quick Deploy</div>
                    <button class="btn w-full mb-3" onclick="alert('Run: npx gh-pages -d .')">GitHub Pages</button>
                    <button class="btn w-full" onclick="alert('Push to GitHub for Vercel auto-deploy')">Vercel</button>
                </div>
                <div class="card">
                    <div class="card-title mb-3">Storage</div>
                    <div style="font-size:10px;color:var(--text-tertiary);margin-bottom:6px">localStorage Usage</div>
                    <div style="height:6px;background:var(--bg-deep);border-radius:3px;overflow:hidden"><div id="storage-bar" style="height:100%;background:var(--accent-gold);border-radius:3px;width:2%"></div></div>
                    <div style="font-size:10px;color:var(--text-tertiary);margin-top:4px" id="storage-label">0 KB</div>
                    <button class="btn w-full mt-3" onclick="if(confirm('Clear all cached data?')){localStorage.clear();alert('Cleared')}">Clear Cache</button>
                </div>
                <div class="card">
                    <div class="card-title mb-3">Locked Structures</div>
                    <div style="font-size:10px;color:var(--text-tertiary);line-height:1.8">
                        Mobility Big 7: <span style="color:var(--accent-success)">LOCKED V4</span><br>
                        Movement Patterns: <span style="color:var(--accent-success)">LOCKED V2</span><br>
                        Six Disciplines: <span style="color:var(--accent-success)">LOCKED</span><br>
                        Three Stages: <span style="color:var(--accent-success)">LOCKED</span><br>
                        TOC (7 Parts/25 Ch): <span style="color:var(--accent-gold)">ACTIVE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // STATE
    const S = {
        tab: 'toc',
        tocs: { v1: [], v2: [] },
        htmlFiles: [
            { id:1, name:'Saturno Solar System', tag:'Deployed', path:'https://gabosaturno11.github.io/saturno-solar-system/' },
            { id:2, name:'Exercise Constellation Builder', tag:'Visual', path:'htmls/exercise_constellation_builder.html' },
            { id:3, name:'Three Circle Mastery Mandala', tag:'Visual', path:'htmls/three_circle_mastery_mandala.html' },
            { id:4, name:'Alpha Intelligence Infinity Loop', tag:'Visual', path:'htmls/alpha_intelligence_infinity_loop.html' },
            { id:5, name:'Arc Line Variations', tag:'Visual', path:'htmls/arc-line-variations.html' },
            { id:6, name:'Calisthenics Framework HTML', tag:'Framework', path:'htmls/calisthenics_framework_html.html' },
            { id:7, name:'Calisthenics Framework System', tag:'Framework', path:'htmls/calisthenics_framework_system.html' },
            { id:8, name:'Calisthenics Mastery Map', tag:'Map', path:'htmls/calisthenics_mastery_map.html' },
            { id:9, name:'Complete TOC Visual', tag:'TOC', path:'htmls/calisthenics-complete-toc-visual.html' },
            { id:10, name:'Chapter Card Variations', tag:'Visual', path:'htmls/chapter_card_variations.html' },
            { id:11, name:'Creative Progression Roadmap', tag:'Map', path:'htmls/creative-progression-roadmap.html' },
            { id:12, name:'Handstand Exercise Layout', tag:'Exercise', path:'htmls/handstand_exercise_layout.html' },
            { id:13, name:'Journey Flow Variations', tag:'Visual', path:'htmls/journey_flow_variations.html' },
            { id:14, name:'Mini Heatmap Variations', tag:'Visual', path:'htmls/mini-heatmap-variations.html' },
            { id:15, name:'Movement Galaxy Hub', tag:'Map', path:'htmls/movement_galaxy_hub.html' },
            { id:16, name:'Planetary Progression System', tag:'Map', path:'htmls/planetary_progression_system.html' },
            { id:17, name:'Push-Up Interlocking Gears', tag:'Exercise', path:'htmls/pushup_interlocking_gears_complete.html' },
            { id:18, name:'Push-Up Perfect Series', tag:'Exercise', path:'htmls/pushup_perfect_series.html' },
            { id:19, name:'Ring Orb Variations', tag:'Visual', path:'htmls/ring-orb-variations.html' },
            { id:20, name:'TOC Progress Adaptations', tag:'TOC', path:'htmls/toc_progress_adaptations.html' },
            { id:21, name:'Vertical Lift Variations', tag:'Exercise', path:'htmls/vertical-lift-variations.html' },
            { id:22, name:'Wisdom Boxes Design', tag:'Visual', path:'htmls/wisdom-boxes-design.html' },
            { id:23, name:'TITAN V1.2 — Writing Synthesizer', tag:'Deployed', path:'https://gabosaturno11.github.io/titan-forge/titan.html' },
            { id:24, name:'Saturno Forge — Dashboard', tag:'Deployed', path:'https://gabosaturno11.github.io/titan-forge/' },
            { id:25, name:'Apoapsis Writer', tag:'Deployed', path:'https://gabosaturno11.github.io/titan-forge/writer.html' },
            { id:26, name:'Batch Generator', tag:'Deployed', path:'https://gabosaturno11.github.io/titan-forge/batch-generator.html' },
        ],
        research: [
            { id:1, name:'Movement as First Language', cat:'movement', claim:'The body learns like language: repetition with variation wires fluency', mechanism:'Contextual interference improves differential learning', evidence:'Schmidt & Lee, 2019', placement:'Introduction', used:false, blockA:'', blockB:'', blockC:'', blockD:'' },
            { id:2, name:'Procrastination as Emotion Regulation', cat:'psychology', claim:'Procrastination is an emotion problem, not time problem', mechanism:'Anticipated negative affect drives delay', evidence:'Pychyl & Sirois, 2016', placement:'Ch1: Barriers sidebar', used:true, blockA:'', blockB:'', blockC:'', blockD:'' },
            { id:3, name:'Neural Plasticity in Adults', cat:'neuroscience', claim:'Adult brains remain plastic and capable of reorganization', mechanism:'Myelination responds to deliberate practice', evidence:'Pascual-Leone neuroimaging', placement:'Part 1', used:false, blockA:'', blockB:'', blockC:'', blockD:'' },
            { id:4, name:'Progressive Overload Principle', cat:'training', claim:'Adaptation requires systematic increase in stress', mechanism:'Supercompensation follows stress-recovery', evidence:'Selye, 1956', placement:'Part 4', used:false, blockA:'', blockB:'', blockC:'', blockD:'' },
        ],
        exercises: [
            { id:1,name:'Push-Up',pattern:'Horizontal Push',stage:'Foundation',equip:'Floor' },
            { id:2,name:'Diamond Push-Up',pattern:'Horizontal Push',stage:'Mastery',equip:'Floor' },
            { id:3,name:'Archer Push-Up',pattern:'Horizontal Push',stage:'Mastery',equip:'Floor' },
            { id:4,name:'Pseudo Planche Push-Up',pattern:'Horizontal Push',stage:'Elite',equip:'Floor' },
            { id:5,name:'Inverted Row',pattern:'Horizontal Pull',stage:'Foundation',equip:'Bar' },
            { id:6,name:'Tuck Front Lever Row',pattern:'Horizontal Pull',stage:'Mastery',equip:'Bar' },
            { id:7,name:'Pull-Up',pattern:'Vertical Pull',stage:'Foundation',equip:'Bar' },
            { id:8,name:'Muscle-Up',pattern:'Vertical Pull',stage:'Elite',equip:'Bar' },
            { id:9,name:'Dip',pattern:'Downward Press',stage:'Foundation',equip:'Parallettes' },
            { id:10,name:'Ring Dip',pattern:'Downward Press',stage:'Mastery',equip:'Rings' },
            { id:11,name:'Pike Push-Up',pattern:'Overhead Press',stage:'Foundation',equip:'Floor' },
            { id:12,name:'Handstand Push-Up',pattern:'Overhead Press',stage:'Elite',equip:'Wall' },
            { id:13,name:'Squat',pattern:'Knee-Dominant',stage:'Foundation',equip:'None' },
            { id:14,name:'Pistol Squat',pattern:'Knee-Dominant',stage:'Elite',equip:'None' },
            { id:15,name:'Shrimp Squat',pattern:'Knee-Dominant',stage:'Elite',equip:'None' },
            { id:16,name:'Hip Bridge',pattern:'Hip-Dominant',stage:'Foundation',equip:'Floor' },
            { id:17,name:'Nordic Curl',pattern:'Hip-Dominant',stage:'Mastery',equip:'Floor' },
            { id:18,name:'Hollow Body Hold',pattern:'Core',stage:'Foundation',equip:'Floor' },
            { id:19,name:'L-Sit',pattern:'Core',stage:'Mastery',equip:'Parallettes' },
            { id:20,name:'Dragon Flag',pattern:'Core',stage:'Elite',equip:'Floor' },
            { id:21,name:'Resting Squat',pattern:'Mobility',stage:'Foundation',equip:'None' },
            { id:22,name:'Forward Fold',pattern:'Mobility',stage:'Foundation',equip:'None' },
            { id:23,name:'Pancake',pattern:'Mobility',stage:'Mastery',equip:'None' },
            { id:24,name:'Front Split',pattern:'Mobility',stage:'Elite',equip:'None' },
            { id:25,name:'Bridge',pattern:'Mobility',stage:'Mastery',equip:'Floor' },
            { id:26,name:'German Hang',pattern:'Mobility',stage:'Mastery',equip:'Bar' },
        ],
        decisions: [
            { id:1, date:'2026-01-27', title:'Use "Mastering" not "Master"', context:'Language choice: process vs title', status:'resolved' },
            { id:2, date:'2026-01-27', title:'Excellence > Perfection paradigm', context:'Chapter 11 technique naming', status:'resolved' },
            { id:3, date:'2026-01-27', title:'TOC is NOT final - 5000 versions', context:'Go slow, do not assume', status:'open' },
        ],
        bottlenecks: [
            { id:1, title:'TOC version sync with Kortext', priority:'high' },
            { id:2, title:'13 CSVs pending in Perplexity', priority:'high' },
        ],
        mindmap: {
            nodes: [
                { id:1,x:400,y:180,text:'Art of Calisthenics',color:'var(--accent-gold)' },
                { id:2,x:160,y:80,text:'7 Patterns',color:'var(--accent-blue)' },
                { id:3,x:640,y:80,text:'6 Disciplines',color:'var(--accent-success)' },
                { id:4,x:160,y:280,text:'Mobility Big 7',color:'var(--accent-warning)' },
                { id:5,x:640,y:280,text:'3 Stages',color:'var(--accent-purple)' },
                { id:6,x:400,y:360,text:'Solar System',color:'var(--accent-gold)' },
            ],
            edges: [{f:1,t:2},{f:1,t:3},{f:1,t:4},{f:1,t:5},{f:1,t:6}]
        },
        documents: {},
        matrixData: null,
        pw: 'saturno2026'
    };

    let cy = null;

    // TAB SWITCHING
    document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', function() {
            const t = this.dataset.tab;
            S.tab = t;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-'+t).classList.add('active');
            this.classList.add('active');
            const init = {
                toc: initTOC,
                writing: initWriting,
                htmls: initHTMLs,
                research: ()=>renderResearch('all'),
                workout: initWorkout,
                mindmap: renderMindmap,
                decisions: initDecisions,
                matrix: initMatrix,
                taxonomy: initTaxonomy,
                barcode: initBarcode,
                vault: initVault,
                dashboard: initDashboard,
                calendar: initCalendar,
                export: initExport,
                internal: initInternalTab
            };
            if (init[t]) init[t]();
        });
    });

    // TOC
    function initTOC() { if(!S.tocs.v3) S.tocs.v3=[]; if(!S.tocNotes) S.tocNotes={}; loadTOC('left'); loadTOC('right'); updateTOCAnalytics(); }

    // TOC view toggle: Compare vs Notes
    let tocViewMode = 'compare';
    function setTocView(mode) {
        tocViewMode = mode;
        document.querySelectorAll('.toc-view-btn').forEach(b => b.classList.toggle('active', b.textContent.trim().toLowerCase() === mode));
        const cmp = document.getElementById('toc-compare-view');
        const nts = document.getElementById('toc-notes-view');
        if (mode === 'notes') {
            if(cmp) cmp.style.display='none';
            if(nts) { nts.classList.add('active'); renderTocNotes(); }
        } else {
            if(cmp) cmp.style.display='';
            if(nts) nts.classList.remove('active');
        }
    }

    // Gradient palette per part index
    const tocPartGrads = [
        'linear-gradient(135deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%)',
        'linear-gradient(135deg, rgba(255,170,0,0.08) 0%, rgba(255,170,0,0.02) 100%)',
        'linear-gradient(135deg, rgba(255,170,0,0.07) 0%, rgba(255,107,53,0.02) 100%)',
        'linear-gradient(135deg, rgba(255,170,0,0.06) 0%, rgba(168,85,247,0.03) 100%)',
        'linear-gradient(135deg, rgba(0,207,255,0.06) 0%, rgba(0,255,136,0.02) 100%)',
        'linear-gradient(135deg, rgba(168,85,247,0.06) 0%, rgba(0,207,255,0.02) 100%)',
        'linear-gradient(135deg, rgba(0,255,136,0.06) 0%, rgba(255,170,0,0.02) 100%)',
        'linear-gradient(135deg, rgba(255,68,102,0.06) 0%, rgba(255,107,53,0.02) 100%)',
        'linear-gradient(135deg, rgba(255,170,0,0.08) 0%, rgba(255,215,0,0.03) 100%)',
    ];
    const tocPartBorders = ['rgba(255,255,255,0.08)','#ffaa00','#ff8c00','#a855f7','#00cfff','#a855f7','#00ff88','#ff4466','#ffaa00'];

    function renderTocNotes() {
        const v = document.getElementById('toc-v-left').value;
        const items = S.tocs[v] || [];
        if (!S.tocNotes) S.tocNotes = {};
        const el = document.getElementById('toc-notes-view');
        if (!el) return;
        // Group items by part
        let html = '', partIdx = -1, inChapter = false, chapterId = null;
        items.forEach((item, idx) => {
            if (item.type === 'part') {
                if (inChapter) html += '</div>'; // close prev chapter sections
                if (partIdx >= 0) html += '</div>'; // close prev part card
                partIdx++;
                inChapter = false;
                const grad = tocPartGrads[partIdx % tocPartGrads.length];
                const bc = tocPartBorders[partIdx % tocPartBorders.length];
                html += `<div class="toc-part-card" style="border:1px solid ${bc}30">`;
                html += `<div class="toc-part-header" style="background:${grad};border-left:3px solid ${bc}">${item.title}</div>`;
            } else if (item.type === 'chapter') {
                if (inChapter) html += '</div>'; // close prev chapter card
                inChapter = true;
                chapterId = item.id;
                const noteVal = (S.tocNotes[item.id] || '').replace(/&/g,'&amp;').replace(/</g,'&lt;');
                html += `<div class="toc-ch-card">`;
                html += `<div class="toc-ch-title">${item.title}</div>`;
                html += `<div class="toc-ch-sections" id="toc-nsec-${item.id}">`;
                // Sections will be appended next
            } else if (item.type === 'section') {
                if (!inChapter) return;
                html += `<div style="padding:1px 0">${item.title}</div>`;
            }
        });
        if (inChapter) html += '</div>'; // close last sections div
        // close last chapter + add note textarea
        // Actually, let me restructure: close sections, add note, close card
        // Re-do with better grouping
        html = ''; partIdx = -1;
        let openChapter = false, openPart = false;
        items.forEach((item) => {
            if (item.type === 'part') {
                if (openChapter) { html += `</div></div>`; openChapter = false; }
                if (openPart) { html += `</div>`; openPart = false; }
                partIdx++;
                const grad = tocPartGrads[partIdx % tocPartGrads.length];
                const bc = tocPartBorders[partIdx % tocPartBorders.length];
                html += `<div class="toc-part-card" style="border:1px solid ${bc}30">`;
                html += `<div class="toc-part-header" style="background:${grad};border-left:3px solid ${bc}">${item.title}</div>`;
                openPart = true;
            } else if (item.type === 'chapter') {
                if (openChapter) { html += `</div></div>`; openChapter = false; }
                const noteVal = (S.tocNotes[item.id] || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
                html += `<div class="toc-ch-card"><div class="toc-ch-title">${item.title}</div><div class="toc-ch-sections">`;
                openChapter = true;
                // Note textarea comes after sections close
                html += `</div><textarea class="toc-ch-note" placeholder="Notes for ${item.title.replace(/"/g,'&quot;')}..." onblur="saveTocNote(${item.id},this.value)" oninput="this.style.height='36px';this.style.height=Math.min(this.scrollHeight,160)+'px'" onkeydown="event.stopPropagation()">${noteVal}</textarea>`;
            } else if (item.type === 'section' && openChapter) {
                // Insert before the closing sections div — need to restructure
            }
        });
        if (openChapter) html += '</div>';
        if (openPart) html += '</div>';

        // Better approach: pre-group then render
        html = '';
        const groups = []; let curPart = null, curChapter = null;
        items.forEach(item => {
            if (item.type === 'part') {
                curPart = { item, chapters: [] };
                groups.push(curPart);
                curChapter = null;
            } else if (item.type === 'chapter') {
                curChapter = { item, sections: [] };
                if (curPart) curPart.chapters.push(curChapter);
                else groups.push({ item: null, chapters: [curChapter] });
            } else if (item.type === 'section' && curChapter) {
                curChapter.sections.push(item);
            }
        });
        groups.forEach((g, pi) => {
            const grad = tocPartGrads[pi % tocPartGrads.length];
            const bc = tocPartBorders[pi % tocPartBorders.length];
            if (g.item) {
                html += `<div class="toc-part-card" style="border:1px solid ${bc}30">`;
                html += `<div class="toc-part-header" style="background:${grad};border-left:3px solid ${bc}">${g.item.title}</div>`;
            }
            g.chapters.forEach(ch => {
                const noteVal = (S.tocNotes[ch.item.id] || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
                html += `<div class="toc-ch-card">`;
                html += `<div class="toc-ch-title">${ch.item.title}</div>`;
                if (ch.sections.length) {
                    html += `<div class="toc-ch-sections">${ch.sections.map(s => s.title).join('<br>')}</div>`;
                }
                html += `<textarea class="toc-ch-note" placeholder="Notes..." onblur="saveTocNote(${ch.item.id},this.value)" oninput="this.style.height='36px';this.style.height=Math.min(this.scrollHeight,160)+'px'" onkeydown="event.stopPropagation()">${noteVal}</textarea>`;
                html += `</div>`;
            });
            if (g.item) html += `</div>`;
        });
        el.innerHTML = html;
        // Auto-expand textareas with existing content
        el.querySelectorAll('.toc-ch-note').forEach(ta => { if(ta.value) { ta.style.height='36px'; ta.style.height=Math.min(ta.scrollHeight,160)+'px'; } });
    }
    function saveTocNote(chId, val) {
        if (!S.tocNotes) S.tocNotes = {};
        if (val.trim()) S.tocNotes[chId] = val;
        else delete S.tocNotes[chId];
        save();
    }

    async function loadExternalTOC() {
        try {
            const r = await fetch('data/toc.json');
            const d = await r.json();
            ['v1','v2'].forEach(v => {
                if (!d.tocs?.[v]) return;
                S.tocs[v] = []; let id = 1;
                d.tocs[v].parts.forEach(p => {
                    S.tocs[v].push({id:id++, title:p.name, type:'part'});
                    (p.chapters||[]).forEach(c => {
                        S.tocs[v].push({id:id++, title:c.title, type:'chapter'});
                        (c.sections||[]).forEach(s => S.tocs[v].push({id:id++, title:s, type:'section'}));
                    });
                });
            });
            document.getElementById('k-chapters').textContent = S.tocs.v1.filter(i=>i.type==='chapter').length;
            document.getElementById('k-parts').textContent = S.tocs.v1.filter(i=>i.type==='part').length;
            initTOC(); save();
        } catch(e) { console.warn('toc.json not found, using defaults'); loadDefaultTOC(); }
    }

    function loadDefaultTOC() {
        S.tocs.v1 = [
            // FRONT MATTER
            {id:1,title:'FRONT MATTER',type:'part'},
            {id:2,title:'Dedication',type:'chapter'},{id:3,title:'Foreword (by Victory Belt)',type:'chapter'},{id:4,title:'Preface (Your Journey to This Book)',type:'chapter'},
            {id:5,title:'Disclaimer (Medical/Legal)',type:'chapter'},{id:6,title:'How to Use This Book (Navigation Guide + System Thinking)',type:'chapter'},{id:7,title:'Movement DNA Index (Cross-Reference System)',type:'chapter'},
            // THE SPARK: INTRODUCTION
            {id:8,title:'THE SPARK: INTRODUCTION',type:'part'},
            {id:9,title:'The Movement Paradox',type:'chapter'},{id:10,title:'Why Calisthenics?',type:'chapter'},{id:11,title:'Movement as Humanity\'s First Language',type:'chapter'},
            {id:12,title:'The Two Lenses of Progress (linear vs spiral)',type:'chapter'},{id:13,title:'Your Journey Begins Here',type:'chapter'},{id:14,title:'The Author\'s Story (2019\u20132025 Evolution)',type:'chapter'},
            {id:15,title:'The Movement Ecosystem Universe Explained',type:'chapter'},
            // PART I: BEGIN
            {id:16,title:'PART I: BEGIN \u2014 Start Here',type:'part'},
            {id:17,title:'Chapter 1: What, How, Why & Who',type:'chapter'},
            {id:18,title:'1.1 Why Do You Move? (The Fundamental Question)',type:'section'},{id:19,title:'1.2 The Purpose Formula: Survival\u2192Status\u2192Success\u2192Meaning',type:'section'},
            {id:20,title:'1.3 What This Book Will Teach You',type:'section'},{id:21,title:'1.4 How to Best Approach This Book (System Thinking)',type:'section'},
            {id:22,title:'1.5 Who Is This Book For? (The Three Archetypes)',type:'section'},{id:23,title:'1.6 Your Starting Point Assessment',type:'section'},
            {id:24,title:'Chapter 2: Getting Started',type:'chapter'},
            {id:25,title:'2.1 More Action, Less Knowledge (80/20 Principle)',type:'section'},{id:26,title:'2.2 Practice, Practice, Practice (Consistency Framework)',type:'section'},
            {id:27,title:'2.3 Direction Over Speed (Patience Philosophy)',type:'section'},{id:28,title:'2.4 Your First Week Protocol',type:'section'},
            {id:29,title:'2.5 Common Beginner Mistakes',type:'section'},{id:30,title:'2.6 Building Momentum',type:'section'},
            // PART II: CRAFT
            {id:31,title:'PART II: CRAFT \u2014 The Art of Calisthenics',type:'part'},
            {id:32,title:'Chapter 3: What is Calisthenics?',type:'chapter'},
            {id:33,title:'3.1 Definition & History',type:'section'},{id:34,title:'3.2 Advantages Over Traditional Training',type:'section'},
            {id:35,title:'3.3 Disadvantages & Limitations',type:'section'},{id:36,title:'3.4 Foundation For Future Training',type:'section'},
            {id:37,title:'Chapter 4: Calisthenics vs Gymnastics',type:'chapter'},
            {id:38,title:'4.1 Historical Divergence',type:'section'},{id:39,title:'4.2 Training Methodology Differences',type:'section'},
            {id:40,title:'4.3 Accessibility Factors',type:'section'},{id:41,title:'4.4 Skill Transfer Between Disciplines',type:'section'},{id:42,title:'4.5 Crafting Your Practice',type:'section'},
            {id:43,title:'Chapter 5: Calisthenics Training for the Lower Body',type:'chapter'},
            {id:44,title:'5.1 The Lower Body Myth',type:'section'},{id:45,title:'5.2 Unilateral Training Superiority',type:'section'},
            {id:46,title:'5.3 Jump Training & Plyometrics',type:'section'},{id:47,title:'5.4 Weighted Variations',type:'section'},{id:48,title:'5.5 Integration with Upper Body',type:'section'},
            {id:49,title:'Chapter 6: Calisthenics is for Everyone',type:'chapter'},
            {id:50,title:'6.1 Then & Now: Evolution of the Discipline',type:'section'},{id:51,title:'6.2 My Training Philosophy',type:'section'},
            {id:52,title:'6.3 The 3 Archetypes (Seeker, Builder, Practitioner)',type:'section'},{id:53,title:'6.4 Age, Gender, and Background Considerations',type:'section'},
            {id:54,title:'6.5 Calisthenics in Sports Performance',type:'section'},{id:55,title:'6.6 Adaptive Calisthenics',type:'section'},
            {id:56,title:'Chapter 7: Is Calisthenics Safe?',type:'chapter'},
            {id:57,title:'7.1 Injury Statistics vs Traditional Training',type:'section'},{id:58,title:'7.2 Joint Health Benefits',type:'section'},
            {id:59,title:'7.3 Progressive Overload Principles',type:'section'},{id:60,title:'7.4 Risk Management Strategies',type:'section'},{id:61,title:'7.5 Long-term Sustainability',type:'section'},
            {id:62,title:'Chapter 8: What to Expect from Calisthenics?',type:'chapter'},
            {id:63,title:'8.1 Realistic Timeline Expectations',type:'section'},{id:64,title:'8.2 Physical Transformations',type:'section'},
            {id:65,title:'8.3 Mental & Emotional Changes',type:'section'},{id:66,title:'8.4 Life Demands and Sacrifices',type:'section'},{id:67,title:'8.5 The Compound Effect',type:'section'},
            {id:68,title:'Chapter 9: Goal Setting',type:'chapter'},
            {id:69,title:'9.1 SMART Goals Adapted for Calisthenics',type:'section'},{id:70,title:'9.2 Process vs Outcome Goals',type:'section'},
            {id:71,title:'9.3 Milestone Mapping',type:'section'},{id:72,title:'9.4 Tracking Progress',type:'section'},{id:73,title:'9.5 Adjusting Expectations',type:'section'},
            {id:74,title:'Chapter 10: Equipment Guide',type:'chapter'},
            {id:75,title:'10.1 Minimal vs Optimal Equipment Philosophy',type:'section'},{id:76,title:'10.2 Essential Equipment (Pull-up Bar, Parallettes)',type:'section'},
            {id:77,title:'10.3 Optional Equipment (Rings, Resistance Bands)',type:'section'},{id:78,title:'10.4 Home Gym Setup Guide',type:'section'},
            {id:79,title:'10.5 Weighted Calisthenics Tools',type:'section'},{id:80,title:'10.6 Integration with Free Weights',type:'section'},
            // PART III: DEEPEN
            {id:81,title:'PART III: DEEPEN \u2014 The Mastering Process',type:'part'},
            {id:82,title:'Chapter 11: Excellence Technique Paradigm',type:'chapter'},
            {id:83,title:'11.1 Injuries (Learning from Pain)',type:'section'},{id:84,title:'11.2 Effectiveness (Results Measurement)',type:'section'},
            {id:85,title:'11.3 Efficiency (Energy Economy)',type:'section'},{id:86,title:'11.4 Replicability (Consistency Standards)',type:'section'},
            {id:87,title:'11.5 Transferability (Skill Connections)',type:'section'},{id:88,title:'11.6 Aesthetics (Form & Function)',type:'section'},{id:89,title:'11.7 Excellence vs. Perfection',type:'section'},
            {id:90,title:'Chapter 12: The Calisthenics Journey',type:'chapter'},
            {id:91,title:'12.1 The Growth Mindset',type:'section'},{id:92,title:'12.2 The Beginner\'s Mind',type:'section'},
            {id:93,title:'12.3 The Approach Philosophy',type:'section'},{id:94,title:'12.4 The Warm-Up Ritual',type:'section'},{id:95,title:'12.5 Mental Models for Progress',type:'section'},
            {id:96,title:'Chapter 13: The Three Stages',type:'chapter'},
            {id:97,title:'13.1 Stage 1: Creating the Base (Foundation)',type:'section'},
            {id:98,title:'Movement Literacy Development',type:'section'},{id:99,title:'Scapular Control Mastering',type:'section'},
            {id:100,title:'Fundamental Static Positions',type:'section'},{id:101,title:'Core Movement Patterns',type:'section'},
            {id:102,title:'13.2 Stage 2: Building the Structure (Development)',type:'section'},
            {id:103,title:'Strength Integration Phase',type:'section'},{id:104,title:'The Big Seven Skills Introduction',type:'section'},{id:105,title:'Power Development',type:'section'},
            {id:106,title:'13.3 Stage 3: Continuous Mastering (Specialization)',type:'section'},
            {id:107,title:'Advanced Skill Development',type:'section'},{id:108,title:'Power-Free Movements',type:'section'},
            {id:109,title:'Dynamic Skill Integration',type:'section'},{id:110,title:'Personal Style Development',type:'section'},
            {id:111,title:'13.4 Transition Protocols',type:'section'},{id:112,title:'13.5 Stage Assessment Criteria',type:'section'},
            // PART IV: CHOOSE
            {id:113,title:'PART IV: CHOOSE \u2014 Your Unique Odyssey',type:'part'},
            {id:114,title:'Chapter 14: Bodybuilding',type:'chapter'},
            {id:115,title:'14.1 Aesthetics Philosophy',type:'section'},{id:116,title:'14.2 Hypertrophy Fundamentals',type:'section'},
            {id:117,title:'14.3 Volume Prescription',type:'section'},{id:118,title:'14.4 Effort & Intensity Management',type:'section'},
            {id:119,title:'14.5 Nutrition for Muscle Building',type:'section'},{id:120,title:'14.6 Sample Programs',type:'section'},
            {id:121,title:'Chapter 15: Power Free',type:'chapter'},
            {id:122,title:'15.1 Static Strength Science',type:'section'},{id:123,title:'15.2 Handstand Push-Up Progression',type:'section'},
            {id:124,title:'15.3 90-Degree Handstand Push-Up',type:'section'},{id:125,title:'15.4 Planche Development',type:'section'},
            {id:126,title:'15.5 Front Lever Mastering',type:'section'},{id:127,title:'15.6 One-Arm Pull-Up Journey',type:'section'},{id:128,title:'15.7 Combining Static Skills',type:'section'},
            {id:129,title:'Chapter 16: Freestyle Calisthenics',type:'chapter'},
            {id:130,title:'16.1 Competition Standards',type:'section'},{id:131,title:'16.2 Risk vs. Reward Analysis',type:'section'},
            {id:132,title:'16.3 Flow State Development',type:'section'},{id:133,title:'16.4 Fear Management',type:'section'},
            {id:134,title:'16.5 Creative Expression',type:'section'},{id:135,title:'16.6 Building Combinations',type:'section'},
            {id:136,title:'Chapter 17: Street Lifting',type:'chapter'},
            {id:137,title:'17.1 Understanding Maximal Strength',type:'section'},{id:138,title:'17.2 Competition Rules & Standards',type:'section'},
            {id:139,title:'17.3 The Weighted Dip',type:'section'},{id:140,title:'17.4 The Weighted Pull-Up',type:'section'},
            {id:141,title:'17.5 The Weighted Muscle-Up',type:'section'},{id:142,title:'17.6 The Squat',type:'section'},
            {id:143,title:'Chapter 18: Hand-Balancing',type:'chapter'},
            {id:144,title:'18.1 The Endless Journey Philosophy',type:'section'},{id:145,title:'18.2 Strength Requirements',type:'section'},
            {id:146,title:'18.3 Balance Development',type:'section'},{id:147,title:'18.4 Alignment Principles',type:'section'},
            {id:148,title:'18.5 Mobility Prerequisites',type:'section'},{id:149,title:'18.6 Entry Variations',type:'section'},{id:150,title:'18.7 Training on Different Surfaces',type:'section'},
            {id:151,title:'Chapter 19: Mobility Skills',type:'chapter'},
            {id:152,title:'19.1 Mobility vs. Flexibility Distinction',type:'section'},{id:153,title:'19.2 Strength Through Length',type:'section'},
            {id:154,title:'19.3 The Squat',type:'section'},{id:155,title:'19.4 The Forward Fold',type:'section'},
            {id:156,title:'19.5 The Pancake',type:'section'},{id:157,title:'19.6 The Splits (Front & Side)',type:'section'},
            {id:158,title:'19.7 The Bridge',type:'section'},{id:159,title:'19.8 The German Hang',type:'section'},
            {id:160,title:'Chapter 20: Hybrid Paths',type:'chapter'},
            {id:161,title:'20.1 The "Well-Rounded" Athlete Myth',type:'section'},{id:162,title:'20.2 Conflicting vs. Complementary Goals',type:'section'},
            {id:163,title:'20.3 Double Session Strategies',type:'section'},{id:164,title:'20.4 Bodybuilding + Power Free',type:'section'},
            {id:165,title:'20.5 Bodybuilding + Street Lifting',type:'section'},{id:166,title:'20.6 Power Free + Street Lifting',type:'section'},
            {id:167,title:'20.7 Adding Handstands to Any Path',type:'section'},{id:168,title:'20.8 Can You Have It All?',type:'section'},
            // PART V: DESIGN
            {id:169,title:'PART V: DESIGN \u2014 Building Your Own Program',type:'part'},
            {id:170,title:'Chapter 21: Program Templates',type:'chapter'},
            {id:171,title:'21.1 Template Selection Criteria',type:'section'},{id:172,title:'21.2 Bodybuilding Templates',type:'section'},
            {id:173,title:'21.3 Power Free Templates',type:'section'},{id:174,title:'21.4 Freestyle Templates',type:'section'},
            {id:175,title:'21.5 Street Lifting Templates',type:'section'},{id:176,title:'21.6 Hand-Balancing Templates',type:'section'},
            {id:177,title:'21.7 Mobility Templates',type:'section'},{id:178,title:'21.8 Hybrid Templates',type:'section'},
            {id:179,title:'Chapter 22: Constructing Your Routine',type:'chapter'},
            {id:180,title:'22.1 Volume Calculations',type:'section'},{id:181,title:'22.2 Frequency Optimization',type:'section'},
            {id:182,title:'22.3 Intensity Management',type:'section'},{id:183,title:'22.4 Exercise Selection',type:'section'},
            {id:184,title:'22.5 Workout Split Options',type:'section'},{id:185,title:'22.6 Periodization Models',type:'section'},
            {id:186,title:'22.7 Deload Protocols',type:'section'},{id:187,title:'22.8 Custom Program Examples',type:'section'},
            // PART VI: ENDURE
            {id:188,title:'PART VI: ENDURE \u2014 The Endless Journey',type:'part'},
            {id:189,title:'Chapter 23: Working Around Injuries',type:'chapter'},
            {id:190,title:'23.1 Accepting the Risk',type:'section'},{id:191,title:'23.2 Pain Beyond The Body',type:'section'},
            {id:192,title:'23.3 Knowing is Overrated',type:'section'},{id:193,title:'23.4 Recovery Protocols',type:'section'},
            {id:194,title:'23.5 Rehabilitation Strategies',type:'section'},{id:195,title:'23.6 Do Not Miss the Lesson',type:'section'},{id:196,title:'23.7 Coming Back Stronger',type:'section'},
            {id:197,title:'Chapter 24: Patience is a Virtue',type:'chapter'},
            {id:198,title:'24.1 Do Not Rush (The Slow Cook)',type:'section'},{id:199,title:'24.2 Enjoy the Process',type:'section'},
            {id:200,title:'24.3 Celebrate Small Wins',type:'section'},{id:201,title:'24.4 You Are One Workout Away',type:'section'},
            {id:202,title:'24.5 Comparison is the Thief of Joy',type:'section'},{id:203,title:'24.6 Discipline vs. Motivation',type:'section'},{id:204,title:'24.7 The Long Game',type:'section'},
            // PART VII: LEGACY
            {id:205,title:'PART VII: LEGACY \u2014 The Endless Mastering Journey',type:'part'},
            {id:206,title:'Chapter 25: What is Next?',type:'chapter'},
            {id:207,title:'25.1 Play The Long Game',type:'section'},{id:208,title:'25.2 Remember Why You Started',type:'section'},
            {id:209,title:'25.3 The Never-Ending Journey',type:'section'},{id:210,title:'25.4 Evolution of Practice',type:'section'},
            {id:211,title:'Chapter 26: Passing The Torch',type:'chapter'},
            {id:212,title:'26.1 Teaching Others (Pull Request Philosophy)',type:'section'},{id:213,title:'26.2 Building Community',type:'section'},
            {id:214,title:'26.3 The Next Generation',type:'section'},{id:215,title:'26.4 Creating Your Legacy',type:'section'},
            {id:216,title:'Chapter 27: Living the Practice',type:'chapter'},
            {id:217,title:'27.1 Embodying The Practice',type:'section'},{id:218,title:'27.2 Move Beyond Your Limits',type:'section'},
            {id:219,title:'27.3 The Eternal Student',type:'section'},{id:220,title:'27.4 Final Wisdom',type:'section'},
        ];
        // v2 = condensed view (parts + chapters only)
        S.tocs.v2 = S.tocs.v1.filter(i => i.type !== 'section').map((i,idx) => ({...i, id:idx+1}));
        initTOC();
    }

    const defaultStageNames = { 0:'Mobility & Preparation', 1:'Creating the Base', 2:'Building the Structure', 3:'Continuous Mastering' };
    if (!S.stageNames) S.stageNames = {...defaultStageNames};
    const stageNames = S.stageNames;

    function editStageName(stageNum) {
        const current = stageNames[stageNum] || '';
        const newName = prompt('Stage ' + stageNum + ' name:', current);
        if (newName !== null && newName !== current) {
            stageNames[stageNum] = newName;
            save();
            // Refresh taxonomy if visible
            if (S.tab === 'taxonomy') renderTaxonomy();
        }
    }

    function loadTOC(side) {
        const v = document.getElementById('toc-v-'+side).value;
        const el = document.getElementById('toc-'+side);
        document.getElementById('toc-'+side+'-label').textContent = 'TOC '+v;
        const items = S.tocs[v] || [];
        const typeLabel = t => t==='part'?'PART':t==='section'?'SEC':'CH';
        // Build movement link map from matrix TOC anchors
        const movLinks = {};
        if (S.matrixData && S.matrixData.edges) {
            S.matrixData.edges.filter(e => e.transfer === 'ANCHORS_TO').forEach(e => {
                const src = S.matrixData.nodes.find(n => String(n.id) === String(e.source));
                const tgt = S.matrixData.nodes.find(n => String(n.id) === String(e.target));
                if (src && src.type === 'TOC' && tgt) {
                    const key = (src.name||'').toLowerCase();
                    if (!movLinks[key]) movLinks[key] = [];
                    movLinks[key].push(tgt.name || tgt.id);
                }
            });
        }
        // Flat list with data-driven collapse (no DOM nesting = clean drag-and-drop)
        const collapseState = S._tocCollapse || {};
        let currentPartId = null;
        let currentChapterId = null;
        // Determine which items have children (for chevrons)
        const hasChildren = {};
        items.forEach((item, idx) => {
            if (item.type === 'part') {
                const next = items[idx+1];
                if (next && next.type !== 'part') hasChildren[item.id] = true;
            } else if (item.type === 'chapter') {
                const next = items[idx+1];
                if (next && next.type === 'section') hasChildren[item.id] = true;
            }
        });
        let html = '';
        items.forEach((i, idx) => {
            const linked = movLinks[(i.title||'').toLowerCase()] || [];
            const badges = linked.length ? `<div class="movement-badges">${linked.slice(0,3).map(m=>`<span class="movement-badge">${m}</span>`).join('')}${linked.length>3?`<span class="movement-badge">+${linked.length-3}</span>`:''}</div>` : '';
            const typeClass = i.type==='part'?'is-part':i.type==='section'?'is-section':'is-chapter';
            // Track parent for collapse
            if (i.type === 'part') { currentPartId = i.id; currentChapterId = null; }
            else if (i.type === 'chapter') { currentChapterId = i.id; }
            // Determine if this item should be hidden (parent collapsed)
            // Default: Parts collapsed, Chapters collapsed — drill-in navigation
            let hiddenClass = '';
            if (i.type === 'chapter' && currentPartId) {
                if (collapseState['p_'+currentPartId] !== false) hiddenClass = 'toc-collapsed-child';
            } else if (i.type === 'section') {
                if (currentPartId && collapseState['p_'+currentPartId] !== false) hiddenClass = 'toc-collapsed-child';
                else if (currentChapterId && collapseState['ch_'+currentChapterId] !== false) hiddenClass = 'toc-collapsed-child';
            }
            // Chevron for parts and chapters with children
            let chevron = '';
            if (i.type === 'part' && hasChildren[i.id]) {
                const isCollapsed = collapseState['p_'+i.id] !== false;
                chevron = `<span class="toc-chevron ${isCollapsed?'collapsed':''}" onclick="event.stopPropagation();toggleTOCCollapse(this,'p_${i.id}','${side}')">&#9654;</span>`;
            } else if (i.type === 'chapter' && hasChildren[i.id]) {
                const isCollapsed = collapseState['ch_'+i.id] !== false;
                chevron = `<span class="toc-chevron ${isCollapsed?'collapsed':''}" onclick="event.stopPropagation();toggleTOCCollapse(this,'ch_${i.id}','${side}')">&#9654;</span>`;
            }
            html += `
                <div class="toc-item ${typeClass} ${hiddenClass}" data-id="${i.id}" data-type="${i.type}">
                    ${chevron}
                    <span class="type-tag">${typeLabel(i.type)}</span>
                    <div style="flex:1;display:flex;flex-direction:column;gap:2px">
                        <span class="title" ondblclick="editTOCItem(${i.id},'${side}')">${i.title}</span>
                        ${badges}
                    </div>
                    <button class="btn btn-sm" onclick="delTOCItem(${i.id},'${side}')" style="color:var(--accent-danger);padding:2px 6px" title="Delete">&times;</button>
                </div>`;
        });
        el.innerHTML = html;
        new Sortable(el, { animation:150, ghostClass:'ghost', chosenClass:'drag-chosen', draggable:'.toc-item', onEnd:()=>{reorderTOCFromDOM(side); save();} });
    }
    function toggleTOCCollapse(chevron, key, side) {
        if (!S._tocCollapse) S._tocCollapse = {};
        const isCollapsed = chevron.classList.contains('collapsed');
        const nowCollapsed = !isCollapsed;
        chevron.classList.toggle('collapsed');
        S._tocCollapse[key] = nowCollapsed;
        // Toggle visibility of child items in flat list
        const item = chevron.closest('.toc-item');
        const isPart = key.startsWith('p_');
        let sibling = item.nextElementSibling;
        let currentChId = null;
        while (sibling) {
            const type = sibling.dataset.type;
            if (isPart) {
                // Part collapse: hide/show chapters and sections until next part
                if (type === 'part') break;
                if (nowCollapsed) {
                    sibling.classList.add('toc-collapsed-child');
                } else {
                    // Show chapters, but keep sections hidden if their chapter is collapsed
                    if (type === 'chapter') {
                        sibling.classList.remove('toc-collapsed-child');
                        currentChId = sibling.dataset.id;
                    } else if (type === 'section') {
                        const chKey = 'ch_' + currentChId;
                        if (S._tocCollapse[chKey] !== false) sibling.classList.add('toc-collapsed-child');
                        else sibling.classList.remove('toc-collapsed-child');
                    }
                }
            } else {
                // Chapter collapse: hide sections until next chapter or part
                if (type === 'part' || type === 'chapter') break;
                if (nowCollapsed) sibling.classList.add('toc-collapsed-child');
                else sibling.classList.remove('toc-collapsed-child');
            }
            sibling = sibling.nextElementSibling;
        }
        save();
    }

    function reorderTOCFromDOM(side) {
        const v = document.getElementById('toc-v-'+side).value;
        const el = document.getElementById('toc-'+side);
        const ids = [...el.querySelectorAll('.toc-item')].map(d=>parseInt(d.dataset.id)).filter(Boolean);
        const reordered = ids.map(id=>S.tocs[v].find(i=>i.id===id)).filter(Boolean);
        S.tocs[v] = reordered;
    }

    function syncTOCEverywhere() {
        const v1 = S.tocs.v1 || [];
        document.getElementById('k-chapters').textContent = v1.filter(i=>i.type==='chapter').length;
        document.getElementById('k-parts').textContent = v1.filter(i=>i.type==='part').length;
        if (S.tab === 'writing' && quill) initWriting();
        updateTOCAnalytics();
    }

    function compareTOCs() {
        const lv=document.getElementById('toc-v-left').value, rv=document.getElementById('toc-v-right').value;
        const li=S.tocs[lv]||[], ri=S.tocs[rv]||[];
        const leftItems = document.getElementById('toc-left').querySelectorAll('.toc-item');
        const rightItems = document.getElementById('toc-right').querySelectorAll('.toc-item');
        // Clear all mismatch first
        leftItems.forEach(el => el.classList.remove('mismatch'));
        rightItems.forEach(el => el.classList.remove('mismatch'));
        // Normalize: lowercase, trim, strip "part X:", "chapter X:", numbering prefixes
        const norm = s => s.toLowerCase().trim().replace(/^(part|chapter|section)\s*\d*[\s:—\-.]*/i,'').trim();
        const leftNorms = li.map(i => norm(i.title));
        const rightNorms = ri.map(i => norm(i.title));
        // Match if exact, substring, or keyword overlap
        function hasMatch(title, otherNorms) {
            const n = norm(title);
            if (!n) return true; // empty titles always match
            return otherNorms.some(o => n === o || n.includes(o) || o.includes(n));
        }
        // Mark left items not found in right
        li.forEach((item,idx) => { if (!hasMatch(item.title, rightNorms) && leftItems[idx]) leftItems[idx].classList.add('mismatch'); });
        // Mark right items not found in left
        ri.forEach((item,idx) => { if (!hasMatch(item.title, leftNorms) && rightItems[idx]) rightItems[idx].classList.add('mismatch'); });
    }

    function addChapter(side) {
        const v=document.getElementById('toc-v-'+side).value, title=prompt('Title:');
        if(!title) return;
        const typeChoice = prompt('Type? Enter: part, chapter, or section','chapter');
        const type = ['part','chapter','section'].includes(typeChoice) ? typeChoice : 'chapter';
        S.tocs[v].push({id:Date.now(), title, type}); loadTOC(side); syncTOCEverywhere(); save();
    }
    function editTOCItem(id,side) {
        const v=document.getElementById('toc-v-'+side).value, item=S.tocs[v].find(i=>i.id===id);
        const t=prompt('Edit title:',item.title); if(t && t!==item.title){item.title=t; loadTOC(side); syncTOCEverywhere(); save();}
    }
    function delTOCItem(id,side) {
        if(!confirm('Delete this item? This cannot be undone.')) return;
        const v=document.getElementById('toc-v-'+side).value;
        S.tocs[v]=S.tocs[v].filter(i=>i.id!==id); loadTOC(side); syncTOCEverywhere(); save();
    }
    function addTOCVersion() {
        const n=prompt('Version (e.g. v3):'); if(!n||S.tocs[n]) return;
        S.tocs[n]=[]; ['toc-v-left','toc-v-right'].forEach(id=>{
            document.getElementById(id).innerHTML+=`<option value="${n}">TOC ${n}</option>`;
        }); save();
    }
    function exportTOC() {
        const v=document.getElementById('toc-v-left').value;
        dl(`toc-${v}.json`, JSON.stringify(S.tocs[v],null,2), 'application/json');
    }

    function buildTOCText(v) {
        const items = S.tocs[v] || [];
        let md = '# THE ART OF CALISTHENICS — TABLE OF CONTENTS\n';
        md += `# Version: ${v}\n\n`;
        items.forEach(i => {
            if (i.type === 'part') md += `\n## ${i.title}\n\n`;
            else if (i.type === 'chapter') md += `### ${i.title}\n\n`;
            else if (i.type === 'section') md += `- ${i.title}\n`;
        });
        return md;
    }

    function exportTOCMarkdown() {
        const v = document.getElementById('toc-v-left').value;
        dl(`TOC-${v}.md`, buildTOCText(v), 'text/markdown');
    }

    function exportTOCWord() {
        const v = document.getElementById('toc-v-left').value;
        const items = S.tocs[v] || [];
        let html = '';
        items.forEach(i => {
            if (i.type === 'part') html += `<h1 style="color:#333;border-bottom:2px solid #ccc;padding-bottom:8px;margin-top:24px">${i.title}</h1>`;
            else if (i.type === 'chapter') html += `<h2 style="color:#555;margin-top:16px">${i.title}</h2>`;
            else if (i.type === 'section') html += `<p style="margin-left:32px;color:#666;font-size:11pt">${i.title}</p>`;
        });
        const wordHtml = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>TOC - The Art of Calisthenics (${v})</title><style>body{font-family:Calibri,sans-serif;line-height:1.6;padding:40px}</style></head><body><div style="text-align:center;margin-bottom:40px"><h1 style="font-size:24pt">THE ART OF CALISTHENICS</h1><p style="font-size:14pt;color:#666">Table of Contents — ${v}</p><p style="font-size:10pt;color:#999">Gabo Saturno | Victory Belt Publishing</p></div>${html}</body></html>`;
        const blob = new Blob(['\ufeff'+wordHtml], {type:'application/msword'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`TOC-${v}.doc`; document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }

    function exportTOCPDF() {
        const v = document.getElementById('toc-v-left').value;
        const items = S.tocs[v] || [];
        const content = [
            { text: 'THE ART OF CALISTHENICS', style: 'bookTitle' },
            { text: `Table of Contents — ${v}`, style: 'subtitle' },
            { text: 'Gabo Saturno | Victory Belt Publishing\n\n', style: 'author' }
        ];
        items.forEach(i => {
            if (i.type === 'part') content.push({ text: i.title, style: 'part' });
            else if (i.type === 'chapter') content.push({ text: i.title, style: 'chapter' });
            else if (i.type === 'section') content.push({ text: i.title, style: 'section' });
        });
        try {
            pdfMake.createPdf({
                content: content,
                styles: {
                    bookTitle: { fontSize: 22, bold: true, alignment: 'center', margin: [0,0,0,8] },
                    subtitle: { fontSize: 14, alignment: 'center', color: '#666', margin: [0,0,0,4] },
                    author: { fontSize: 10, alignment: 'center', color: '#999', margin: [0,0,0,30] },
                    part: { fontSize: 16, bold: true, margin: [0,20,0,6], color: '#222' },
                    chapter: { fontSize: 12, bold: true, margin: [16,8,0,3], color: '#444' },
                    section: { fontSize: 10, margin: [36,2,0,1], color: '#666' }
                }
            }).download(`TOC-${v}.pdf`);
        } catch(e) { alert('PDF export failed'); console.error(e); }
    }

    // WRITING
    let quill=null;
    const writingModes = {
        raw:        { color:'#ef4444', desc:'Unfiltered, stream of consciousness' },
        teacher:    { color:'#22c55e', desc:'Clear, structured, patient' },
        philosopher:{ color:'#3b82f6', desc:'Deep, reflective, questioning' },
        prophet:    { color:'#eab308', desc:'Bold, visionary, declarative' },
        mystic:     { color:'#a855f7', desc:'Poetic, metaphorical, layered' },
        companion:  { color:'#f97316', desc:'Warm, conversational, supportive' },
        confessor:  { color:'#6b7280', desc:'Honest, vulnerable, authentic' },
        rebel:      { color:'#e5e7eb', desc:'Provocative, challenging, sharp' }
    };

    function initWriting() {
        if(!quill) {
            quill=new Quill('#editor',{theme:'snow',modules:{toolbar:[[{'header':[1,2,3,false]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link','blockquote','code-block'],['clean']]},placeholder:'Start writing...'});
            const saved=localStorage.getItem('scc_doc'); if(saved) quill.root.innerHTML=saved;
            quill.on('text-change', updateWordCount);
        }
        const el=document.getElementById('writing-toc'), v=document.getElementById('toc-v-left')?.value||'v1';
        el.innerHTML=(S.tocs[v]||[]).map(i=>`<div style="font-size:11px;padding:6px 8px;cursor:pointer;border-radius:4px;${i.type==='part'?'color:var(--text-primary);font-weight:600':i.type==='section'?'color:var(--text-tertiary);padding-left:28px;font-style:italic;font-size:10px':'color:var(--text-tertiary);padding-left:16px'}" onmouseover="this.style.background='var(--bg-surface)'" onmouseout="this.style.background=''" onclick="selectWritingChapter('${i.title.replace(/'/g,"\\'")}')">${i.title}</div>`).join('');
        // Restore writing mode
        if (S.currentWritingMode) setWritingMode(S.currentWritingMode, true);
        updateWordCount();
    }

    // U1: Writing modes (simplified)
    function setWritingMode(mode, silent) {
        S.currentWritingMode = mode;
        const m = writingModes[mode];
        if (!m) return;
        document.querySelectorAll('.wm-sq').forEach(p => {
            p.classList.toggle('active', p.dataset.mode === mode);
        });
        const status = document.getElementById('wm-status');
        if (status) status.textContent = mode.charAt(0).toUpperCase() + mode.slice(1) + ' — ' + m.desc;
        if (!silent) save();
    }

    // M3: Word count
    function updateWordCount() {
        if (!quill) return;
        const text = quill.getText().trim();
        const wc = text ? text.split(/\s+/).length : 0;
        const display = document.getElementById('wc-display');
        if (display) {
            const target = S._wordTarget || 0;
            if (target > 0) {
                const pct = Math.min(Math.round(wc / target * 100), 100);
                display.textContent = wc.toLocaleString() + ' / ' + target.toLocaleString() + ' words (' + pct + '%)';
                document.getElementById('wc-progress-wrap').style.display = 'block';
                document.getElementById('wc-bar').style.width = pct + '%';
                document.getElementById('wc-target-label').textContent = 'Target: ' + target.toLocaleString() + ' words';
            } else {
                display.textContent = wc.toLocaleString() + ' words';
                document.getElementById('wc-progress-wrap').style.display = 'none';
            }
        }
    }
    function setWordTarget() {
        const current = S._wordTarget || 0;
        const val = prompt('Set word target for this chapter:', current || '3000');
        if (val !== null) {
            S._wordTarget = parseInt(val) || 0;
            save();
            updateWordCount();
        }
    }

    // U2: Writing commands with refinement knobs
    function writingCommand(cmd) {
        const text = quill ? quill.getText().trim() : '';
        if (!text) { alert('No text in editor'); return; }
        const mode = S.currentWritingMode || 'raw';
        const compression = S._compression || 50;
        const technical = S._technical || 50;
        const compressNote = compression > 70 ? 'Be very concise, cut aggressively.' : compression < 30 ? 'Preserve most detail, only cut obvious filler.' : '';
        const techNote = technical > 70 ? 'Use precise technical terminology and cite sources.' : technical < 30 ? 'Keep it conversational and accessible.' : '';
        const refinement = `Compression level: ${compression}%. ${compressNote} Technical depth: ${technical}%. ${techNote}`;
        const prompts = {
            compress: `Act as a professional book editor. Reduce this text by approximately ${Math.max(20, compression-20)}% while preserving all key meaning, arguments, and voice. Writing mode: "${mode}". ${refinement} Return ONLY the edited text.\n\n---\n${text}`,
            expand: `Act as a professional book author. Expand this text by approximately ${Math.max(20, 100-compression)}% by adding relevant details, examples, and depth. Writing mode: "${mode}". ${refinement} Return ONLY the expanded text.\n\n---\n${text}`,
            simplify: `Act as a professional editor. Rewrite at an 8th grade reading level. Shorter sentences, simpler vocabulary, clearer structure. Writing mode: "${mode}". ${refinement} Preserve all key ideas. Return ONLY the simplified text.\n\n---\n${text}`,
            deepen: `Act as a philosophical author. Add philosophical depth — questions, reflections, historical connections, deeper meaning. Writing mode: "${mode}". ${refinement} Return ONLY the deepened text.\n\n---\n${text}`,
            polish: `Act as a Victory Belt Publishing editor. Polish to professional publishing standards. Fix grammar, improve flow, strengthen transitions, ensure consistency. Writing mode: "${mode}". ${refinement} Return ONLY the polished text.\n\n---\n${text}`
        };
        const prompt = prompts[cmd];
        if (!prompt) return;
        // Copy to clipboard and show instructions
        navigator.clipboard.writeText(prompt).then(() => {
            showToast('Prompt copied! Paste in Claude to apply "' + cmd + '"');
        }).catch(() => {
            // Fallback: show in modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay open';
            modal.innerHTML = `<div class="modal" style="width:600px;max-height:80vh;overflow-y:auto"><div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px">${cmd.toUpperCase()} Prompt</div><textarea style="width:100%;height:200px;font-size:11px;line-height:1.5" readonly>${prompt}</textarea><button class="btn btn-primary w-full mt-3" onclick="this.closest('.modal-overlay').remove()">Close</button></div>`;
            document.body.appendChild(modal);
        });
    }
    function togglePreview() {
        const panel = document.getElementById('preview-panel');
        const btn = document.getElementById('preview-toggle');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            panel.innerHTML = quill ? quill.root.innerHTML : '';
            btn.textContent = 'Hide Preview';
            btn.style.color = 'var(--accent-gold)';
        } else {
            panel.style.display = 'none';
            btn.textContent = 'Preview';
            btn.style.color = '';
        }
    }

    function selectWritingChapter(title) {
        document.getElementById('doc-title').value = title;
        S._activeChapterTitle = title;
        // Load saved document for this chapter if any
        const key = 'scc_doc_' + title.replace(/\s+/g,'_').toLowerCase();
        const saved = localStorage.getItem(key);
        if (quill) { quill.root.innerHTML = saved || ''; }
    }
    function saveDocument() {
        const title = document.getElementById('doc-title').value;
        const content = quill ? quill.getText() : '';
        const key = 'scc_doc_' + title.replace(/\s+/g,'_').toLowerCase();
        localStorage.setItem(key, quill.root.innerHTML);
        localStorage.setItem('scc_doc', quill.root.innerHTML);
        // If editing a vault doc, update it
        if (typeof S._editingVaultIdx === 'number' && S.vault?.[S._editingVaultIdx]) {
            S.vault[S._editingVaultIdx].title = title;
            S.vault[S._editingVaultIdx].content = content;
            S.vault[S._editingVaultIdx].date = new Date().toISOString().split('T')[0];
            save();
            showToast('Vault doc updated');
        } else {
            showToast('Saved');
        }
    }
    function exportAs(fmt) {
        if(!quill) initWriting();
        const txt=quill?quill.getText():'', html=quill?quill.root.innerHTML:'', title=document.getElementById('doc-title').value;
        if(fmt==='md') dl(title+'.md','# '+title+'\n\n'+txt,'text/markdown');
        if(fmt==='txt') dl(title+'.txt',txt,'text/plain');
        if(fmt==='html') dl(title+'.html','<!DOCTYPE html><html><head><title>'+title+'</title><style>body{font-family:Georgia,serif;max-width:700px;margin:40px auto;line-height:1.8;padding:20px}</style></head><body>'+html+'</body></html>','text/html');
        if(fmt==='yaml') dl(title+'.yaml','title: "'+title+'"\ncontent: |\n  '+txt.replace(/\n/g,'\n  '),'text/yaml');
        if(fmt==='word') {
            const wordHtml = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Georgia,serif;line-height:1.8}</style></head><body><h1>${title}</h1>${html}</body></html>`;
            const blob = new Blob(['\ufeff'+wordHtml], {type:'application/msword'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=title+'.doc'; document.body.appendChild(a); a.click();
            setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        }
        if(fmt==='pdf') {
            try {
                const docDef = { content: [{ text: title, style: 'header' }, { text: txt, style: 'body' }], styles: { header: { fontSize: 22, bold: true, margin: [0,0,0,20] }, body: { fontSize: 12, lineHeight: 1.8 } } };
                pdfMake.createPdf(docDef).download(title+'.pdf');
            } catch(e) { alert('PDF export requires pdfmake library'); console.error(e); }
        }
    }

    // HTMLS / VISUAL GALLERY
    const tagColors = { Deployed:'var(--accent-success)', Visual:'var(--accent-blue)', Framework:'var(--accent-purple)', Map:'var(--accent-warning)', Exercise:'var(--accent-gold)', TOC:'var(--accent-blue)', Uploaded:'#ff6b35', Infographic:'#00cfff', Custom:'var(--text-tertiary)' };
    let _galleryPreviewFile = null;

    function getFileType(f) {
        if (f.fileType) return f.fileType;
        if (f.path && /\.(png|jpe?g|gif|svg|webp)$/i.test(f.path)) return 'PNG';
        if (f.content && f.content.startsWith('data:image')) return 'PNG';
        return 'HTML';
    }

    function initHTMLs() { buildHTMLTagFilter(); filterHTMLs(); }

    function buildHTMLTagFilter() {
        const tags = [...new Set(S.htmlFiles.map(f => f.tag))].sort();
        const sel = document.getElementById('html-tag-filter');
        if (sel) sel.innerHTML = '<option value="all">All Tags</option>' + tags.map(t => `<option value="${t}">${t} (${S.htmlFiles.filter(f=>f.tag===t).length})</option>`).join('');
        const counts = document.getElementById('html-tag-counts');
        if (counts) counts.textContent = S.htmlFiles.length + ' files · ' + tags.length + ' tags';
    }

    function filterHTMLs() {
        const q = (document.getElementById('html-search')?.value || '').toLowerCase();
        const tag = document.getElementById('html-tag-filter')?.value || 'all';
        const type = document.getElementById('html-type-filter')?.value || 'all';
        let files = S.htmlFiles;
        if (q) files = files.filter(f => f.name.toLowerCase().includes(q) || (f.desc||'').toLowerCase().includes(q));
        if (tag !== 'all') files = files.filter(f => f.tag === tag);
        if (type !== 'all') files = files.filter(f => getFileType(f) === type);
        renderGalleryGrid(files);
        renderHTMLList(files);
    }

    function renderHTMLList(files) {
        document.getElementById('html-list').innerHTML = files.map(f => {
            const ft = getFileType(f);
            const tc = tagColors[f.tag] || 'var(--border-subtle)';
            return `<div class="card" style="padding:8px;cursor:pointer;border-left:3px solid ${tc}" onclick="openGalleryModal(${JSON.stringify(f.id).replace(/"/g,'&quot;')})">
                <div style="font-size:11px;color:var(--text-primary);margin-bottom:2px">${f.name}</div>
                <div style="display:flex;gap:4px;align-items:center">
                    <span class="badge" style="background:${tc}22;color:${tc}">${f.tag}</span>
                    <span style="font-family:var(--font-mono);font-size:8px;color:var(--text-tertiary)">${ft}</span>
                </div>
            </div>`;
        }).join('');
    }

    function renderGalleryGrid(files) {
        const grid = document.getElementById('gallery-grid');
        if (!grid) return;
        if (!files.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-tertiary);font-size:12px">No files match your filters</div>'; return; }
        grid.innerHTML = files.map(f => {
            const ft = getFileType(f);
            const tc = tagColors[f.tag] || 'var(--accent-gold)';
            const isImage = ft === 'PNG';
            const dateStr = f.date || '';
            const desc = f.desc || '';
            // Thumbnail area
            let thumb;
            if (isImage && f.content && f.content.startsWith('data:image')) {
                thumb = `<div style="height:130px;background:#111;border-radius:var(--radius-sm);overflow:hidden;display:flex;align-items:center;justify-content:center"><img src="${f.content}" style="max-width:100%;max-height:130px;object-fit:contain"></div>`;
            } else if (isImage && f.path) {
                thumb = `<div style="height:130px;background:#111;border-radius:var(--radius-sm);overflow:hidden;display:flex;align-items:center;justify-content:center"><img src="${f.path}" style="max-width:100%;max-height:130px;object-fit:contain" onerror="this.outerHTML='<div style=\\'padding:20px;color:var(--text-tertiary);font-size:10px\\'>Image unavailable</div>'"></div>`;
            } else {
                thumb = `<div style="height:130px;background:linear-gradient(135deg,#0f1014 0%,#1a1a1f 100%);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="${tc}" stroke-width="1.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg></div>`;
            }
            return `<div class="panel" style="cursor:pointer;overflow:hidden;transition:all 0.2s;border-color:transparent" onclick="openGalleryModal(${JSON.stringify(f.id).replace(/"/g,'&quot;')})" onmouseenter="this.style.borderColor='${tc}'" onmouseleave="this.style.borderColor='transparent'">
                ${thumb}
                <div style="padding:10px 12px">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                        <span style="font-family:var(--font-mono);font-size:8px;padding:2px 5px;border-radius:3px;background:${isImage?'rgba(0,207,255,0.12)':'rgba(168,85,247,0.12)'};color:${isImage?'var(--accent-blue)':'var(--accent-purple)'};text-transform:uppercase;letter-spacing:0.5px">${ft}</span>
                        <span class="badge" style="background:${tc}22;color:${tc}">${f.tag}</span>
                    </div>
                    <div style="font-size:12px;font-weight:500;color:var(--text-primary);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div>
                    ${desc ? `<div style="font-size:10px;color:var(--text-tertiary);margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${desc}</div>` : ''}
                    ${dateStr ? `<div style="font-family:var(--font-mono);font-size:8px;color:var(--text-tertiary)">${dateStr}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    function openGalleryModal(id) {
        const f = S.htmlFiles.find(x => x.id === id);
        if (!f) return;
        _galleryPreviewFile = f;
        const ft = getFileType(f);
        const isImage = ft === 'PNG';
        document.getElementById('gallery-preview-title').textContent = f.name;
        const typeBadge = document.getElementById('gallery-preview-type');
        typeBadge.textContent = ft;
        typeBadge.style.background = isImage ? 'rgba(0,207,255,0.12)' : 'rgba(168,85,247,0.12)';
        typeBadge.style.color = isImage ? 'var(--accent-blue)' : 'var(--accent-purple)';
        const body = document.getElementById('gallery-preview-body');
        if (isImage) {
            const src = (f.content && f.content.startsWith('data:image')) ? f.content : (f.path || '');
            body.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#0a0a0c;overflow:auto"><img src="${src}" style="max-width:100%;max-height:100%;object-fit:contain"></div>`;
        } else if (f.path) {
            body.innerHTML = `<iframe src="${f.path}" style="width:100%;height:100%;border:none"></iframe>`;
        } else if (f.content) {
            body.innerHTML = `<iframe srcdoc="${f.content.replace(/"/g,'&quot;')}" style="width:100%;height:100%;border:none"></iframe>`;
        } else {
            body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;font-family:sans-serif"><div style="text-align:center"><h2>${f.name}</h2><p style="font-size:12px;opacity:.6">${f.tag} | No preview available</p></div></div>`;
        }
        document.getElementById('gallery-preview-modal').classList.add('open');
    }

    function closeGalleryPreview() {
        document.getElementById('gallery-preview-modal').classList.remove('open');
        document.getElementById('gallery-preview-body').innerHTML = '';
        _galleryPreviewFile = null;
    }

    function openGalleryExternal() {
        if (!_galleryPreviewFile) return;
        const f = _galleryPreviewFile;
        if (f.path) { window.open(f.path, '_blank'); return; }
        if (f.content) {
            const isImg = f.content.startsWith('data:image');
            const blob = isImg ? null : new Blob([f.content], { type: 'text/html' });
            if (isImg) { const w = window.open(); w.document.write(`<img src="${f.content}" style="max-width:100%">`); }
            else { const url = URL.createObjectURL(blob); window.open(url, '_blank'); }
        }
    }

    function addHTML() {
        const name = prompt('File name:'); if (!name) return;
        const tag = prompt('Tag (e.g. Deployed, Visual, Exercise):') || 'Custom';
        const path = prompt('URL or path (leave empty for local):') || '';
        const desc = prompt('Short description (optional):') || '';
        const now = new Date().toISOString().slice(0, 10);
        S.htmlFiles.push({ id: Date.now(), name, tag, path, desc, date: now });
        initHTMLs(); save();
    }

    function handleHTMLUpload(event) {
        const files = event.target.files;
        if (!files || !files.length) return;
        const now = new Date().toISOString().slice(0, 10);
        Array.from(files).forEach(file => {
            const isImage = /\.(png|jpe?g|gif|svg|webp)$/i.test(file.name);
            const reader = new FileReader();
            reader.onload = function(ev) {
                const content = ev.target.result;
                const name = file.name.replace(/\.\w+$/, '');
                const tag = isImage ? 'Infographic' : 'Uploaded';
                const fileType = isImage ? 'PNG' : 'HTML';
                S.htmlFiles.push({ id: Date.now() + Math.random(), name, tag, path: '', content, desc: '', date: now, fileType });
                initHTMLs(); save();
            };
            if (isImage) reader.readAsDataURL(file);
            else reader.readAsText(file);
        });
        event.target.value = '';
    }

    // RESEARCH
    const catColors={psychology:'#f59e0b',movement:'#3b82f6',neuroscience:'#8b5cf6',training:'#22c55e',biomechanics:'#00cfff',philosophy:'#ff6b35',pedagogy:'#ff4466','Training Science':'#22c55e','Mobility':'#55efc4','Anatomy & Biomechanics':'#00cfff','Training Philosophy':'#a855f7','Philosophy':'#ff6b35','Practical':'#ffeaa7'};

    async function loadExternalResearch() {
        try {
            const r = await fetch('data/research.json');
            const d = await r.json();
            const mapCard = (item, i) => {
                const blocks = item.blocks || {};
                return {
                    id: item.id || i+1,
                    name: item.name || item.title || '',
                    cat: item.cat || item.category || 'movement',
                    tags: item.tags || [],
                    claim: item.claim || '',
                    mechanism: item.mechanism || '',
                    evidence: item.evidence || '',
                    placement: item.placement || '',
                    used: item.used || false,
                    usedIn: item.usedIn || [],
                    blockA: blocks.A || item.blockA || item.core_concept || item.claim || '',
                    blockB: blocks.B || item.blockB || item.supporting_evidence || item.evidence || '',
                    blockC: blocks.C || item.blockC || item.application || item.placement || '',
                    blockD: blocks.D || item.blockD || item.contradictions || ''
                };
            };
            if (Array.isArray(d)) S.research = d.map(mapCard);
            else if (d.cards) S.research = d.cards.map(mapCard);
            populateResearchFilters();
            renderResearch('all');
            save();
        } catch(e) { console.warn('research.json not found, using defaults'); }
    }

    function populateResearchFilters() {
        const cats = [...new Set(S.research.map(r=>r.cat))];
        const sel = document.getElementById('research-filter');
        sel.innerHTML = '<option value="all">All Categories</option>' + cats.map(c=>`<option value="${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</option>`).join('');
    }

    function renderResearch(filter) {
        populateResearchFilters();
        let cards = filter==='all' ? S.research : S.research.filter(c=>c.cat===filter);
        // I4: Usage filter
        const uf = document.getElementById('research-usage-filter');
        if (uf) {
            const uv = uf.value;
            if (uv === 'used') cards = cards.filter(c => c.used);
            else if (uv === 'unused') cards = cards.filter(c => !c.used);
        }
        document.getElementById('research-grid').innerHTML = cards.map(c => {
            const cid = typeof c.id === 'string' ? `'${c.id}'` : c.id;
            const bA = c.blockA || c.claim || '';
            const bB = c.blockB || c.evidence || '';
            const bC = c.blockC || c.placement || '';
            const bD = c.blockD || '';
            const hasBlocks = bA || bB || bC || bD;
            const usedIn = (c.usedIn||[]).join(', ');
            return `
            <div class="research-card ${c.used?'used':''}" id="rc-${c.id}">
                <div class="flex items-center justify-between mb-3" style="cursor:pointer" onclick="toggleResearchExpand('${c.id}')">
                    <div class="flex items-center gap-2">
                        <span class="badge" style="background:${catColors[c.cat]||'#666'}20;color:${catColors[c.cat]||'#666'}">${c.cat}</span>
                        ${c.used ? '<span style="color:var(--accent-success);font-size:14px" title="Used">&#10003;</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${(c.tags||[]).map(t=>`<span style="font-size:8px;color:var(--text-tertiary);border:1px solid var(--border-subtle);padding:1px 4px;border-radius:2px">${t}</span>`).join('')}
                        <span class="collapsible-arrow" id="rc-arrow-${c.id}">&#9660;</span>
                    </div>
                </div>
                <div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:4px">${c.name}</div>
                ${usedIn ? `<div style="font-size:9px;color:var(--accent-success);margin-bottom:8px">Used in: ${usedIn}</div>` : ''}
                <div id="rc-body-${c.id}" style="display:none">
                    ${bA ? `<div class="research-block research-block-a">
                        <div class="flex items-center justify-between"><div class="research-block-label">A - Core Concept</div><button class="btn btn-sm" onclick="copyBlock(${cid},'A')">Copy A</button></div>
                        ${bA}</div>` : ''}
                    ${bB ? `<div class="research-block research-block-b">
                        <div class="flex items-center justify-between"><div class="research-block-label">B - Supporting Evidence</div><button class="btn btn-sm" onclick="copyBlock(${cid},'B')">Copy B</button></div>
                        ${bB}</div>` : ''}
                    ${bC ? `<div class="research-block research-block-c">
                        <div class="flex items-center justify-between"><div class="research-block-label">C - Application</div><button class="btn btn-sm" onclick="copyBlock(${cid},'C')">Copy C</button></div>
                        ${bC}</div>` : ''}
                    ${bD ? `<div class="research-block research-block-d">
                        <div class="flex items-center justify-between"><div class="research-block-label">D - Contradictions</div><button class="btn btn-sm" onclick="copyBlock(${cid},'D')">Copy D</button></div>
                        ${bD}</div>` : ''}
                    ${!hasBlocks ? `<div style="font-size:10px;color:var(--text-tertiary);line-height:1.7">
                        <div><b>Mechanism:</b> ${c.mechanism||''}</div>
                        <div><b>Evidence:</b> ${c.evidence||''}</div>
                        <div><b>Placement:</b> ${c.placement||''}</div>
                    </div>` : ''}
                    <div class="flex gap-2 mt-3">
                        <button class="btn" style="flex:1" onclick="copyCard(${cid})">Copy All</button>
                        <button class="btn" style="flex:1" onclick="toggleUsed(${cid})">${c.used?'Mark Unused':'Mark Used'}</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function toggleResearchExpand(id) {
        const body = document.getElementById('rc-body-' + id);
        const arrow = document.getElementById('rc-arrow-' + id);
        if (!body) return;
        if (body.style.display === 'none') {
            body.style.display = 'block';
            if (arrow) arrow.innerHTML = '&#9650;';
        } else {
            body.style.display = 'none';
            if (arrow) arrow.innerHTML = '&#9660;';
        }
    }

    function toggleUsed(id) {
        const c = S.research.find(x => x.id === id || String(x.id) === String(id));
        if (!c) return;
        c.used = !c.used;
        if (c.used && !c.usedIn) c.usedIn = [];
        if (c.used) {
            const ch = prompt('Used in which chapter? (e.g., Ch1.2)');
            if (ch) { if (!c.usedIn) c.usedIn = []; c.usedIn.push(ch); }
        }
        renderResearch(document.getElementById('research-filter').value);
        save();
    }

    function copyBlock(id, block) {
        const c = S.research.find(x => x.id === id || String(x.id) === String(id));
        if (!c) return;
        const blockMap = { A: c.blockA || c.claim || '', B: c.blockB || c.evidence || '', C: c.blockC || c.placement || '', D: c.blockD || '' };
        navigator.clipboard.writeText(blockMap[block] || '').then(() => showToast('Copied ' + block + ' to clipboard'));
    }

    function copyCard(id) {
        const c = S.research.find(x => x.id === id || String(x.id) === String(id));
        if (!c) return;
        const text = `${c.name}\n\nA - Core Concept: ${c.blockA||c.claim||''}\nB - Supporting Evidence: ${c.blockB||c.evidence||''}\nC - Application: ${c.blockC||c.placement||''}\nD - Contradictions: ${c.blockD||''}`;
        navigator.clipboard.writeText(text).then(() => showToast('Copied card to clipboard'));
    }

    function showToast(msg) {
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-gold);color:#000;padding:8px 16px;border-radius:6px;font-size:11px;font-weight:600;z-index:200;opacity:0;transition:opacity 0.3s';
            document.body.appendChild(toast);
        }
        toast.textContent = msg;
        toast.style.opacity = '1';
        setTimeout(() => { toast.style.opacity = '0'; }, 2000);
    }

    function addResearchCard() {
        const name = prompt('Name:'); if (!name) return;
        const cat = prompt('Category (Training Science/Mobility/Anatomy & Biomechanics/Training Philosophy/Philosophy/Practical):') || 'Training Science';
        const claim = prompt('Core claim (Block A):') || '';
        S.research.push({ id:'RC-'+Date.now(), name, cat, tags:[], claim:'', mechanism:'', evidence:'', placement:'', used:false, usedIn:[], blockA:claim, blockB:'', blockC:'', blockD:'' });
        renderResearch('all'); save();
    }

    // MATRIX
    const stageColors = { 0:'#55efc4', 1:'#74b9ff', 2:'#ffeaa7', 3:'#ff7675' };
    const transferColors = { high:'#55efc4', medium:'#ffeaa7', low:'#ff7675', direct:'#74b9ff' };

    async function loadMatrix() {
        try {
            const res = await fetch('data/movement_matrix.json');
            const data = await res.json();
            S.matrixData = data;
            document.getElementById('k-nodes').textContent = (data.nodes||[]).length;
            buildMatrixFilters(data);
            buildCytoscape(data);
            buildMatrixNodeList();
            save();
        } catch(e) {
            console.warn('movement_matrix.json not found, matrix will be empty');
            document.getElementById('cy-container').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-tertiary);font-size:12px">Load data/movement_matrix.json to populate the graph</div>';
        }
    }

    function buildMatrixFilters(data) {
        if (!data || !data.enums) return;
        const pf = document.getElementById('matrix-pattern-filters');
        const df = document.getElementById('matrix-discipline-filters');
        const tf = document.getElementById('matrix-type-filters');
        // Restore persisted filter state
        const saved = S._matrixFilters || {};
        const isChecked = (type, val) => {
            if (!saved[type]) return true; // default checked
            return saved[type].includes(val);
        };
        if (data.enums.patterns) {
            pf.innerHTML = '<div class="matrix-filter-title">Pattern</div>' + data.enums.patterns.map(p => {
                const v = p.name||p;
                return `<label><input type="checkbox" class="matrix-filter" data-type="pattern" data-val="${v}" ${isChecked('pattern',v)?'checked':''}> ${v}</label>`;
            }).join('');
        }
        if (data.enums.disciplines) {
            df.innerHTML = '<div class="matrix-filter-title">Discipline</div>' + data.enums.disciplines.map(d => {
                const v = d.name||d;
                return `<label><input type="checkbox" class="matrix-filter" data-type="discipline" data-val="${v}" ${isChecked('discipline',v)?'checked':''}> ${v}</label>`;
            }).join('');
        }
        const types = [...new Set((data.nodes||[]).map(n=>n.type).filter(Boolean))];
        if (types.length) {
            tf.innerHTML = '<div class="matrix-filter-title">Node Type</div>' + types.map(t => `<label><input type="checkbox" class="matrix-filter" data-type="type" data-val="${t}" ${isChecked('type',t)?'checked':''}> ${t}</label>`).join('');
        }
        // Also restore stage checkboxes
        document.querySelectorAll('.matrix-filter[data-type="stage"]').forEach(cb => {
            if (saved.stage) cb.checked = saved.stage.includes(cb.dataset.val);
        });
        document.querySelectorAll('.matrix-filter').forEach(cb => {
            cb.onchange = function() {
                persistMatrixFilters();
                applyMatrixFilters();
            };
        });
    }
    function persistMatrixFilters() {
        const state = {};
        ['stage','pattern','discipline','type'].forEach(type => {
            state[type] = [...document.querySelectorAll(`.matrix-filter[data-type="${type}"]:checked`)].map(c => c.dataset.val);
        });
        S._matrixFilters = state;
        save();
    }

    function buildCytoscape(data) {
        if (!data || !data.nodes) return;
        const stColors = {};
        if (data.enums && data.enums.stages) {
            data.enums.stages.forEach(s => { stColors[s.id !== undefined ? s.id : s.name] = s.color || stageColors[s.id] || '#888'; });
        }
        const nodeElements = (data.nodes||[]).map(n => {
            const stage = n.stage !== undefined ? n.stage : 0;
            const color = stColors[stage] || stageColors[stage] || '#888';
            return {
                data: {
                    id: String(n.id), name: n.name||n.label||'', color: color,
                    type: n.type||'', stage: stage, pattern: n.pattern||'',
                    discipline: n.discipline||'', func: n.function||n.func||'',
                    prerequisites: n.prerequisites||[], raw: n
                }
            };
        });
        const trScale = (data.enums && data.enums.transfer_scale) || {};
        const edgeElements = (data.edges||[]).map((e,i) => {
            const tVal = e.transfer || e.type || 'medium';
            const tColor = (trScale[tVal] && trScale[tVal].color) || transferColors[tVal] || 'rgba(255,255,255,0.15)';
            return { data: { id: 'e'+i, source: String(e.source), target: String(e.target), color: tColor, transfer: tVal } };
        });

        if (cy) cy.destroy();
        cy = cytoscape({
            container: document.getElementById('cy-container'),
            elements: [...nodeElements, ...edgeElements],
            style: [
                { selector: 'node', style: { 'label': 'data(name)', 'background-color': 'data(color)', 'color': '#fff', 'text-valign': 'center', 'text-halign': 'center', 'font-size': '8px', 'width': 30, 'height': 30, 'text-outline-color': '#000', 'text-outline-width': 1, 'text-wrap': 'ellipsis', 'text-max-width': '60px' }},
                { selector: 'edge', style: { 'line-color': 'data(color)', 'target-arrow-color': 'data(color)', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'width': 1.5, 'opacity': 0.6 }},
                { selector: 'node:selected', style: { 'border-width': 3, 'border-color': '#ffaa00' }},
                { selector: 'node.highlighted', style: { 'border-width': 3, 'border-color': '#00ff88', 'width': 40, 'height': 40 }},
                { selector: 'node.hidden', style: { 'display': 'none' }},
                { selector: 'edge.hidden', style: { 'display': 'none' }}
            ],
            layout: { name: 'cose', animate: false, nodeRepulsion: function(){ return 8000; }, idealEdgeLength: function(){ return 80; }, padding: 30 }
        });
        cy.on('tap', 'node', function(evt) { showNodeDetail(evt.target.data()); });
        cy.on('tap', function(evt) { if (evt.target === cy) closeNodePanel(); });
    }

    function initMatrix() {
        if (!S.matrixData) loadMatrix();
        else { buildCytoscape(S.matrixData); buildMatrixFilters(S.matrixData); buildMatrixNodeList(); applyMatrixFilters(); }
    }

    function showNodeDetail(d) {
        const panel = document.getElementById('node-detail-panel');
        const content = document.getElementById('node-detail-content');
        const prereqs = (d.prerequisites||[]).map(p => `<span class="prereq-badge">${p}</span>`).join('');
        const connected = [];
        if (cy) {
            const node = cy.getElementById(d.id);
            node.connectedEdges().forEach(edge => {
                const other = edge.source().id() === d.id ? edge.target() : edge.source();
                connected.push(other.data('name'));
            });
        }
        content.innerHTML = `
            <div style="font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:4px;margin-top:20px">${d.name}</div>
            <div class="node-detail-label">ID</div><div class="node-detail-value">${d.id}</div>
            <div class="node-detail-label">Type</div><div class="node-detail-value">${d.type||'N/A'}</div>
            <div class="node-detail-label">Stage</div><div class="node-detail-value"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${d.color};margin-right:6px"></span>Stage ${d.stage}${stageNames[d.stage]?' — '+stageNames[d.stage]:''}</div>
            <div class="node-detail-label">Pattern</div><div class="node-detail-value">${d.pattern||'N/A'}</div>
            <div class="node-detail-label">Discipline</div><div class="node-detail-value">${d.discipline||'N/A'}</div>
            <div class="node-detail-label">Function</div><div class="node-detail-value">${d.func||'N/A'}</div>
            <div class="node-detail-label">Prerequisites</div><div class="node-detail-value">${prereqs||'None'}</div>
            <div class="node-detail-label">Connected Nodes (${connected.length})</div>
            <div class="node-detail-value">${connected.length ? connected.map(c=>`<div style="font-size:10px;padding:3px 0;border-bottom:1px solid var(--border-subtle)">${c}</div>`).join('') : 'None'}</div>
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-subtle)">
                <button class="btn btn-primary w-full" onclick="openAddEdgeModal('${d.id}')">+ Add Relationship</button>
                <button class="btn w-full mt-3" onclick="editNodeInCodex('${d.id}')">Edit in Codex</button>
                <button class="btn w-full mt-3" style="color:var(--accent-danger);border-color:var(--accent-danger)" onclick="deleteMatrixNode('${d.id}')">Delete Node</button>
            </div>
        `;
        panel.classList.add('open');
    }

    function closeNodePanel() {
        document.getElementById('node-detail-panel').classList.remove('open');
    }

    function editNodeInCodex(id) {
        // Switch to taxonomy tab and open inspector for this node
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-taxonomy').classList.add('active');
        document.querySelector('[data-tab="taxonomy"]').classList.add('active');
        S.tab = 'taxonomy';
        initTaxonomy();
        setTimeout(() => openTaxInspector(String(id)), 300);
    }

    function deleteMatrixNode(id) {
        if (!confirm('Delete this node from the matrix? This cannot be undone.')) return;
        if (!S.matrixData) return;
        S.matrixData.nodes = S.matrixData.nodes.filter(n => String(n.id) !== id);
        S.matrixData.edges = S.matrixData.edges.filter(e => String(e.source) !== id && String(e.target) !== id);
        closeNodePanel();
        buildCytoscape(S.matrixData);
        document.getElementById('k-nodes').textContent = S.matrixData.nodes.length;
        save();
    }

    function applyMatrixFilters() {
        if (!cy) return;
        const activeStages = [...document.querySelectorAll('.matrix-filter[data-type="stage"]:checked')].map(c=>c.dataset.val);
        const activePatterns = [...document.querySelectorAll('.matrix-filter[data-type="pattern"]:checked')].map(c=>c.dataset.val);
        const activeDisciplines = [...document.querySelectorAll('.matrix-filter[data-type="discipline"]:checked')].map(c=>c.dataset.val);
        const activeTypes = [...document.querySelectorAll('.matrix-filter[data-type="type"]:checked')].map(c=>c.dataset.val);
        cy.nodes().forEach(node => {
            const d = node.data();
            const stageMatch = activeStages.length === 0 || activeStages.includes(String(d.stage));
            const patternMatch = activePatterns.length === 0 || activePatterns.includes(d.pattern);
            const discMatch = activeDisciplines.length === 0 || activeDisciplines.includes(d.discipline);
            const typeMatch = activeTypes.length === 0 || activeTypes.includes(d.type);
            if (stageMatch && patternMatch && discMatch && typeMatch) node.removeClass('hidden');
            else node.addClass('hidden');
        });
        cy.edges().forEach(edge => {
            if (edge.source().hasClass('hidden') || edge.target().hasClass('hidden')) edge.addClass('hidden');
            else edge.removeClass('hidden');
        });
        const visible = cy.nodes().filter(n => !n.hasClass('hidden')).length;
        const total = cy.nodes().length;
        const fc = document.getElementById('matrix-filter-count');
        if (fc) fc.textContent = 'Showing ' + visible + ' of ' + total + ' nodes';
    }

    function resetMatrixFilters() {
        document.querySelectorAll('.matrix-filter').forEach(cb => { cb.checked = true; });
        if (cy) { cy.nodes().removeClass('hidden'); cy.edges().removeClass('hidden'); }
        S._matrixFilters = {};
        save();
        const fc = document.getElementById('matrix-filter-count');
        if (fc && cy) fc.textContent = 'Showing ' + cy.nodes().length + ' of ' + cy.nodes().length + ' nodes';
    }

    function refitMatrix() {
        if (cy) cy.fit(50);
    }

    // G1-G3: CSV Parser — Rebuild matrix from 4 source CSVs
    async function parseAllCSVs() {
        if (!confirm('Rebuild matrix from CSV source files? This will replace current matrix data.')) return;
        try {
            const parseCSV = text => {
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',');
                return lines.slice(1).map(line => {
                    const vals = line.split(',');
                    const obj = {};
                    headers.forEach((h, i) => obj[h.trim()] = (vals[i]||'').trim());
                    return obj;
                });
            };
            const [csv1, csv2, csv3, csv4] = await Promise.all([
                fetch('data/saturno_7_patterns_complete.csv').then(r=>r.text()),
                fetch('data/saturno_movement_matrix_foundation.csv').then(r=>r.text()),
                fetch('data/saturno_cross_cutting_categories.csv').then(r=>r.text()),
                fetch('data/saturno_notes_to_matrix_integration.csv').then(r=>r.text())
            ]);
            const nodes = [], edges = [];
            // Mobility nodes (foundation)
            parseCSV(csv2).forEach(r => {
                nodes.push({ id:r.id, name:r.name, type:'MOBILITY', stage:parseInt(r.stage)||0, pattern:r.unlocks_pattern||'', target_area:r.target_area||'', function:r.function||'' });
            });
            // Infrastructure nodes (cross-cutting)
            parseCSV(csv3).forEach(r => {
                nodes.push({ id:r.id, name:r.name, type:'INFRASTRUCTURE', stage:parseInt(r.stage)||1, pattern:r.category||'', discipline:'', function:r.function||'' });
                // Prerequisite edges
                (r.prerequisites||'').split(';').filter(Boolean).forEach(p => {
                    edges.push({ source:p, target:r.id, transfer:'STRONG_POSITIVE' });
                });
            });
            // Movement nodes (7 patterns)
            parseCSV(csv1).forEach(r => {
                nodes.push({ id:r.id, name:r.name, type:'MOVEMENT', stage:parseInt(r.stage)||1, pattern:r.pattern||'', discipline:r.discipline||'', function:'', transfer_value:r.transfer_value||'' });
                // Prerequisite edges = progression
                (r.prerequisites||'').split(';').filter(Boolean).forEach(p => {
                    edges.push({ source:p, target:r.id, transfer:r.transfer_value||'STRONG_POSITIVE' });
                });
            });
            // TOC anchor nodes (chapter-to-movement mappings)
            parseCSV(csv4).forEach(r => {
                nodes.push({ id:r.chapter_id, name:r.chapter_title, type:'TOC', stage:-1, pattern:'', discipline:'', function:r.act||'' });
                (r.linked_movement_ids||'').split(';').filter(Boolean).forEach(mid => {
                    if (mid !== 'None') edges.push({ source:r.chapter_id, target:mid, transfer:'ANCHORS_TO' });
                });
            });
            S.matrixData = {
                meta: { title:'Saturno Movement Codex', version:'2.0.0-csv', locked:false, total_nodes:nodes.length, generated:new Date().toISOString().split('T')[0] },
                enums: S.matrixData?.enums || {},
                nodes, edges
            };
            save();
            document.getElementById('k-nodes').textContent = nodes.length;
            alert('Matrix rebuilt from CSV: ' + nodes.length + ' nodes, ' + edges.length + ' edges');
            if (S.tab === 'matrix') initMatrix();
            if (S.tab === 'taxonomy') initTaxonomy();
        } catch(e) { alert('CSV parse failed: ' + e.message); console.error(e); }
    }

    // H1: Add Edge UI — relationship creation
    function openAddEdgeModal(sourceId) {
        if (!S.matrixData) return;
        const nodes = S.matrixData.nodes.filter(n => String(n.id) !== sourceId);
        const src = S.matrixData.nodes.find(n => String(n.id) === sourceId);
        const edgeTypes = ['PROGRESSES_TO','TRANSFERS_TO','REQUIRES','SUPPORTS','ANCHORS_TO'];
        const scales = ['STRONG_POSITIVE','MODERATE_POSITIVE','WEAK_POSITIVE','CONTEXT_DEPENDENT'];
        const modal = document.getElementById('edge-modal');
        if (!modal) return;
        document.getElementById('edge-source-label').textContent = src ? src.name : sourceId;
        document.getElementById('edge-source-id').value = sourceId;
        const tgt = document.getElementById('edge-target');
        tgt.innerHTML = nodes.map(n => `<option value="${n.id}">${n.name||n.id} (${n.type||''})</option>`).join('');
        document.getElementById('edge-type').innerHTML = edgeTypes.map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('edge-scale').innerHTML = scales.map(s => `<option value="${s}">${s}</option>`).join('');
        modal.classList.add('open');
    }
    function closeEdgeModal() { document.getElementById('edge-modal').classList.remove('open'); }
    function saveNewEdge() {
        const src = document.getElementById('edge-source-id').value;
        const tgt = document.getElementById('edge-target').value;
        const type = document.getElementById('edge-type').value;
        const scale = document.getElementById('edge-scale').value;
        if (!src || !tgt) return;
        if (!S.matrixData) return;
        S.matrixData.edges.push({ source:src, target:tgt, transfer:scale, type:type });
        save();
        closeEdgeModal();
        if (cy) buildCytoscape(S.matrixData);
        alert('Edge created: ' + src + ' → ' + tgt);
    }

    function buildMatrixNodeList() {
        if (!S.matrixData || !S.matrixData.nodes) return;
        const list = document.getElementById('matrix-node-list');
        if (!list) return;
        const q = (document.getElementById('matrix-node-search')?.value || '').toLowerCase();
        const nodes = S.matrixData.nodes.filter(n => !q || (n.name||'').toLowerCase().includes(q) || String(n.id).toLowerCase().includes(q));
        list.innerHTML = nodes.slice(0, 50).map(n => `
            <div style="font-size:10px;padding:4px 6px;cursor:pointer;border-radius:3px;color:var(--text-secondary);display:flex;align-items:center;gap:4px"
                 onmouseover="this.style.background='var(--bg-surface)'" onmouseout="this.style.background=''"
                 onclick="focusMatrixNode('${n.id}')">
                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${stageColors[n.stage]||'#888'};flex-shrink:0"></span>
                ${n.name||n.id}
            </div>`).join('');
    }

    function filterMatrixNodeList(e) {
        buildMatrixNodeList();
        // H3: Enter key focuses first matching node in graph
        if (e && e.key === 'Enter') {
            const q = (document.getElementById('matrix-node-search')?.value || '').toLowerCase();
            if (!q || !S.matrixData) return;
            const match = S.matrixData.nodes.find(n => (n.name||'').toLowerCase().includes(q) || String(n.id).toLowerCase().includes(q));
            if (match) focusMatrixNode(String(match.id));
        }
        // Highlight matching nodes in Cytoscape
        if (cy && S.matrixData) {
            const q = (document.getElementById('matrix-node-search')?.value || '').toLowerCase();
            cy.nodes().forEach(node => {
                if (q && ((node.data('name')||'').toLowerCase().includes(q) || node.id().toLowerCase().includes(q))) {
                    node.style('border-width', 4);
                    node.style('border-color', '#ffaa00');
                } else {
                    node.style('border-width', 2);
                    node.style('border-color', node.data('color') || '#888');
                }
            });
        }
    }

    function focusMatrixNode(id) {
        if (!cy) return;
        const node = cy.getElementById(String(id));
        if (node.length) {
            cy.animate({ center: { eles: node }, zoom: 2 }, { duration: 300 });
            node.select();
            showNodeDetail(node.data());
        }
    }

    // TAXONOMY
    function initTaxonomy() {
        if (!S.matrixData) {
            fetch('data/movement_matrix.json').then(r=>r.json()).then(d=>{
                S.matrixData = d;
                buildTaxonomyFilters(d);
                renderTaxonomy();
            }).catch(()=>{
                document.getElementById('tax-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-tertiary)">Load data/movement_matrix.json</td></tr>';
            });
        } else {
            buildTaxonomyFilters(S.matrixData);
            renderTaxonomy();
        }
    }

    function buildTaxonomyFilters(data) {
        if (!data) return;
        const patterns = [...new Set((data.nodes||[]).map(n=>n.pattern).filter(Boolean))];
        const types = [...new Set((data.nodes||[]).map(n=>n.type).filter(Boolean))];
        const disciplines = [...new Set((data.nodes||[]).map(n=>n.discipline).filter(Boolean))];
        const ps = document.getElementById('tax-pattern');
        const ts = document.getElementById('tax-type');
        const ds = document.getElementById('tax-discipline');
        ps.innerHTML = '<option value="all">All Patterns</option>' + patterns.map(p=>`<option value="${p}">${p}</option>`).join('');
        ts.innerHTML = '<option value="all">All Types</option>' + types.map(t=>`<option value="${t}">${t}</option>`).join('');
        if (ds) ds.innerHTML = '<option value="all">All Disciplines</option>' + disciplines.map(d=>`<option value="${d}">${d}</option>`).join('');
    }
    // P3: Sortable columns
    let taxSortCol = null, taxSortAsc = true;
    function sortTaxonomy(col) {
        if (taxSortCol === col) taxSortAsc = !taxSortAsc;
        else { taxSortCol = col; taxSortAsc = true; }
        renderTaxonomy();
    }

    function renderTaxonomy() {
        if (!S.matrixData || !S.matrixData.nodes) return;
        const q = (document.getElementById('tax-search').value||'').toLowerCase();
        const pf = document.getElementById('tax-pattern').value;
        const sf = document.getElementById('tax-stage').value;
        const tf = document.getElementById('tax-type').value;
        const df = document.getElementById('tax-discipline')?.value || 'all';
        let nodes = S.matrixData.nodes.filter(n => {
            if (q && !(n.name||'').toLowerCase().includes(q) && !String(n.id).includes(q)) return false;
            if (pf !== 'all' && n.pattern !== pf) return false;
            if (sf !== 'all' && String(n.stage) !== sf) return false;
            if (tf !== 'all' && n.type !== tf) return false;
            if (df !== 'all' && n.discipline !== df) return false;
            return true;
        });
        // P3: Sort
        if (taxSortCol) {
            nodes.sort((a,b) => {
                let av = a[taxSortCol]||'', bv = b[taxSortCol]||'';
                if (taxSortCol === 'stage') { av = a.stage||0; bv = b.stage||0; return taxSortAsc ? av-bv : bv-av; }
                return taxSortAsc ? String(av).localeCompare(String(bv)) : String(bv).localeCompare(String(av));
            });
        }
        document.getElementById('tax-count').textContent = nodes.length + ' / ' + S.matrixData.nodes.length + ' movements' + (taxSortCol ? ' (sorted: '+taxSortCol+(taxSortAsc?' asc':' desc')+')' : '');
        const stColors = { 0:'#55efc4', 1:'#74b9ff', 2:'#ffeaa7', 3:'#ff7675' };
        const discColors = { 'Bodybuilding':'#3b82f6', 'Power-Free/Statics':'#8b5cf6', 'Freestyle':'#00ff88', 'Street Lifting':'#ff6b35', 'Hand-Balancing':'#ffaa00', 'Mobility':'#00cfff' };
        if (nodes.length === 0) {
            document.getElementById('tax-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-tertiary)">No matching movements found</td></tr>';
            return;
        }
        document.getElementById('tax-tbody').innerHTML = nodes.map(n => {
            const dc = discColors[n.discipline] || '#888';
            const discPill = n.discipline ? `<span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;background:${dc}18;color:${dc};border:1px solid ${dc}30">${n.discipline}</span>` : '';
            return `
            <tr style="cursor:pointer" onclick="openTaxInspector('${String(n.id).replace(/'/g,"\\'")}')">
                <td style="font-family:var(--font-mono);font-size:10px;color:var(--text-tertiary)">${n.id}</td>
                <td style="color:var(--text-primary);font-weight:500">${n.name||''}</td>
                <td>${n.type||''}</td>
                <td>${n.pattern||''}</td>
                <td><span class="stage-dot" style="background:${stColors[n.stage]||'#888'}"></span>Stage ${n.stage!==undefined?n.stage:'?'}${stageNames[n.stage]?' — '+stageNames[n.stage]:''}</td>
                <td>${discPill}</td>
                <td style="font-size:10px">${n.function||n.func||''}</td>
            </tr>`;
        }).join('');
    }

    function openTaxInspector(id) {
        if (!S.matrixData) return;
        const n = S.matrixData.nodes.find(x => String(x.id) === id);
        if (!n) return;
        const panel = document.getElementById('tax-inspector');
        const content = document.getElementById('tax-inspector-content');
        const incoming = (S.matrixData.edges||[]).filter(e => String(e.target) === id).map(e => {
            const src = S.matrixData.nodes.find(x => String(x.id) === String(e.source));
            return src ? src.name : e.source;
        });
        const outgoing = (S.matrixData.edges||[]).filter(e => String(e.source) === id).map(e => {
            const tgt = S.matrixData.nodes.find(x => String(x.id) === String(e.target));
            return tgt ? tgt.name : e.target;
        });
        const stColors = { 0:'#55efc4', 1:'#74b9ff', 2:'#ffeaa7', 3:'#ff7675' };
        const allPatterns = [...new Set((S.matrixData.nodes||[]).map(x=>x.pattern).filter(Boolean))];
        const allTypes = [...new Set((S.matrixData.nodes||[]).map(x=>x.type).filter(Boolean))];
        const allDisciplines = [...new Set((S.matrixData.nodes||[]).map(x=>x.discipline).filter(Boolean))];
        content.innerHTML = `
            <div style="font-size:14px;font-weight:700;color:var(--accent-gold);margin-top:20px;margin-bottom:4px">EDIT NODE</div>
            <div class="node-detail-label">ID</div><div class="node-detail-value" style="font-family:var(--font-mono)">${n.id}</div>
            <div class="node-detail-label">Name</div>
            <input type="text" id="tax-edit-name" value="${(n.name||'').replace(/"/g,'&quot;')}" style="margin-bottom:6px">
            <div class="node-detail-label">Type</div>
            <select id="tax-edit-type" style="margin-bottom:6px">${allTypes.map(t=>`<option value="${t}" ${t===n.type?'selected':''}>${t}</option>`).join('')}</select>
            <div class="node-detail-label">Stage</div>
            <select id="tax-edit-stage" style="margin-bottom:6px">${[0,1,2,3].map(s=>`<option value="${s}" ${s===n.stage?'selected':''}>Stage ${s}${stageNames[s]?' — '+stageNames[s]:''}</option>`).join('')}</select>
            <div class="node-detail-label">Pattern</div>
            <select id="tax-edit-pattern" style="margin-bottom:6px"><option value="">None</option>${allPatterns.map(p=>`<option value="${p}" ${p===n.pattern?'selected':''}>${p}</option>`).join('')}</select>
            <div class="node-detail-label">Discipline</div>
            <select id="tax-edit-discipline" style="margin-bottom:6px"><option value="">None</option>${allDisciplines.map(d=>`<option value="${d}" ${d===n.discipline?'selected':''}>${d}</option>`).join('')}</select>
            <div class="node-detail-label">Function</div>
            <input type="text" id="tax-edit-func" value="${(n.function||n.func||'').replace(/"/g,'&quot;')}" style="margin-bottom:6px">
            <button class="btn btn-primary w-full mt-3" onclick="saveTaxEdit('${id}')">Save Changes</button>
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-subtle)">
                <div class="node-detail-label">Prerequisites</div>
                <div class="node-detail-value">${(n.prerequisites||[]).map(p=>`<span class="prereq-badge">${p}</span>`).join('')||'None'}</div>
                <div class="node-detail-label">Incoming (${incoming.length})</div>
                <div class="node-detail-value">${incoming.length ? incoming.map(c=>`<div style="font-size:10px;padding:3px 0;border-bottom:1px solid var(--border-subtle)">${c}</div>`).join('') : 'None'}</div>
                <div class="node-detail-label">Outgoing (${outgoing.length})</div>
                <div class="node-detail-value">${outgoing.length ? outgoing.map(c=>`<div style="font-size:10px;padding:3px 0;border-bottom:1px solid var(--border-subtle)">${c}</div>`).join('') : 'None'}</div>
            </div>
            <button class="btn w-full mt-3" style="color:var(--accent-danger);border-color:var(--accent-danger)" onclick="if(confirm('Delete this node?')){deleteMatrixNode('${id}');closeTaxInspector();renderTaxonomy();}">Delete Node</button>
        `;
        panel.classList.add('open');
    }

    function saveTaxEdit(id) {
        if (!S.matrixData) return;
        const n = S.matrixData.nodes.find(x => String(x.id) === id);
        if (!n) return;
        n.name = document.getElementById('tax-edit-name').value;
        n.type = document.getElementById('tax-edit-type').value;
        n.stage = parseInt(document.getElementById('tax-edit-stage').value);
        n.pattern = document.getElementById('tax-edit-pattern').value;
        n.discipline = document.getElementById('tax-edit-discipline').value;
        const funcVal = document.getElementById('tax-edit-func').value;
        n.function = funcVal; n.func = funcVal;
        renderTaxonomy();
        save();
        openTaxInspector(id); // Refresh inspector
    }

    function closeTaxInspector() {
        document.getElementById('tax-inspector').classList.remove('open');
    }

    // WORKOUT
    const exStageColors = { 0:'#55efc4', 1:'#74b9ff', 2:'#ffeaa7', 3:'#ff7675' };
    const exStageNames = { 0:'Stage 0 — Mobility', 1:'Stage 1 — Base', 2:'Stage 2 — Structure', 3:'Stage 3 — Mastery' };

    function syncExercisesFromTaxonomy() {
        if (!S.matrixData || !S.matrixData.nodes) return;
        // Build exercises from all matrixData nodes (movements, mobility, infrastructure)
        S.exercises = S.matrixData.nodes.map((n, idx) => ({
            id: n.id || idx + 1,
            name: n.name || n.id,
            pattern: n.pattern || n.category || n.target_area || 'General',
            stage: n.stage !== undefined ? n.stage : '?',
            discipline: n.discipline || '',
            type: n.type || 'MOVEMENT',
            equip: n.equipment || '',
            func: n.function || n.func || ''
        }));
        save();
    }

    function initWorkout() {
        // Sync exercises from taxonomy if available
        if (S.matrixData && S.matrixData.nodes && S.matrixData.nodes.length > S.exercises.length) {
            syncExercisesFromTaxonomy();
        }
        // Populate stage filter
        const sf = document.getElementById('ex-stage-filter');
        if (sf && sf.options.length <= 1) {
            sf.innerHTML = '<option value="all">All Stages</option>' +
                [0,1,2,3].map(s => `<option value="${s}">${exStageNames[s]||'Stage '+s}</option>`).join('');
        }
        // Update exercise count
        const ec = document.getElementById('ex-count');
        if (ec) ec.textContent = '(' + S.exercises.length + ')';
        filterExercises();
        updateSavedWorkoutsList();
        const builder = document.getElementById('workout-builder');
        new Sortable(builder, {
            animation: 150, group: 'exercises', ghostClass: 'ghost',
            onAdd: function(evt) {
                const item = evt.item;
                const name = item.dataset.name || item.querySelector('[style*="color:var(--text-primary)"]')?.textContent?.trim() || item.textContent.trim();
                const tmp = document.createElement('div');
                tmp.innerHTML = buildWoItemHTML(name, 3, 10, 60, '');
                const newItem = tmp.firstElementChild;
                item.replaceWith(newItem);
                updateWorkoutAnalytics();
            }
        });
    }

    function filterExercises() {
        const q = (document.getElementById('ex-search').value||'').toLowerCase();
        const p = document.getElementById('ex-pattern-filter').value;
        const sf = document.getElementById('ex-stage-filter');
        const sv = sf ? sf.value : 'all';
        const filtered = S.exercises.filter(e => {
            if (p !== 'all' && e.pattern !== p) return false;
            if (sv !== 'all' && String(e.stage) !== sv) return false;
            if (q && !(e.name||'').toLowerCase().includes(q)) return false;
            return true;
        });
        const el = document.getElementById('ex-library');
        el.innerHTML = filtered.map(e => {
            const sc = exStageColors[e.stage] || '#888';
            return `<div class="exercise-item" data-id="${e.id}" data-name="${(e.name||'').replace(/"/g,'&quot;')}" style="border-left:3px solid ${sc}">
                <div style="color:var(--text-primary);display:flex;align-items:center;gap:6px">
                    <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></span>
                    ${e.name||e.id}
                </div>
                <div style="font-size:9px;color:var(--text-tertiary);margin-top:2px">${e.pattern||''} ${e.discipline?'| '+e.discipline:''} ${e.type?'| '+e.type:''}</div>
            </div>`;
        }).join('');
        new Sortable(el, {animation:150, group:{name:'exercises',pull:'clone',put:false}, sort:false, ghostClass:'ghost'});
    }

    function exportWorkout() {
        const items = [...document.getElementById('workout-builder').children].map(el => {
            const name = el.dataset.name || el.textContent.trim();
            const sets = el.querySelector('.wo-sets')?.value || '';
            const reps = el.querySelector('.wo-reps')?.value || '';
            const rest = el.querySelector('.wo-rest')?.value || '';
            const tempo = el.querySelector('.wo-tempo')?.value || '';
            const notes = el.querySelector('.wo-notes')?.value || '';
            return { name, sets, reps, rest, tempo, notes };
        }).filter(i => i.name);
        const wname = document.getElementById('workout-name').value || 'workout';
        const csv = 'Exercise,Sets,Reps,Rest,Tempo,Notes\n' + items.map(i => `"${i.name}",${i.sets},${i.reps},${i.rest},"${i.tempo}","${i.notes}"`).join('\n');
        dl(wname + '.csv', csv, 'text/csv');
    }

    function exportWorkoutTxt() {
        const items = [...document.getElementById('workout-builder').children].map(el => {
            const name = el.dataset.name || el.textContent.trim();
            const sets = el.querySelector('.wo-sets')?.value || '';
            const reps = el.querySelector('.wo-reps')?.value || '';
            const rest = el.querySelector('.wo-rest')?.value || '';
            const tempo = el.querySelector('.wo-tempo')?.value || '';
            const notes = el.querySelector('.wo-notes')?.value || '';
            let line = sets ? `${name} — ${sets}x${reps} (${rest}s rest)` : name;
            if (tempo) line += ` @${tempo}`;
            if (notes) line += `  [${notes}]`;
            return line;
        }).filter(Boolean);
        const wname = document.getElementById('workout-name').value || 'workout';
        dl(wname + '.txt', wname + '\n' + '='.repeat(wname.length) + '\n\n' + items.join('\n'), 'text/plain');
    }

    function saveWorkout() {
        const wname = document.getElementById('workout-name').value || 'Workout ' + new Date().toLocaleDateString();
        const items = [...document.getElementById('workout-builder').children].map(el => ({
            name: el.dataset.name || el.textContent.trim(),
            sets: el.querySelector('.wo-sets')?.value || '',
            reps: el.querySelector('.wo-reps')?.value || '',
            rest: el.querySelector('.wo-rest')?.value || '',
            tempo: el.querySelector('.wo-tempo')?.value || '',
            notes: el.querySelector('.wo-notes')?.value || ''
        })).filter(i => i.name);
        if (!S.savedWorkouts) S.savedWorkouts = [];
        S.savedWorkouts.push({ name: wname, items, date: new Date().toISOString() });
        save();
        updateSavedWorkoutsList();
        updateWorkoutAnalytics();
        showToast('Workout "' + wname + '" saved');
    }
    function updateWorkoutAnalytics() {
        const el = document.getElementById('wo-analytics');
        if (!el) return;
        const a = getWorkoutAnalytics();
        if (a.exercises === 0) { el.innerHTML = '<span>Add exercises to see analytics</span>'; return; }
        const pats = Object.entries(a.patterns).map(([p,c]) => `<span style="color:var(--text-primary)">${p}</span>: ${c}`).join(' | ');
        el.innerHTML = `<span>Exercises: <b style="color:var(--text-primary)">${a.exercises}</b></span><span>Sets: <b style="color:var(--text-primary)">${a.totalSets}</b></span><span>Total Reps: <b style="color:var(--text-primary)">${a.totalReps}</b></span><span>Est. Duration: <b style="color:var(--accent-gold)">${a.estDuration} min</b></span><span style="margin-left:auto;font-size:9px">${pats}</span>`;
    }

    function updateSavedWorkoutsList() {
        const sel = document.getElementById('saved-workouts-select');
        if (!sel) return;
        sel.innerHTML = '<option value="">— Saved Workouts —</option>' +
            (S.savedWorkouts||[]).map((w,i) => `<option value="${i}">${w.name}</option>`).join('');
    }

    function getExStageColor(name) {
        const ex = S.exercises.find(e => (e.name||'') === name);
        return ex ? (exStageColors[ex.stage] || '#888') : '#888';
    }
    function buildWoItemHTML(name, sets, reps, rest, tempo, notes) {
        const sc = getExStageColor(name);
        const labelStyle = 'font-family:var(--font-mono);font-size:7px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;text-align:center;line-height:1;margin-bottom:2px';
        const inputStyle = 'width:44px;padding:4px 2px;font-size:11px;text-align:center;font-family:var(--font-mono);background:var(--bg-deep);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-primary)';
        return `
            <div class="exercise-item" data-name="${(name||'').replace(/"/g,'&quot;')}" style="border-left:3px solid ${sc};padding:var(--sp-2) var(--sp-3)">
                <div style="display:flex;align-items:center;gap:var(--sp-2);width:100%">
                    <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></span>
                    <span style="flex:1;color:var(--text-primary);font-size:12px;font-weight:500">${name}</span>
                    <div style="display:flex;gap:6px;align-items:flex-end;flex-shrink:0">
                        <div style="display:flex;flex-direction:column;align-items:center">
                            <span style="${labelStyle}">Sets</span>
                            <input type="number" class="wo-sets" value="${sets||3}" min="1" style="${inputStyle}">
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center">
                            <span style="${labelStyle}">Reps</span>
                            <input type="number" class="wo-reps" value="${reps||10}" min="1" style="${inputStyle}">
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center">
                            <span style="${labelStyle}">Rest</span>
                            <input type="number" class="wo-rest" value="${rest||60}" min="0" step="5" style="${inputStyle}">
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:center">
                            <span style="${labelStyle}">Tempo</span>
                            <input type="text" class="wo-tempo" value="${tempo||''}" placeholder="—" style="${inputStyle};width:52px">
                        </div>
                    </div>
                    <button onclick="this.closest('.exercise-item').remove();updateWorkoutAnalytics()" style="background:none;border:none;color:rgba(255,255,255,0.2);cursor:pointer;font-size:16px;padding:0 4px;line-height:1" title="Remove">&times;</button>
                </div>
                <div style="margin-top:4px;padding-left:18px">
                    <input type="text" class="wo-notes" value="${(notes||'').replace(/"/g,'&quot;')}" placeholder="Notes..." style="width:100%;padding:3px 6px;font-size:10px;background:transparent;border:1px solid transparent;border-radius:3px;color:var(--text-tertiary);font-style:italic;transition:border-color 0.15s" onfocus="this.style.borderColor='var(--border-subtle)';this.style.background='var(--bg-deep)'" onblur="this.style.borderColor='transparent';this.style.background='transparent'">
                </div>
            </div>`;
    }
    function loadSavedWorkout() {
        const sel = document.getElementById('saved-workouts-select');
        if (!sel || sel.value === '') return;
        const w = (S.savedWorkouts||[])[parseInt(sel.value)];
        if (!w) return;
        document.getElementById('workout-name').value = w.name;
        const builder = document.getElementById('workout-builder');
        builder.innerHTML = w.items.map(i => buildWoItemHTML(i.name, i.sets, i.reps, i.rest, i.tempo||'', i.notes||'')).join('');
        updateWorkoutAnalytics();
    }

    // ===== MINDMAP WHITEBOARD =====
    let mmSel = null, mmConn = null, mmConnStyle = 'straight', mmConnDash = false, mmConnNoArr = false, mmArrStyle = 'triangle';
    let mmDrag = null, mmDragOff = {x:0,y:0}, mmResizing = null, mmRszStart = {};
    let mmMultiSel = []; // array of selected node IDs for box-select
    let mmBoxSel = null; // {sx, sy} screen coords where box-select started
    let mmMultiDragData = null; // {offsets: [{id, dx, dy}]} for multi-drag
    let mmBoxSelDone = false; // prevents click from clearing selection right after box-select
    let mmNodeMouseDown = 0; // timestamp guard: prevents canvas click after node mousedown rebuilt DOM
    let mmUndoStack = [], mmRedoStack = [];
    const MM_UNDO_MAX = 50;
    function mmPushUndo() {
        mmUndoStack.push(JSON.stringify(S.mindmap));
        if (mmUndoStack.length > MM_UNDO_MAX) mmUndoStack.shift();
        mmRedoStack = [];
    }
    function mmUndo() {
        if (!mmUndoStack.length) return;
        mmRedoStack.push(JSON.stringify(S.mindmap));
        S.mindmap = JSON.parse(mmUndoStack.pop());
        mmSel = null; mmMultiSel = []; save(); renderMindmap();
    }
    function mmRedo() {
        if (!mmRedoStack.length) return;
        mmUndoStack.push(JSON.stringify(S.mindmap));
        S.mindmap = JSON.parse(mmRedoStack.pop());
        mmSel = null; mmMultiSel = []; save(); renderMindmap();
    }
    let mmCtxPos = {x:0, y:0};
    let mmTool = 'select'; // 'select','hand','shape','line','text','sticky'
    let mmSubShape = 'rectangle', mmStickyColor = '#ffaa00';
    let mmEditing = null;
    let mmPanning = false, mmPanStart = {x:0,y:0,px:0,py:0};
    let mmZoom = 1, mmPanX = 0, mmPanY = 0;
    const MM_ZOOM_MIN = 0.1, MM_ZOOM_MAX = 4;
    let mmGridVisible = false, mmSnapEnabled = false;
    const MM_GRID_SIZE = 20;

    function mmUpdateTransform() {
        const vp = document.getElementById('mm-viewport');
        if (vp) vp.style.transform = `translate(${mmPanX}px,${mmPanY}px) scale(${mmZoom})`;
        const pct = document.getElementById('mm-zoom-pct');
        if (pct) pct.textContent = Math.round(mmZoom * 100) + '%';
        mmDrawGrid();
    }
    function mmScreenToCanvas(clientX, clientY) {
        const cr = document.getElementById('mm-canvas').getBoundingClientRect();
        return { x: (clientX - cr.left - mmPanX) / mmZoom, y: (clientY - cr.top - mmPanY) / mmZoom };
    }

    function renderMindmap() {
        const ns = document.getElementById('mm-nodes'), svg = document.getElementById('mm-svg');
        if (!ns || !svg) return;
        // Arrow marker defs — multiple arrowhead styles
        const ac = 'rgba(255,255,255,0.3)';
        const defs = `<defs>
            <marker id="mm-arr-triangle" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0 0L10 5L0 10z" fill="${ac}"/></marker>
            <marker id="mm-arr-open" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0 0L10 5L0 10" fill="none" stroke="${ac}" stroke-width="1.5"/></marker>
            <marker id="mm-arr-diamond" viewBox="0 0 12 12" refX="12" refY="6" markerWidth="7" markerHeight="7" orient="auto-start-reverse"><path d="M0 6L6 0L12 6L6 12z" fill="${ac}"/></marker>
            <marker id="mm-arr-circle" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><circle cx="5" cy="5" r="4" fill="${ac}"/></marker>
            <marker id="mm-arr" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M0 0L10 5L0 10z" fill="${ac}"/></marker>
        </defs>`;
        let lines = '';
        S.mindmap.edges.forEach((e,idx) => {
            const a = S.mindmap.nodes.find(n=>n.id===e.f), b = S.mindmap.nodes.find(n=>n.id===e.t);
            if (!a || !b) return;
            const sc = 'rgba(255,255,255,0.12)', dash = e.dashed ? ' stroke-dasharray="6 4"' : '';
            const arrId = 'mm-arr-' + (e.arrStyle || 'triangle');
            let markers = '';
            if (e.arrow !== false) markers += ` marker-end="url(#${arrId})"`;
            if (e.bidir) markers += ` marker-start="url(#${arrId})"`;
            if ((e.style||'straight') === 'curved') {
                const cx = (a.x+b.x)/2, cy = Math.min(a.y,b.y) - 50;
                lines += `<path d="M${a.x},${a.y} Q${cx},${cy} ${b.x},${b.y}" fill="none" stroke="${sc}" stroke-width="2"${dash}${markers}/>`;
            } else {
                lines += `<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="${sc}" stroke-width="2"${dash}${markers}/>`;
            }
            if (e.label) {
                const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
                lines += `<text x="${mx}" y="${my-6}" fill="rgba(255,255,255,0.4)" font-size="9" text-anchor="middle" font-family="var(--font-mono)">${e.label}</text>`;
            }
        });
        if (mmConn) lines += '<line id="mm-cprev" x1="0" y1="0" x2="0" y2="0" stroke="var(--accent-gold)" stroke-width="1.5" stroke-dasharray="4 3" opacity="0.6"/>';
        svg.innerHTML = defs + lines;
        // Shape styles
        const shapeS = {
            circle:'border-radius:50%;min-width:80px;padding:20px 12px',
            diamond:'transform:rotate(45deg);min-width:70px;padding:18px 10px',
            hexagon:'clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);min-width:90px;padding:18px 16px',
            pill:'border-radius:50px;padding:10px 20px',
            rectangle:'',
            text:'', sticky:''
        };
        ns.innerHTML = S.mindmap.nodes.map(n => {
            const sh = n.shape||'rectangle', extra = shapeS[sh]||'';
            const rot = sh==='diamond' ? 'transform:rotate(-45deg);display:block' : '';
            const sel = mmMultiSel.includes(n.id) ? ' mm-multi' : mmSel===n.id ? ' mm-selected' : '';
            const sz = (n.w ? 'width:'+n.w+'px;' : '') + (n.h ? 'height:'+n.h+'px;' : '');
            const hasBody = n.body || mmEditing===n.id;
            const bodyW = hasBody ? 'min-width:140px;text-align:left;' : '';
            const isSticky = sh==='sticky', isText = sh==='text';
            const nodeClass = isSticky ? ' mm-sticky-node' : isText ? ' mm-text-node' : '';
            const colorS = isSticky ? `background:${n.color}18;border-color:${n.color}50;color:var(--text-primary)` : `color:${n.color};border-color:${n.color}30`;
            let bodyHtml = '';
            if (mmEditing === n.id) {
                const val = (n.body||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
                bodyHtml = `<textarea class="mm-body-ta" id="mm-bedit-${n.id}" onblur="mmSaveBody(${n.id})" oninput="this.style.height='36px';this.style.height=Math.min(this.scrollHeight,200)+'px'" onkeydown="event.stopPropagation();if(event.key==='Escape'){event.preventDefault();this.blur();}" onmousedown="event.stopPropagation()" onclick="event.stopPropagation()">${val}</textarea>`;
            } else if (n.body) {
                bodyHtml = `<div class="mm-nbody">${n.body.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/\n/g,'<br>')}</div>`;
            }
            const lockCls = n.locked ? ' mm-locked' : '';
            const lockIcon = n.locked ? '<span class="mm-lock">&#128274;</span>' : '';
            return `<div class="mindmap-node${sel}${nodeClass}${lockCls}" data-id="${n.id}" style="left:${n.x-50}px;top:${n.y-18}px;${colorS};${extra};${sz};${bodyW}" onmousedown="mmDown(event,${n.id})" ondblclick="mmDblNode(event,${n.id})" oncontextmenu="mmNodeCtx(event,${n.id})"><span class="mm-ntitle" style="${rot}">${n.text}</span>${bodyHtml}${lockIcon}<span class="mm-del" onclick="event.stopPropagation();mmDelNode(${n.id})">&times;</span><span class="mm-rsz" onmousedown="mmRszDown(event,${n.id})"></span></div>`;
        }).join('');
        if (mmEditing) { const ta = document.getElementById('mm-bedit-'+mmEditing); if(ta && document.activeElement!==ta){ta.focus(); if(ta.value){ta.style.height='36px';ta.style.height=Math.min(ta.scrollHeight,200)+'px';}} }
        mmUpdateTransform();
        updateMindmapList();
    }

    // Selection
    function mmSelect(id) { mmSel = id; renderMindmap(); }
    function mmDeselect() { mmSel = null; mmMultiSel = []; mmConn = null; const c = document.getElementById('mm-canvas'); if(c) c.onmousemove = null; renderMindmap(); }

    // Tool system
    function setMmTool(tool) {
        mmTool = tool;
        if (mmEditing) mmSaveBody(mmEditing);
        if (mmConn) { mmConn=null; const c=document.getElementById('mm-canvas'); if(c) c.onmousemove=null; }
        // Clean up any leftover state from previous tool
        mmPanning = false; mmDrag = null; mmMultiDragData = null; mmBoxSel = null;
        document.querySelectorAll('.mm-tool').forEach(b => b.classList.toggle('active', b.dataset.tool===tool));
        document.getElementById('mm-canvas').dataset.tool = tool;
        // Toggle submenus
        document.querySelectorAll('.mm-tool-sub').forEach(s => s.classList.remove('open'));
        if (tool==='shape') document.getElementById('mm-sub-shape').classList.add('open');
        if (tool==='line') document.getElementById('mm-sub-line').classList.add('open');
        if (tool==='sticky') document.getElementById('mm-sub-sticky').classList.add('open');
        const hints = {select:'Click select \u00b7 Drag to box-select \u00b7 Dbl-click write \u00b7 \u2318Z undo', hand:'Drag to pan canvas \u00b7 Space+drag from any tool', shape:'Click canvas to place shape', line:'Click source node \u2192 Click target', text:'Click canvas to place text', sticky:'Click canvas to place note'};
        const h = document.getElementById('mm-hint'); if(h) h.textContent = hints[tool]||'';
        renderMindmap();
    }
    function mmSetSub(type, val, btn) {
        if (type==='shape') mmSubShape = val;
        if (type==='sticky') mmStickyColor = val;
        btn.closest('.mm-tool-sub').querySelectorAll('.mm-sub-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    function mmSetArr(style, btn) {
        mmArrStyle = style;
        btn.closest('.mm-tool-sub').querySelectorAll('.mm-sub-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    }
    // Canvas mousedown — hand panning, middle-click pan, box-select
    function mmCanvasDown(e) {
        if (e.target.closest('.mindmap-node')) return;
        const isHand = mmTool === 'hand' && e.button === 0;
        const isMiddle = e.button === 1;
        const isSpace = mmSpaceDown && e.button === 0;
        const isSelect = mmTool === 'select' && e.button === 0 && !mmSpaceDown;
        // Pan mode
        if (isHand || isMiddle || isSpace) {
            e.preventDefault();
            const cv = document.getElementById('mm-canvas');
            mmPanning = true;
            mmPanStart = {x:e.clientX, y:e.clientY, px:mmPanX, py:mmPanY};
            cv.style.cursor = 'grabbing';
            document.onmousemove = function(ev) { if(!mmPanning) return; mmPanX=mmPanStart.px+(ev.clientX-mmPanStart.x); mmPanY=mmPanStart.py+(ev.clientY-mmPanStart.y); mmUpdateTransform(); };
            document.onmouseup = function() { mmPanning=false; cv.style.cursor=''; document.onmousemove=null; document.onmouseup=null; };
            return;
        }
        // Box-select mode
        if (isSelect) {
            e.preventDefault();
            const cv = document.getElementById('mm-canvas');
            const cr = cv.getBoundingClientRect();
            mmBoxSel = { sx: e.clientX, sy: e.clientY, moved: false };
            const rect = document.getElementById('mm-sel-rect');
            rect.style.display = 'none';
            document.onmousemove = function(ev) {
                if (!mmBoxSel) return;
                const dx = Math.abs(ev.clientX - mmBoxSel.sx), dy = Math.abs(ev.clientY - mmBoxSel.sy);
                if (!mmBoxSel.moved && dx < 5 && dy < 5) return;
                mmBoxSel.moved = true;
                const cr2 = cv.getBoundingClientRect();
                const x1 = Math.min(ev.clientX, mmBoxSel.sx) - cr2.left;
                const y1 = Math.min(ev.clientY, mmBoxSel.sy) - cr2.top;
                const w = Math.abs(ev.clientX - mmBoxSel.sx);
                const h = Math.abs(ev.clientY - mmBoxSel.sy);
                rect.style.display = 'block';
                rect.style.left = x1 + 'px'; rect.style.top = y1 + 'px';
                rect.style.width = w + 'px'; rect.style.height = h + 'px';
            };
            document.onmouseup = function(ev) {
                document.onmousemove = null; document.onmouseup = null;
                rect.style.display = 'none';
                if (!mmBoxSel || !mmBoxSel.moved) { mmBoxSel = null; return; }
                // Find nodes inside the selection rectangle (in canvas coords)
                const p1 = mmScreenToCanvas(Math.min(ev.clientX, mmBoxSel.sx), Math.min(ev.clientY, mmBoxSel.sy));
                const p2 = mmScreenToCanvas(Math.max(ev.clientX, mmBoxSel.sx), Math.max(ev.clientY, mmBoxSel.sy));
                mmMultiSel = [];
                S.mindmap.nodes.forEach(n => {
                    // Check if node overlaps the selection box
                    const nl = n.x - 50, nt = n.y - 18, nr = n.x + 50, nb = n.y + 18;
                    if (nr >= p1.x && nl <= p2.x && nb >= p1.y && nt <= p2.y) {
                        mmMultiSel.push(n.id);
                    }
                });
                mmBoxSel = null;
                if (mmMultiSel.length) { mmSel = null; mmBoxSelDone = true; renderMindmap(); }
            };
        }
    }
    // Tool placement functions
    function mmPlaceShape(e) {
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        const id = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({id, x:p.x+50, y:p.y+18, text:'Shape', color:'var(--text-primary)', shape:mmSubShape});
        save(); mmSel=id; setMmTool('select'); setTimeout(()=>mmInlineEdit(id),50);
    }
    function mmPlaceText(e) {
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        const id = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({id, x:p.x+50, y:p.y+18, text:'', color:'var(--text-primary)', shape:'text'});
        save(); mmSel=id; setMmTool('select'); setTimeout(()=>mmInlineEdit(id),50);
    }
    function mmPlaceSticky(e) {
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        const id = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({id, x:p.x+50, y:p.y+18, text:'Note', color:mmStickyColor, shape:'sticky', body:''});
        save(); mmSel=id; mmEditing=id; setMmTool('select');
    }
    function mmEditBody(id) {
        if (mmEditing === id) return;
        if (mmEditing) mmSaveBody(mmEditing);
        mmEditing = id; mmSel = id; renderMindmap();
    }
    function mmSaveBody(id) {
        if (mmEditing !== id) return;
        const ta = document.getElementById('mm-bedit-'+id);
        const node = S.mindmap.nodes.find(n=>n.id===id);
        if (ta && node) { node.body = ta.value || ''; save(); }
        mmEditing = null;
    }

    // Node drag (single or multi)
    function mmDown(e, id) {
        if (e.button === 2) return;
        if (e.target.tagName === 'TEXTAREA') return;
        e.stopPropagation();
        mmNodeMouseDown = Date.now();
        if (mmEditing && mmEditing !== id) { mmSaveBody(mmEditing); renderMindmap(); }
        // Line tool: start/finish connection on node click
        if (mmTool === 'line') { if(mmConn && mmConn!==id){mmFinishConn(id);}else{mmStartConn(id,'straight',false,false);} return; }
        if (mmConn && mmConn !== id) { mmFinishConn(id); return; }
        // Multi-drag: if clicking a node that's part of multi-selection
        if (mmTool === 'select' && mmMultiSel.length > 1 && mmMultiSel.includes(id)) {
            e.preventDefault();
            const startMX = e.clientX, startMY = e.clientY;
            let mDragStarted = false;
            const p = mmScreenToCanvas(e.clientX, e.clientY);
            mmMultiDragData = { startX: p.x, startY: p.y, origins: {} };
            mmMultiSel.forEach(nid => {
                const nd = S.mindmap.nodes.find(n=>n.id===nid);
                if (nd) mmMultiDragData.origins[nid] = { x: nd.x, y: nd.y };
            });
            document.onmousemove = function(ev) {
                if (!mDragStarted) {
                    if (Math.abs(ev.clientX - startMX) < 5 && Math.abs(ev.clientY - startMY) < 5) return;
                    mDragStarted = true;
                    mmPushUndo();
                }
                mmMultiMove(ev);
            };
            document.onmouseup = function() { mmMultiDragData=null; mDragStarted=false; document.onmousemove=null; document.onmouseup=null; save(); };
            return;
        }
        // Single click on node: clear multi-select, select single
        if (mmMultiSel.length) mmMultiSel = [];
        mmSelect(id);
        if (mmTool !== 'select') return; // only select tool drags
        mmDrag = S.mindmap.nodes.find(n=>n.id===id);
        if (!mmDrag || mmDrag.locked) { mmDrag=null; return; }
        const startX = e.clientX, startY = e.clientY;
        let dragStarted = false;
        const p0 = mmScreenToCanvas(e.clientX, e.clientY);
        mmDragOff = { x: p0.x - (mmDrag.x - 50), y: p0.y - (mmDrag.y - 18) };
        document.onmousemove = function(ev) {
            if (!dragStarted) {
                if (Math.abs(ev.clientX - startX) < 5 && Math.abs(ev.clientY - startY) < 5) return;
                dragStarted = true;
                mmPushUndo();
            }
            mmMove(ev);
        };
        document.onmouseup = function() { mmDrag=null; dragStarted=false; document.onmousemove=null; document.onmouseup=null; save(); };
    }
    function mmMove(e) {
        if (!mmDrag) return;
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        mmDrag.x = Math.max(50, mmSnap(p.x - mmDragOff.x) + 50);
        mmDrag.y = Math.max(18, mmSnap(p.y - mmDragOff.y) + 18);
        renderMindmap();
    }
    // Multi-drag movement
    function mmMultiMove(e) {
        if (!mmMultiDragData) return;
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        const dx = p.x - mmMultiDragData.startX, dy = p.y - mmMultiDragData.startY;
        mmMultiSel.forEach(nid => {
            const nd = S.mindmap.nodes.find(n=>n.id===nid); if (nd && nd.locked) return;
            const orig = mmMultiDragData.origins[nid];
            if (nd && orig) {
                nd.x = mmSnap(orig.x + dx - 50) + 50;
                nd.y = mmSnap(orig.y + dy - 18) + 18;
            }
        });
        renderMindmap();
    }

    // Resize
    function mmRszDown(e, id) {
        e.stopPropagation(); e.preventDefault();
        const node = S.mindmap.nodes.find(n=>n.id===id); if(!node || node.locked) return;
        mmResizing = node;
        const el = document.querySelector('.mindmap-node[data-id="'+id+'"]');
        mmRszStart = { x:e.clientX, y:e.clientY, w:el.offsetWidth, h:el.offsetHeight };
        document.onmousemove = mmRszMove; document.onmouseup = mmRszUp;
    }
    function mmRszMove(e) {
        if (!mmResizing) return;
        mmResizing.w = Math.max(60, mmRszStart.w + e.clientX - mmRszStart.x);
        mmResizing.h = Math.max(30, mmRszStart.h + e.clientY - mmRszStart.y);
        renderMindmap();
    }
    function mmRszUp() { mmResizing=null; document.onmousemove=null; document.onmouseup=null; save(); }

    // Double-click canvas → new node
    function mmCanvasDblClick(e) {
        if (e.target.closest('.mindmap-node')) return;
        if (Date.now() - mmNodeMouseDown < 300) return;
        if (mmTool === 'hand') return;
        if (mmEditing) mmSaveBody(mmEditing);
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        const id = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({id, x:p.x+50, y:p.y+18, text:'New Node', color:'var(--text-primary)', shape:'rectangle'});
        save(); mmSel = id; mmEditing = id; renderMindmap();
    }
    // Double-click node → edit
    function mmDblNode(e, id) { e.stopPropagation(); mmEditBody(id); }
    function mmInlineEdit(id) {
        const node = S.mindmap.nodes.find(n=>n.id===id); if(!node) return;
        const el = document.querySelector('.mindmap-node[data-id="'+id+'"] > span');
        if (!el) return;
        const inp = document.createElement('input');
        inp.className = 'mm-inline-edit'; inp.value = node.text;
        inp.style.width = Math.max(40,el.offsetWidth)+'px';
        el.innerHTML = ''; el.appendChild(inp); inp.focus(); inp.select();
        inp.onblur = () => { if(!inp.value && node.shape==='text'){mmDelNode(id);return;} node.text = inp.value||'Node'; save(); renderMindmap(); };
        inp.onkeydown = (ev) => { if(ev.key==='Enter') inp.blur(); if(ev.key==='Escape'){inp.value=node.text; inp.blur();} };
    }

    // Delete
    function mmDelNode(id) {
        if (mmEditing===id) mmEditing=null;
        mmPushUndo();
        S.mindmap.nodes = S.mindmap.nodes.filter(n=>n.id!==id);
        S.mindmap.edges = S.mindmap.edges.filter(e=>e.f!==id && e.t!==id);
        if (mmSel===id) mmSel=null; save(); renderMindmap();
    }
    // Canvas click → deselect
    function mmCanvasClick(e) {
        if (e.target.closest('.mindmap-node')) return;
        // Skip if node mousedown just fired (DOM rebuilt, click retargets to canvas)
        if (Date.now() - mmNodeMouseDown < 300) return;
        // Skip if box-select just finished (click fires right after mouseup)
        if (mmBoxSelDone) { mmBoxSelDone = false; return; }
        if (mmEditing) { mmSaveBody(mmEditing); renderMindmap(); return; }
        if (mmTool === 'hand') return;
        if (mmTool === 'shape') { mmPlaceShape(e); return; }
        if (mmTool === 'text') { mmPlaceText(e); return; }
        if (mmTool === 'sticky') { mmPlaceSticky(e); return; }
        if (mmConn) { mmConn=null; document.getElementById('mm-canvas').onmousemove=null; renderMindmap(); }
        else if (mmMultiSel.length) { mmMultiSel = []; renderMindmap(); }
        else mmDeselect();
    }

    // === Context Menus ===
    function mmContextMenu(e) {
        e.preventDefault();
        if (e.target.closest('.mindmap-node')) return;
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        mmCtxPos = { x:p.x+50, y:p.y+18 };
        showMmCtx(e.clientX, e.clientY, [
            {label:'Rectangle', icon:'▬', fn:()=>mmQuickAdd('rectangle')},
            {label:'Circle', icon:'●', fn:()=>mmQuickAdd('circle')},
            {label:'Diamond', icon:'◆', fn:()=>mmQuickAdd('diamond')},
            {label:'Pill', icon:'▰', fn:()=>mmQuickAdd('pill')},
            'sep',
            {label:'Paste from Clipboard', icon:'⎘', fn:mmPasteNode}
        ]);
    }
    function mmNodeCtx(e, id) {
        e.preventDefault(); e.stopPropagation(); mmSelect(id);
        const colors = [{l:'White',v:'var(--text-primary)'},{l:'Gold',v:'#ffaa00'},{l:'Green',v:'#55efc4'},{l:'Blue',v:'#74b9ff'},{l:'Red',v:'#ff7675'},{l:'Purple',v:'#a29bfe'}];
        const node = S.mindmap.nodes.find(n=>n.id===id); if(!node) return;
        showMmCtx(e.clientX, e.clientY, [
            {label:'Edit Text', icon:'✏', fn:()=>mmInlineEdit(id)},
            'sep',
            {label:'Connect → (straight)', icon:'→', fn:()=>mmStartConn(id,'straight',false,false)},
            {label:'Connect ↝ (curved)', icon:'↝', fn:()=>mmStartConn(id,'curved',false,false)},
            {label:'Connect ┄ (dashed)', icon:'┄', fn:()=>mmStartConn(id,'straight',true,false)},
            {label:'Connect ↔ (both ways)', icon:'↔', fn:()=>mmStartConn(id,'straight',false,true)},
            {label:'Connect — (no arrow)', icon:'—', fn:()=>{mmConn=id;mmConnStyle='straight';mmConnDash=false;mmConnNoArr=true;renderMindmap();document.getElementById('mm-canvas').onmousemove=mmConnPreview;}},
            'sep',
            {label:'Arrow: Triangle', icon:'▶', fn:()=>{mmArrStyle='triangle';}},
            {label:'Arrow: Open', icon:'>', fn:()=>{mmArrStyle='open';}},
            {label:'Arrow: Diamond', icon:'◆', fn:()=>{mmArrStyle='diamond';}},
            {label:'Arrow: Dot', icon:'●', fn:()=>{mmArrStyle='circle';}},
            'sep',
            ...colors.map(c=>({label:c.l, icon:'●', iconColor:c.v==='var(--text-primary)'?'#fff':c.v, fn:()=>{node.color=c.v;save();renderMindmap();}})),
            'sep',
            {label:node.locked?'Unlock':'Lock', icon:node.locked?'🔓':'🔒', fn:()=>{node.locked=!node.locked;save();renderMindmap();}},
            {label:'Duplicate', icon:'⧉', fn:()=>mmDupNode(id)},
            {label:'Delete', icon:'✕', fn:()=>mmDelNode(id), danger:true}
        ]);
    }
    function showMmCtx(x, y, items) {
        const m = document.getElementById('mm-ctx');
        m._items = items;
        m.innerHTML = items.map((it,i) => {
            if (it==='sep') return '<div class="mm-ctx-sep"></div>';
            const ic = it.iconColor ? 'color:'+it.iconColor : '';
            const dg = it.danger ? 'color:var(--accent-danger)' : '';
            return `<div class="mm-ctx-item" style="${dg}" onclick="mmCtxRun(${i})"><span style="font-size:12px;width:16px;text-align:center;${ic}">${it.icon||''}</span>${it.label}</div>`;
        }).join('');
        // Position near cursor, clamp to viewport
        m.style.left = Math.min(x, window.innerWidth-180)+'px';
        m.style.top = Math.min(y, window.innerHeight-300)+'px';
        m.classList.add('open');
        setTimeout(()=>{ document.addEventListener('click', closeMmCtx, {once:true}); document.addEventListener('contextmenu', closeMmCtx, {once:true}); },10);
    }
    function mmCtxRun(i) { const m=document.getElementById('mm-ctx'); const it=(m._items||[])[i]; if(it&&it.fn) it.fn(); closeMmCtx(); }
    function closeMmCtx() { document.getElementById('mm-ctx').classList.remove('open'); }

    // Quick add from context menu
    function mmQuickAdd(shape) {
        const id = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({id, x:mmCtxPos.x, y:mmCtxPos.y, text:'New Node', color:'var(--text-primary)', shape});
        save(); mmSel=id; renderMindmap();
        setTimeout(()=>mmInlineEdit(id), 50);
    }

    // Connection drawing
    function mmStartConn(fromId, style, dashed, bidir) {
        mmConn = fromId; mmConnStyle = style||'straight'; mmConnDash = !!dashed; mmConnNoArr = false;
        if (bidir) mmConnNoArr = 'bidir';
        renderMindmap();
        document.getElementById('mm-canvas').onmousemove = mmConnPreview;
    }
    function mmConnPreview(e) {
        const ln = document.getElementById('mm-cprev');
        if (!ln || !mmConn) return;
        const src = S.mindmap.nodes.find(n=>n.id===mmConn); if(!src) return;
        const p = mmScreenToCanvas(e.clientX, e.clientY);
        ln.setAttribute('x1', src.x); ln.setAttribute('y1', src.y);
        ln.setAttribute('x2', p.x); ln.setAttribute('y2', p.y);
    }
    function mmFinishConn(toId) {
        if (!mmConn || mmConn===toId) return;
        const edge = {f:mmConn, t:toId, style:mmConnStyle, arrStyle:mmArrStyle};
        if (mmConnDash) edge.dashed = true;
        if (mmConnNoArr === 'bidir') edge.bidir = true;
        else if (mmConnNoArr) edge.arrow = false;
        mmPushUndo();
        S.mindmap.edges.push(edge);
        mmConn = null; document.getElementById('mm-canvas').onmousemove = null;
        save(); renderMindmap();
    }

    // Duplicate & Paste
    function mmDupNode(id) {
        const n = S.mindmap.nodes.find(nd=>nd.id===id); if(!n) return;
        const nid = Date.now();
        mmPushUndo();
        S.mindmap.nodes.push({...JSON.parse(JSON.stringify(n)), id:nid, x:n.x+30, y:n.y+30});
        mmSel=nid; save(); renderMindmap();
    }
    function mmPasteNode() {
        navigator.clipboard.readText().then(t => {
            if (!t) return;
            const id = Date.now();
            mmPushUndo();
            S.mindmap.nodes.push({id, x:mmCtxPos.x, y:mmCtxPos.y, text:t.slice(0,100), color:'var(--text-primary)', shape:'rectangle'});
            save(); renderMindmap();
        }).catch(()=>{});
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.isContentEditable) return;
        const sec = document.getElementById('sec-mindmap');
        if (!sec || sec.offsetParent === null) return;
        if (!e.ctrlKey && !e.metaKey && !e.altKey) {
            if (e.key==='v') { setMmTool('select'); return; }
            if (e.key==='h') { setMmTool('hand'); return; }
            if (e.key==='r') { setMmTool('shape'); return; }
            if (e.key==='l') { setMmTool('line'); return; }
            if (e.key==='t') { setMmTool('text'); return; }
            if (e.key==='n') { setMmTool('sticky'); return; }
            if (e.key==='Escape') { setMmTool('select'); return; }
            if (e.key==='g') { mmToggleGrid(); return; }
            if (e.key==='s') { mmToggleSnap(); return; }
            if (e.key==='='||e.key==='+') { e.preventDefault(); mmZoomIn(); return; }
            if (e.key==='-') { e.preventDefault(); mmZoomOut(); return; }
            if (e.key==='0') { e.preventDefault(); mmResetZoom(); return; }
            if (e.key==='c') { mmCenterView(); return; }
            if (e.key===' ') { e.preventDefault(); mmSpaceDown=true; document.getElementById('mm-canvas').style.cursor='grab'; return; }
        }
        if ((e.metaKey||e.ctrlKey) && e.key==='z' && !e.shiftKey) { e.preventDefault(); mmUndo(); return; }
        if ((e.metaKey||e.ctrlKey) && (e.key==='z' && e.shiftKey || e.key==='y')) { e.preventDefault(); mmRedo(); return; }
        if ((e.metaKey||e.ctrlKey) && (e.key==='='||e.key==='+')) { e.preventDefault(); mmZoomIn(); return; }
        if ((e.metaKey||e.ctrlKey) && e.key==='-') { e.preventDefault(); mmZoomOut(); return; }
        if ((e.metaKey||e.ctrlKey) && e.key==='0') { e.preventDefault(); mmResetZoom(); return; }
        if ((e.key==='Delete'||e.key==='Backspace') && (mmSel || mmMultiSel.length)) {
            e.preventDefault();
            if (mmMultiSel.length) { mmMultiSel.forEach(nid=>mmDelNode(nid)); mmMultiSel=[]; }
            else if (mmSel) mmDelNode(mmSel);
        }
    });
    let mmSpaceDown = false;
    document.addEventListener('keyup', function(e) {
        if (e.key===' ') { mmSpaceDown=false; const cv=document.getElementById('mm-canvas'); if(cv) cv.style.cursor=''; }
    });

    // Grid rendering — viewport-locked dot grid
    function mmDrawGrid() {
        const gc = document.getElementById('mm-grid');
        if (!gc) return;
        const cv = document.getElementById('mm-canvas');
        // Size canvas to fill viewport
        gc.width = cv.clientWidth;
        gc.height = cv.clientHeight;
        const ctx = gc.getContext('2d');
        ctx.clearRect(0, 0, gc.width, gc.height);
        if (!mmGridVisible) { gc.style.display='none'; return; }
        gc.style.display='block';
        const g = MM_GRID_SIZE;
        const gScreen = g * mmZoom;
        // Skip drawing if zoomed out too far (dots would overlap)
        if (gScreen < 4) return;
        // Calculate grid offset from pan
        const offX = mmPanX % gScreen;
        const offY = mmPanY % gScreen;
        const majorStep = 5;
        const majorScreen = g * majorStep * mmZoom;
        const majorOffX = mmPanX % majorScreen;
        const majorOffY = mmPanY % majorScreen;
        // Minor dots
        ctx.fillStyle = 'rgba(255,255,255,0.07)';
        for (let sx = offX; sx <= gc.width; sx += gScreen) {
            for (let sy = offY; sy <= gc.height; sy += gScreen) {
                ctx.fillRect(Math.round(sx), Math.round(sy), 1, 1);
            }
        }
        // Major dots every 5 cells — brighter + larger
        ctx.fillStyle = 'rgba(255,255,255,0.18)';
        for (let sx = majorOffX; sx <= gc.width; sx += majorScreen) {
            for (let sy = majorOffY; sy <= gc.height; sy += majorScreen) {
                ctx.beginPath();
                ctx.arc(Math.round(sx), Math.round(sy), 1.5, 0, Math.PI*2);
                ctx.fill();
            }
        }
    }
    function mmToggleGrid() {
        mmGridVisible = !mmGridVisible;
        document.getElementById('mm-grid-btn').classList.toggle('active', mmGridVisible);
        mmDrawGrid();
    }
    function mmToggleSnap() {
        mmSnapEnabled = !mmSnapEnabled;
        document.getElementById('mm-snap-btn').classList.toggle('active', mmSnapEnabled);
    }
    function mmSnap(val) { return mmSnapEnabled ? Math.round(val / MM_GRID_SIZE) * MM_GRID_SIZE : val; }

    // Zoom functions
    function mmWheelZoom(e) {
        e.preventDefault();
        // Shift+scroll = horizontal pan
        if (e.shiftKey) { mmPanX -= e.deltaY; mmUpdateTransform(); return; }
        // Trackpad horizontal swipe (deltaX present) = pan both axes
        if (!e.ctrlKey && !e.metaKey && Math.abs(e.deltaX) > 2) {
            mmPanX -= e.deltaX; mmPanY -= e.deltaY; mmUpdateTransform(); return;
        }
        // Pinch (ctrlKey from trackpad) = smooth zoom, plain scroll = zoom
        const cr = document.getElementById('mm-canvas').getBoundingClientRect();
        const mouseX = e.clientX - cr.left, mouseY = e.clientY - cr.top;
        const factor = e.ctrlKey ? (e.deltaY > 0 ? 0.97 : 1.03) : (e.deltaY > 0 ? 0.92 : 1.08);
        const newZoom = Math.min(MM_ZOOM_MAX, Math.max(MM_ZOOM_MIN, mmZoom * factor));
        const scale = newZoom / mmZoom;
        mmPanX = mouseX - scale * (mouseX - mmPanX);
        mmPanY = mouseY - scale * (mouseY - mmPanY);
        mmZoom = newZoom;
        mmUpdateTransform();
    }
    function mmZoomIn() { mmZoomCenter(mmZoom * 1.25); }
    function mmZoomOut() { mmZoomCenter(mmZoom / 1.25); }
    function mmCenterView() {
        const nodes = S.mindmap.nodes||[];
        if (!nodes.length) { mmPanX=0; mmPanY=0; mmUpdateTransform(); return; }
        const cr = document.getElementById('mm-canvas').getBoundingClientRect();
        const cx = nodes.reduce((s,n)=>s+n.x,0)/nodes.length;
        const cy = nodes.reduce((s,n)=>s+n.y,0)/nodes.length;
        mmPanX = cr.width/2 - cx*mmZoom;
        mmPanY = cr.height/2 - cy*mmZoom;
        mmUpdateTransform();
    }
    function mmResetZoom() { mmZoom=1; mmCenterView(); }
    function mmZoomCenter(z) {
        const cr = document.getElementById('mm-canvas').getBoundingClientRect();
        const cx = cr.width/2, cy = cr.height/2;
        const newZoom = Math.min(MM_ZOOM_MAX, Math.max(MM_ZOOM_MIN, z));
        const scale = newZoom / mmZoom;
        mmPanX = cx - scale * (cx - mmPanX);
        mmPanY = cy - scale * (cy - mmPanY);
        mmZoom = newZoom;
        mmUpdateTransform();
    }
    function mmFitView() {
        const nodes = S.mindmap.nodes||[];
        if (!nodes.length) { mmResetZoom(); return; }
        const cr = document.getElementById('mm-canvas').getBoundingClientRect();
        const xs = nodes.map(n=>n.x-50), ys = nodes.map(n=>n.y-18);
        const xMax = nodes.map(n=>n.x+80), yMax = nodes.map(n=>n.y+40);
        const minX=Math.min(...xs), minY=Math.min(...ys), maxX=Math.max(...xMax), maxY=Math.max(...yMax);
        const w=maxX-minX||1, h=maxY-minY||1;
        const pad = 60;
        const zx = (cr.width-pad*2)/w, zy = (cr.height-pad*2)/h;
        mmZoom = Math.min(MM_ZOOM_MAX, Math.max(MM_ZOOM_MIN, Math.min(zx, zy)));
        mmPanX = (cr.width - w*mmZoom)/2 - minX*mmZoom;
        mmPanY = (cr.height - h*mmZoom)/2 - minY*mmZoom;
        mmUpdateTransform();
    }
    // Attach wheel zoom to canvas
    (function() {
        const attach = () => { const cv=document.getElementById('mm-canvas'); if(cv) cv.addEventListener('wheel', mmWheelZoom, {passive:false}); };
        if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', attach); else attach();
    })();

    // Existing utilities (unchanged)
    function clearMindmap() { if(confirm('Clear mindmap?')){S.mindmap={nodes:[],edges:[]}; mmSel=null; renderMindmap(); save();} }
    function exportMindmap(fmt) { dl('mindmap.json',JSON.stringify(S.mindmap,null,2),'application/json'); }

    function exportMindmapPNG() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const nodes = S.mindmap.nodes||[], edges = S.mindmap.edges||[];
        if (!nodes.length) { alert('No nodes to export'); return; }
        const maxX = Math.max(...nodes.map(n=>n.x))+100, maxY = Math.max(...nodes.map(n=>n.y))+100;
        canvas.width = Math.max(maxX,400); canvas.height = Math.max(maxY,300);
        ctx.fillStyle='#0a0a0c'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=2;
        edges.forEach(e => { const a=nodes.find(n=>n.id===e.f),b=nodes.find(n=>n.id===e.t); if(a&&b){ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();} });
        nodes.forEach(n => {
            ctx.fillStyle='#151519'; ctx.strokeStyle=n.color||'#444'; ctx.lineWidth=1;
            ctx.font='12px Sora, sans-serif';
            const w=ctx.measureText(n.text).width+28;
            ctx.beginPath(); ctx.roundRect(n.x-w/2,n.y-15,w,30,6); ctx.fill(); ctx.stroke();
            ctx.fillStyle=n.color||'#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(n.text,n.x,n.y);
        });
        canvas.toBlob(blob => { const u=URL.createObjectURL(blob),a=document.createElement('a'); a.href=u; a.download='mindmap.png'; document.body.appendChild(a); a.click(); setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(u);},100); });
    }

    function exportMindmapSVG() {
        const nodes=S.mindmap.nodes||[], edges=S.mindmap.edges||[];
        if (!nodes.length) { alert('No nodes to export'); return; }
        const maxX=Math.max(...nodes.map(n=>n.x))+120, maxY=Math.max(...nodes.map(n=>n.y))+100;
        let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${maxX}" height="${maxY}" style="background:#0a0a0c">`;
        edges.forEach(e => { const a=nodes.find(n=>n.id===e.f),b=nodes.find(n=>n.id===e.t); if(a&&b){svg+=`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="rgba(255,255,255,0.15)" stroke-width="2"/>`; if(e.label){const mx=(a.x+b.x)/2,my=(a.y+b.y)/2;svg+=`<text x="${mx}" y="${my-6}" fill="rgba(255,255,255,0.4)" font-size="9" text-anchor="middle">${e.label}</text>`;}} });
        nodes.forEach(n => { const w=n.text.length*8+28; svg+=`<rect x="${n.x-w/2}" y="${n.y-15}" width="${w}" height="30" rx="6" fill="#151519" stroke="${n.color||'#444'}" stroke-width="1"/><text x="${n.x}" y="${n.y+4}" fill="${n.color||'#fff'}" font-size="12" text-anchor="middle" font-family="Sora,sans-serif">${n.text}</text>`; });
        svg+='</svg>'; dl('mindmap.svg',svg,'image/svg+xml');
    }

    function saveNamedMindmap() {
        const name = prompt('Save mindmap as:'); if(!name) return;
        if (!S.savedMindmaps) S.savedMindmaps = {};
        S.savedMindmaps[name] = JSON.parse(JSON.stringify(S.mindmap));
        save(); updateMindmapList();
    }
    function loadNamedMindmap() {
        const sel = document.getElementById('mm-saved');
        if (!sel || sel.value === '') return;
        const mm = (S.savedMindmaps||{})[sel.value];
        if (mm) { S.mindmap = JSON.parse(JSON.stringify(mm)); mmSel=null; renderMindmap(); }
    }
    function updateMindmapList() {
        const sel = document.getElementById('mm-saved');
        if (!sel) return;
        const names = Object.keys(S.savedMindmaps || {});
        sel.innerHTML = '<option value="">— Current —</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
    }

    // DECISIONS
    function initDecisions() {
        document.getElementById('k-decisions').textContent=S.decisions.length;
        document.getElementById('decisions-list').innerHTML=S.decisions.map((d,i)=>`
            <div class="card" data-idx="${i}" style="padding:10px;background:var(--bg-deep);cursor:grab;${d.status==='resolved'?'opacity:0.45;':''}">
                <div class="flex items-center justify-between" style="margin-bottom:6px">
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="color:rgba(255,255,255,0.15);font-size:10px;cursor:grab">&#9776;</span>
                        <span onclick="toggleDecision(${i})" style="width:14px;height:14px;border-radius:50%;border:1.5px solid ${d.status==='resolved'?'var(--accent-success)':'var(--border-hover)'};background:${d.status==='resolved'?'var(--accent-success)':'transparent'};cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:8px;color:#fff;flex-shrink:0" title="${d.status==='resolved'?'Mark open':'Mark resolved'}">${d.status==='resolved'?'✓':''}</span>
                        <span class="badge ${d.status==='resolved'?'badge-green':'badge-orange'}">${d.status}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <span style="font-size:9px;color:var(--text-tertiary)">${d.date}</span>
                        <span onclick="deleteDecision(${i})" style="color:rgba(255,255,255,0.2);cursor:pointer;font-size:14px;line-height:1;padding:0 2px" title="Delete">&times;</span>
                    </div>
                </div>
                <div style="font-size:12px;font-weight:600;color:var(--text-primary);${d.status==='resolved'?'text-decoration:line-through;':''}">${d.title}</div>
                <div style="font-size:10px;color:var(--text-tertiary);margin-top:3px">${d.context}</div>
            </div>`).join('');
        document.getElementById('bottlenecks-list').innerHTML=S.bottlenecks.map(b=>`
            <div style="display:flex;align-items:flex-start;gap:8px;padding:6px 4px;border-bottom:1px solid rgba(255,255,255,0.03)">
                <span onclick="toggleNoteStatus(${b.id})" style="width:10px;height:10px;border-radius:50%;background:${b.resolved?'var(--accent-success)':'var(--accent-danger)'};flex-shrink:0;cursor:pointer;margin-top:3px" title="${b.resolved?'Resolved':'Unresolved'} — click to toggle"></span>
                <div style="flex:1;font-size:10px;color:${b.resolved?'var(--text-tertiary)':'var(--text-secondary)'};line-height:1.5;${b.resolved?'text-decoration:line-through;opacity:0.5;':''}">${(b.title||'').replace(/\n/g,'<br>')}</div>
                <span onclick="deleteNote(${b.id})" style="color:rgba(255,255,255,0.15);cursor:pointer;font-size:12px;line-height:1;padding:0 2px" title="Delete">&times;</span>
            </div>`).join('');
        // Init Sortable on both lists
        if (typeof Sortable !== 'undefined') {
            Sortable.create(document.getElementById('decisions-list'), {
                animation: 150, ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    const item = S.decisions.splice(evt.oldIndex, 1)[0];
                    S.decisions.splice(evt.newIndex, 0, item);
                    save();
                }
            });
            // Notes list — no drag needed
        }
    }
    function addDecision() {
        const list = document.getElementById('decisions-list');
        const draft = document.createElement('div');
        draft.className = 'card';
        draft.style.cssText = 'padding:10px;background:var(--bg-deep);border-color:var(--accent-gold)';
        draft.innerHTML = `
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                <span class="badge badge-orange">draft</span>
                <select class="dec-status" style="font-size:9px;padding:2px 4px;background:var(--bg-surface);border:1px solid var(--border-subtle);border-radius:3px;color:var(--text-secondary)">
                    <option value="resolved">Resolved</option>
                    <option value="open">Open</option>
                    <option value="deferred">Deferred</option>
                </select>
                <span style="flex:1"></span>
                <button class="btn btn-sm btn-primary" onclick="lockDecision(this)" style="font-size:9px;padding:2px 8px">Lock</button>
                <button class="btn btn-sm" onclick="this.closest('.card').remove()" style="color:var(--accent-danger);font-size:9px;padding:2px 6px">&times;</button>
            </div>
            <input type="text" class="dec-title" placeholder="Decision..." autofocus style="width:100%;background:transparent;border:none;border-bottom:1px solid var(--border-subtle);color:var(--text-primary);font-size:12px;font-weight:600;padding:4px 0;margin-bottom:4px;outline:none">
            <input type="text" class="dec-context" placeholder="Context / reasoning..." style="width:100%;background:transparent;border:none;border-bottom:1px solid var(--border-subtle);color:var(--text-tertiary);font-size:10px;padding:3px 0;outline:none">`;
        list.prepend(draft);
        draft.querySelector('.dec-title').focus();
    }
    function lockDecision(btn) {
        const card = btn.closest('.card');
        const title = card.querySelector('.dec-title').value.trim();
        if (!title) { card.querySelector('.dec-title').focus(); return; }
        const context = card.querySelector('.dec-context').value.trim();
        const status = card.querySelector('.dec-status').value;
        S.decisions.unshift({id:Date.now(),date:new Date().toISOString().split('T')[0],title,context,status});
        save(); initDecisions();
        showToast('Decision locked');
    }
    function toggleDecision(idx) {
        const d = S.decisions[idx]; if(!d) return;
        d.status = d.status==='resolved' ? 'open' : 'resolved';
        save(); initDecisions();
    }
    function deleteDecision(idx) {
        S.decisions.splice(idx, 1);
        save(); initDecisions();
    }
    function saveNote() {
        const el = document.getElementById('bn-scratchpad');
        const text = (el.value||'').trim();
        if (!text) { el.focus(); return; }
        S.bottlenecks.unshift({id:Date.now(), title:text, resolved:false});
        el.value = '';
        save(); initDecisions();
    }
    function toggleNoteStatus(id) {
        const b = S.bottlenecks.find(n=>n.id===id);
        if (b) { b.resolved = !b.resolved; save(); initDecisions(); }
    }
    function deleteNote(id) {
        S.bottlenecks = S.bottlenecks.filter(n=>n.id!==id);
        save(); initDecisions();
    }
    // resolveBottleneck replaced by toggleNoteStatus/deleteNote

    // BARCODE
    function initBarcode() {
        const presets = [
            { label: 'Saturno Solar System', url: 'https://gabosaturno11.github.io/saturno-solar-system/' },
            { label: 'Command Center', url: window.location.href },
            { label: 'Saturno Movement', url: 'https://saturnomovement.com' }
        ];
        const grid = document.getElementById('qr-presets');
        grid.innerHTML = presets.map(p => `
            <div class="qr-card">
                <div class="qr-label">${p.label}</div>
                <div class="qr-url">${p.url}</div>
                <div class="qr-output" data-url="${p.url}"></div>
            </div>`).join('');
        grid.querySelectorAll('.qr-output').forEach(el => {
            try {
                const qr = kjua({ text: el.dataset.url, size: 200, fill: '#ffaa00', back: '#0a0a0c', rounded: 80 });
                el.appendChild(qr);
            } catch(e) { el.textContent = 'QR generation failed'; }
        });
    }

    function generateCustomQR() {
        const url = document.getElementById('qr-custom-url').value.trim();
        if (!url) return;
        const out = document.getElementById('qr-custom-output');
        out.innerHTML = '';
        try {
            const qr = kjua({ text: url, size: 250, fill: '#ffaa00', back: '#0a0a0c', rounded: 80 });
            out.appendChild(qr);
            const label = document.createElement('div');
            label.style.cssText = 'font-family:var(--font-mono);font-size:9px;color:var(--text-tertiary);margin-top:8px';
            label.textContent = url;
            out.appendChild(label);
        } catch(e) { out.textContent = 'QR generation failed'; }
    }

    // EXPORT TAB
    function initExport() {}

    function exportBundle() {
        const delay = (fn, ms) => setTimeout(fn, ms);
        exportTOCJson();
        delay(() => exportResearchJson(), 300);
        delay(() => { if(S.matrixData) exportMatrixJson(); }, 600);
        delay(() => exportAs('md'), 900);
        delay(() => exportAllState(), 1200);
    }

    function exportTOCJson() {
        dl('toc-all.json', JSON.stringify(S.tocs, null, 2), 'application/json');
    }
    function exportMatrixJson() {
        if (S.matrixData) dl('movement_matrix.json', JSON.stringify(S.matrixData, null, 2), 'application/json');
        else alert('No matrix data loaded');
    }
    function exportMatrixCsv() {
        if (!S.matrixData || !S.matrixData.nodes) { alert('No matrix data loaded'); return; }
        const headers = ['id','name','type','pattern','stage','discipline','function'];
        const rows = S.matrixData.nodes.map(n => headers.map(h => {
            const v = n[h] || n.func || '';
            return '"' + String(v).replace(/"/g, '""') + '"';
        }).join(','));
        dl('movement_matrix.csv', headers.join(',') + '\n' + rows.join('\n'), 'text/csv');
    }
    function exportResearchJson() {
        dl('research.json', JSON.stringify(S.research, null, 2), 'application/json');
    }

    // INTERNAL (S button modal)
    function openInternal() { document.getElementById('internal-modal').classList.add('open'); }
    function closeInternal() { document.getElementById('internal-modal').classList.remove('open'); document.getElementById('internal-pw').value=''; }
    function validateInternal() {
        if(document.getElementById('internal-pw').value===S.pw) { closeInternal(); document.getElementById('internal-section').style.display='block'; updateStorage(); }
        else alert('Invalid');
    }
    function exitInternal() { document.getElementById('internal-section').style.display='none'; }
    function updateStorage() {
        let total=0; for(let k in localStorage) if(localStorage.hasOwnProperty(k)) total+=localStorage[k].length*2;
        const kb = (total/1024).toFixed(1);
        const pct = Math.min(total/(5*1024*1024)*100,100);
        if (document.getElementById('storage-label')) { document.getElementById('storage-label').textContent=kb+' KB'; document.getElementById('storage-bar').style.width=pct+'%'; }
        if (document.getElementById('storage-label-tab')) { document.getElementById('storage-label-tab').textContent=kb+' KB'; document.getElementById('storage-bar-tab').style.width=pct+'%'; }
    }

    // INTERNAL TAB
    function initInternalTab() {
        const locked = document.getElementById('internal-tab-locked');
        const content = document.getElementById('internal-tab-content');
        if (content.style.display === 'block') {
            updateInternalStats();
            return;
        }
        locked.style.display = 'flex';
        content.style.display = 'none';
    }

    function unlockInternalTab() {
        if (document.getElementById('internal-tab-pw').value === S.pw) {
            document.getElementById('internal-tab-locked').style.display = 'none';
            document.getElementById('internal-tab-content').style.display = 'block';
            document.getElementById('internal-tab-pw').value = '';
            updateInternalStats();
        } else {
            alert('Invalid password');
        }
    }

    function lockInternalTab() {
        document.getElementById('internal-tab-locked').style.display = 'flex';
        document.getElementById('internal-tab-content').style.display = 'none';
    }

    function updateInternalStats() {
        updateStorage();
        document.getElementById('build-date').textContent = new Date().toLocaleDateString();
        document.getElementById('int-matrix-nodes').textContent = S.matrixData ? (S.matrixData.nodes||[]).length : 0;
        document.getElementById('int-matrix-edges').textContent = S.matrixData ? (S.matrixData.edges||[]).length : 0;
        document.getElementById('int-research-count').textContent = S.research.length;
        document.getElementById('int-decisions-count').textContent = S.decisions.length;
        const tocCount = Object.values(S.tocs).reduce((sum,arr)=>sum+(Array.isArray(arr)?arr.length:0),0);
        document.getElementById('int-toc-count').textContent = tocCount;
    }

    function importState() { document.getElementById('import-file').click(); }
    function handleImport(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const data = JSON.parse(ev.target.result);
                Object.assign(S, data);
                save();
                alert('State imported successfully. Reloading...');
                location.reload();
            } catch(err) { alert('Invalid JSON file'); }
        };
        reader.readAsText(file);
    }

    // N4: TOC Analytics
    function updateTOCAnalytics() {
        const el = document.getElementById('toc-analytics');
        if (!el) return;
        const v = document.getElementById('toc-v-left')?.value || 'v1';
        const items = S.tocs[v] || [];
        const parts = items.filter(i=>i.type==='part').length;
        const chapters = items.filter(i=>i.type==='chapter').length;
        const sections = items.filter(i=>i.type==='section').length;
        // Coverage: chapters with linked movements
        let linked = 0;
        if (S.matrixData && S.matrixData.nodes) {
            const tocNodes = S.matrixData.nodes.filter(n=>n.type==='TOC');
            linked = tocNodes.length;
        }
        const pct = chapters > 0 ? Math.round(linked / chapters * 100) : 0;
        el.innerHTML = `Parts: <b style="color:var(--accent-gold)">${parts}</b><br>Chapters: <b style="color:var(--text-primary)">${chapters}</b><br>Sections: <b style="color:var(--text-secondary)">${sections}</b><br>Total: <b>${items.length}</b><br>Movement Links: <b style="color:var(--accent-success)">${linked}</b> (${pct}%)`;
    }

    // O1: Workout templates
    const workoutTemplates = [
        { name:'Full Body Foundation', items:[{name:'Push-Up',sets:3,reps:10,rest:60},{name:'Inverted Row',sets:3,reps:10,rest:60},{name:'Squat',sets:3,reps:15,rest:45},{name:'Dip',sets:3,reps:8,rest:60},{name:'Pull-Up',sets:3,reps:6,rest:90},{name:'Hollow Body Hold',sets:3,reps:30,rest:45}] },
        { name:'Push Day', items:[{name:'Push-Up',sets:4,reps:12,rest:60},{name:'Diamond Push-Up',sets:3,reps:10,rest:60},{name:'Dip',sets:3,reps:10,rest:90},{name:'Pike Push-Up',sets:3,reps:8,rest:60},{name:'Pseudo Planche Push-Up',sets:3,reps:6,rest:90}] },
        { name:'Pull Day', items:[{name:'Pull-Up',sets:4,reps:8,rest:90},{name:'Inverted Row',sets:3,reps:12,rest:60},{name:'Tuck Front Lever Row',sets:3,reps:6,rest:90},{name:'Muscle-Up',sets:3,reps:3,rest:120}] },
        { name:'Leg Day', items:[{name:'Squat',sets:4,reps:15,rest:60},{name:'Hip Bridge',sets:3,reps:12,rest:45},{name:'Pistol Squat',sets:3,reps:5,rest:90},{name:'Nordic Curl',sets:3,reps:6,rest:90},{name:'Shrimp Squat',sets:3,reps:5,rest:90}] },
        { name:'Mobility Flow', items:[{name:'Resting Squat',sets:1,reps:60,rest:30},{name:'Forward Fold',sets:1,reps:60,rest:30},{name:'Bridge',sets:3,reps:30,rest:30},{name:'German Hang',sets:3,reps:30,rest:30},{name:'Pancake',sets:1,reps:60,rest:30}] },
        { name:'Core Circuit', items:[{name:'Hollow Body Hold',sets:4,reps:30,rest:30},{name:'L-Sit',sets:4,reps:15,rest:45},{name:'Dragon Flag',sets:3,reps:5,rest:60}] }
    ];

    function loadWorkoutTemplate(idx) {
        const t = workoutTemplates[idx];
        if (!t) return;
        document.getElementById('workout-name').value = t.name;
        const builder = document.getElementById('workout-builder');
        builder.innerHTML = t.items.map(i => buildWoItemHTML(i.name, i.sets, i.reps, i.rest, i.tempo||'', i.notes||'')).join('');
        updateWorkoutAnalytics();
    }

    // O3: Workout analytics
    function getWorkoutAnalytics() {
        const items = [...document.getElementById('workout-builder').children].map(el => ({
            name: el.dataset.name || el.textContent.trim(),
            sets: parseInt(el.querySelector('.wo-sets')?.value) || 0,
            reps: parseInt(el.querySelector('.wo-reps')?.value) || 0,
            rest: parseInt(el.querySelector('.wo-rest')?.value) || 0
        })).filter(i => i.name && i.sets);
        const totalSets = items.reduce((s,i) => s + i.sets, 0);
        const totalReps = items.reduce((s,i) => s + (i.sets * i.reps), 0);
        const totalRest = items.reduce((s,i) => s + (i.sets * i.rest), 0);
        const workTime = items.reduce((s,i) => s + (i.sets * i.reps * 3), 0); // ~3s per rep
        const estDuration = Math.round((workTime + totalRest) / 60);
        // Pattern coverage
        const patterns = {};
        items.forEach(i => {
            const ex = S.exercises.find(e => e.name === i.name);
            if (ex && ex.pattern) patterns[ex.pattern] = (patterns[ex.pattern]||0) + 1;
        });
        return { exercises: items.length, totalSets, totalReps, estDuration, patterns };
    }

    // O4: Enhanced workout export (PDF)
    function exportWorkoutPDF() {
        const items = [...document.getElementById('workout-builder').children].map(el => ({
            name: el.dataset.name || el.textContent.trim(),
            sets: el.querySelector('.wo-sets')?.value || '',
            reps: el.querySelector('.wo-reps')?.value || '',
            rest: el.querySelector('.wo-rest')?.value || '',
            tempo: el.querySelector('.wo-tempo')?.value || '',
            notes: el.querySelector('.wo-notes')?.value || ''
        })).filter(i => i.name);
        const wname = document.getElementById('workout-name').value || 'Workout';
        try {
            const content = [
                { text: wname, style: 'header' },
                { text: 'The Art of Calisthenics — Workout Sheet\n\n', style: 'sub' },
                { table: { headerRows:1, widths:['*','auto','auto','auto','auto','auto'], body: [['Exercise','Sets','Reps','Rest(s)','Tempo','Notes'], ...items.map(i=>[i.name,i.sets,i.reps,i.rest,i.tempo||'—',i.notes||''])] }, layout:'lightHorizontalLines' }
            ];
            pdfMake.createPdf({ content, styles: { header:{fontSize:18,bold:true,margin:[0,0,0,4]}, sub:{fontSize:10,color:'#666',margin:[0,0,0,12]} } }).download(wname+'.pdf');
        } catch(e) { alert('PDF export failed'); }
    }

    // P2: Discipline colors for taxonomy
    const disciplineColors = { 'Bodybuilding':'#3b82f6', 'Power-Free/Statics':'#8b5cf6', 'Freestyle':'#00ff88', 'Street Lifting':'#ff6b35', 'Hand-Balancing':'#ffaa00', 'Mobility':'#00cfff', 'General':'#888' };

    // Q: Knowledge Vault
    function initVault() {
        if (!S.vault) S.vault = [];
        if (!S.vaultFolders) S.vaultFolders = [{id:'all',name:'All Documents'},{id:'drafts',name:'Drafts'},{id:'research',name:'Research'},{id:'reference',name:'Reference'},{id:'notes',name:'Notes'}];
        if (!S.vaultActiveFolder) S.vaultActiveFolder = 'all';
        renderVaultFolders();
        filterVault();
        updateVaultStats();
    }
    function renderVaultFolders() {
        const el = document.getElementById('vault-folders');
        if (!el) return;
        el.innerHTML = (S.vaultFolders||[]).map(f => {
            const count = S.vault.filter(d=>(f.id==='all'||d.folder===f.id)).length;
            const isActive = S.vaultActiveFolder===f.id;
            return `
            <div onclick="selectVaultFolder('${f.id}')" style="display:flex;align-items:center;gap:8px;padding:6px 10px;cursor:pointer;border:1px solid ${isActive?'var(--accent-gold)':'var(--border-subtle)'};border-radius:4px;font-size:10px;margin-bottom:4px;background:${isActive?'rgba(255,170,0,0.08)':'transparent'};transition:all 0.15s" onmouseover="if(!${isActive})this.style.borderColor='var(--border-default)'" onmouseout="if(!${isActive})this.style.borderColor='var(--border-subtle)'">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="${isActive?'var(--accent-gold)':'currentColor'}" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:${isActive?'var(--accent-gold)':'var(--text-secondary)'}">${f.name}</span>
                <span style="font-size:8px;color:var(--text-tertiary);min-width:12px;text-align:right">${count}</span>
            </div>`;
        }).join('');
    }
    function selectVaultFolder(id) {
        S.vaultActiveFolder = id;
        renderVaultFolders();
        filterVault();
    }
    function addVaultFolder() {
        const name = prompt('Folder name:');
        if (!name) return;
        if (!S.vaultFolders) S.vaultFolders = [];
        S.vaultFolders.push({id:'f-'+Date.now(),name:name});
        save(); renderVaultFolders();
    }
    function updateVaultStats() {
        const el = document.getElementById('vault-stats');
        if (el) el.textContent = (S.vault||[]).length + ' docs';
    }
    function filterVault() {
        if (!S.vault) S.vault = [];
        const q = (document.getElementById('vault-search')?.value||'').toLowerCase();
        const folder = S.vaultActiveFolder || 'all';
        const docs = S.vault.filter(d => {
            if (q && !(d.title||'').toLowerCase().includes(q) && !(d.content||'').toLowerCase().includes(q)) return false;
            if (folder !== 'all' && d.folder !== folder) return false;
            return true;
        });
        const list = document.getElementById('vault-list');
        if (!list) return;
        const realIdx = (d) => S.vault.indexOf(d);
        list.innerHTML = docs.length ? docs.map(d => `
            <div onclick="viewVaultDoc(${realIdx(d)})" style="padding:8px;cursor:pointer;border-bottom:1px solid var(--border-subtle);transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
                <div style="font-size:10px;color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:2px">${d.title||'Untitled'}</div>
                <div style="font-size:8px;color:var(--text-tertiary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;height:12px">${(d.content||'').replace(/\n/g,' ').slice(0,50)}</div>
                <div style="font-size:7px;color:var(--text-tertiary);margin-top:3px;opacity:0.6">${d.date||''}</div>
            </div>`).join('') : '<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:9px">No documents</div>';
        updateVaultStats();
    }
    function addVaultDoc() {
        const title = prompt('Document title:'); if (!title) return;
        const content = prompt('Content (or paste text):') || '';
        if (!S.vault) S.vault = [];
        const folder = S.vaultActiveFolder !== 'all' ? S.vaultActiveFolder : 'notes';
        S.vault.push({ id:'VD-'+Date.now(), title, folder, content, date:new Date().toISOString().split('T')[0] });
        save(); filterVault();
    }
    function viewVaultDoc(idx) {
        if (!S.vault || !S.vault[idx]) return;
        const d = S.vault[idx];
        const folderName = (S.vaultFolders||[]).find(f=>f.id===d.folder)?.name || d.folder || 'Unfiled';
        const viewer = document.getElementById('vault-viewer');
        viewer.style.alignItems = 'flex-start';
        viewer.style.justifyContent = 'flex-start';
        viewer.innerHTML = `
            <div style="padding:20px;width:100%;height:100%;overflow-y:auto">
                <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border-subtle)">
                    <div style="flex:1;min-width:0">
                        <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:4px">${d.title||'Untitled'}</div>
                        <div style="font-size:9px;color:var(--text-tertiary)">${folderName} · ${d.date||''}</div>
                    </div>
                    <div style="display:flex;gap:4px;flex-shrink:0">
                        <button class="btn btn-sm" onclick="openInWritingHub(${idx})" style="font-size:9px;padding:4px 8px">Edit in Writer</button>
                        <button class="btn btn-sm" onclick="copyVaultDoc(${idx})" style="font-size:9px;padding:4px 8px">Copy</button>
                        <button class="btn btn-sm" onclick="deleteVaultDoc(${idx})" style="font-size:9px;padding:4px 8px;color:var(--accent-danger)">Del</button>
                    </div>
                </div>
                <div style="font-size:12px;line-height:1.7;color:var(--text-secondary);white-space:pre-wrap">${d.content||''}</div>
            </div>`;
        // Q3: Cross-references
        const xrefPanel = document.getElementById('vault-xref');
        const xrefList = document.getElementById('vault-xref-list');
        if (xrefPanel && xrefList) {
            const refs = findXRefs(d);
            if (refs.length) {
                xrefPanel.style.display = 'block';
                xrefList.innerHTML = refs.map(r => `<div style="font-size:10px;padding:4px 0;border-bottom:1px solid var(--border-subtle);color:var(--text-secondary)">${r.type}: <b style="color:var(--text-primary)">${r.name}</b></div>`).join('');
            } else { xrefPanel.style.display = 'none'; }
        }
    }
    function findXRefs(doc) {
        const refs = [];
        const text = (doc.title + ' ' + (doc.content||'')).toLowerCase();
        // Match against research cards
        (S.research||[]).forEach(r => { if (text.includes((r.name||'').toLowerCase())) refs.push({type:'Research',name:r.name}); });
        // Match against TOC chapters
        (S.tocs.v1||[]).forEach(i => { if (i.type==='chapter' && text.includes(i.title.toLowerCase())) refs.push({type:'TOC',name:i.title}); });
        // Match against matrix nodes
        if (S.matrixData) (S.matrixData.nodes||[]).slice(0,30).forEach(n => { if (text.includes((n.name||'').toLowerCase())) refs.push({type:'Movement',name:n.name}); });
        return refs;
    }
    function editVaultDoc(idx) {
        if (!S.vault || !S.vault[idx]) return;
        const d = S.vault[idx];
        const t = prompt('Title:', d.title); if (t !== null) d.title = t;
        const c = prompt('Content:', d.content); if (c !== null) d.content = c;
        save(); filterVault(); viewVaultDoc(idx);
    }
    function copyVaultDoc(idx) { if (S.vault?.[idx]) navigator.clipboard.writeText(S.vault[idx].content||'').then(()=>showToast('Copied')); }
    function deleteVaultDoc(idx) {
        if (!confirm('Delete this document?')) return;
        S.vault.splice(idx, 1); save(); filterVault();
        document.getElementById('vault-viewer').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-tertiary);font-size:12px">Select a document to view</div>';
    }
    function exportVault() {
        if (!S.vault || S.vault.length === 0) { alert('Vault is empty'); return; }
        dl('knowledge-vault.json', JSON.stringify(S.vault, null, 2), 'application/json');
    }
    // Save current writing document to Vault
    function saveToVault() {
        const title = document.getElementById('doc-title')?.value || 'Untitled';
        const content = quill ? quill.getText() : '';
        if (!content.trim()) { showToast('Nothing to save'); return; }
        // Format selection
        const format = prompt('Save as format:\n1. Markdown (.md)\n2. Plain Text (.txt)\n\nEnter 1 or 2:', '1');
        if (!format) return;
        const ext = format === '2' ? 'txt' : 'md';
        if (!S.vault) S.vault = [];
        const folder = 'drafts';
        S.vault.push({
            id: 'VD-' + Date.now(),
            title: title + '.' + ext,
            folder: folder,
            content: content,
            format: ext,
            date: new Date().toISOString().split('T')[0]
        });
        save();
        showToast('Saved to Vault');
    }
    // Open vault document in Writing Hub
    function openInWritingHub(idx) {
        if (!S.vault || !S.vault[idx]) return;
        const d = S.vault[idx];
        S._editingVaultIdx = idx;
        S._pendingVaultContent = d.content || '';
        const cleanTitle = (d.title || 'Untitled').replace(/\.(md|txt)$/, '');
        S._pendingVaultTitle = cleanTitle;
        // Click the writing tab
        const writingTab = document.querySelector('[data-tab="writing"]');
        if (writingTab) writingTab.click();
        // After tab switch and init, load the content
        setTimeout(() => {
            document.getElementById('doc-title').value = S._pendingVaultTitle;
            if (quill) {
                quill.setText(S._pendingVaultContent);
            }
            showToast('Editing: ' + S._pendingVaultTitle);
            S._pendingVaultContent = null;
            S._pendingVaultTitle = null;
        }, 150);
    }

    // Vault drag-drop upload
    function handleVaultDrop(e) {
        e.preventDefault();
        const dz = document.getElementById('vault-dropzone');
        dz.style.borderColor = 'var(--border-subtle)';
        if (e.dataTransfer.files.length) handleVaultFiles(e.dataTransfer.files);
    }
    function handleVaultFiles(files) {
        if (!files || !files.length) return;
        if (!S.vault) S.vault = [];
        const folder = S.vaultActiveFolder !== 'all' ? S.vaultActiveFolder : 'drafts';
        Array.from(files).forEach(file => {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext !== 'md' && ext !== 'txt') {
                showToast('Only .md and .txt files supported');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(ev) {
                S.vault.push({
                    id: 'VD-' + Date.now() + '-' + Math.random().toString(36).substr(2,5),
                    title: file.name.replace(/\.[^/.]+$/, ''),
                    folder: folder,
                    content: ev.target.result,
                    date: new Date().toISOString().split('T')[0]
                });
                save();
                filterVault();
                showToast('Added: ' + file.name);
            };
            reader.readAsText(file);
        });
    }

    // R1: Auto-save version history
    function saveWithHistory() {
        if (!S._versions) S._versions = [];
        S._versions.push({ ts: Date.now(), data: JSON.stringify(S) });
        if (S._versions.length > 10) S._versions.shift(); // Keep last 10
    }
    // Hook into save
    const _origSave = save;
    // R2: Session recovery
    function checkSessionRecovery() {
        const lastSession = localStorage.getItem('vbcc1_session');
        if (lastSession) {
            try {
                const info = JSON.parse(lastSession);
                const diff = Date.now() - info.ts;
                if (diff < 86400000) { // Within 24h
                    const el = document.createElement('div');
                    el.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--bg-surface);border:1px solid var(--accent-gold);border-radius:8px;padding:12px 16px;z-index:300;font-size:11px;color:var(--text-secondary);max-width:300px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
                    el.innerHTML = `<div style="font-weight:600;color:var(--text-primary);margin-bottom:4px">Session Recovery</div>Last session: ${new Date(info.ts).toLocaleString()}<br>Tab: ${info.tab||'toc'}<div class="flex gap-2 mt-3"><button class="btn btn-sm btn-primary" onclick="this.closest('div').remove()">Dismiss</button></div>`;
                    document.body.appendChild(el);
                    setTimeout(() => { if (el.parentNode) el.remove(); }, 8000);
                }
            } catch(e) {}
        }
        // Save current session
        localStorage.setItem('vbcc1_session', JSON.stringify({ ts: Date.now(), tab: S.tab }));
    }

    // T1: Dashboard
    function initDashboard() {
        const stats = document.getElementById('dash-stats');
        if (!stats) return;
        const v1 = S.tocs.v1 || [];
        const chapters = v1.filter(i=>i.type==='chapter').length;
        const parts = v1.filter(i=>i.type==='part').length;
        const nodes = S.matrixData ? (S.matrixData.nodes||[]).length : 0;
        const edges = S.matrixData ? (S.matrixData.edges||[]).length : 0;
        const researchTotal = S.research.length;
        const researchUsed = S.research.filter(r=>r.used).length;
        const decisions = S.decisions.length;
        const bottlenecks = S.bottlenecks.length;
        const exercises = S.exercises.length;
        const vaultDocs = (S.vault||[]).length;
        stats.innerHTML = [
            { label:'TOC Chapters', value:chapters, color:'var(--accent-gold)', sub:parts+' parts' },
            { label:'Matrix Nodes', value:nodes, color:'var(--accent-blue)', sub:edges+' edges' },
            { label:'Research Cards', value:researchTotal, color:'var(--accent-success)', sub:researchUsed+' used' },
            { label:'Decisions', value:decisions, color:'var(--accent-purple)', sub:bottlenecks+' bottlenecks' },
            { label:'Exercises', value:exercises, color:'var(--accent-warning)', sub:'in library' },
            { label:'Vault Documents', value:vaultDocs, color:'var(--accent-blue)', sub:'in vault' }
        ].map(s => `
            <div class="card" style="padding:16px;text-align:center">
                <div style="font-size:28px;font-weight:700;color:${s.color}">${s.value}</div>
                <div style="font-size:11px;color:var(--text-primary);margin-top:4px">${s.label}</div>
                <div style="font-size:9px;color:var(--text-tertiary);margin-top:2px">${s.sub}</div>
            </div>`).join('');
        // Writing progress
        const wp = document.getElementById('dash-writing-progress');
        if (wp) {
            const written = [];
            v1.filter(i=>i.type==='chapter').forEach(ch => {
                const key = 'scc_doc_' + ch.title.replace(/\s+/g,'_').toLowerCase();
                const content = localStorage.getItem(key);
                const wc = content ? content.replace(/<[^>]*>/g,'').trim().split(/\s+/).filter(Boolean).length : 0;
                written.push({ title: ch.title, wc });
            });
            const total = written.reduce((s,w) => s + w.wc, 0);
            const withContent = written.filter(w => w.wc > 0).length;
            wp.innerHTML = `<div style="font-size:24px;font-weight:700;color:var(--accent-gold);margin-bottom:4px">${total.toLocaleString()} words</div><div style="font-size:10px;color:var(--text-tertiary);margin-bottom:8px">${withContent}/${written.length} chapters started</div>` +
                written.slice(0,8).map(w => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:10px;color:var(--text-secondary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${w.title}</span><span style="font-family:var(--font-mono);font-size:9px;color:${w.wc>0?'var(--accent-success)':'var(--text-tertiary)'}">${w.wc}</span></div>`).join('');
        }
        // Matrix coverage
        const mc = document.getElementById('dash-matrix-coverage');
        if (mc && S.matrixData) {
            const types = {};
            (S.matrixData.nodes||[]).forEach(n => { types[n.type||'OTHER'] = (types[n.type||'OTHER']||0) + 1; });
            mc.innerHTML = Object.entries(types).map(([t,c]) => `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid var(--border-subtle)"><span style="color:var(--text-secondary)">${t}</span><span style="font-weight:600;color:var(--text-primary)">${c}</span></div>`).join('');
        }
        // Recent decisions
        const rd = document.getElementById('dash-recent-decisions');
        if (rd) {
            rd.innerHTML = S.decisions.slice(-5).reverse().map(d => `<div style="padding:4px 0;border-bottom:1px solid var(--border-subtle);font-size:10px"><span class="badge ${d.status==='resolved'?'badge-green':'badge-orange'}" style="margin-right:6px">${d.status}</span>${d.title}</div>`).join('') || '<div style="font-size:10px;color:var(--text-tertiary)">No decisions yet</div>';
        }
        // Bottlenecks
        const db = document.getElementById('dash-bottlenecks');
        if (db) {
            db.innerHTML = S.bottlenecks.map(b => `<div style="padding:4px 0;border-bottom:1px solid var(--border-subtle);font-size:10px"><span class="badge ${b.priority==='high'?'badge-orange':''}" style="margin-right:6px">${b.priority}</span>${b.title}</div>`).join('') || '<div style="font-size:10px;color:var(--accent-success)">No active bottlenecks</div>';
        }
    }

    // Y1: MATRIX QUERY ENGINE
    function openQueryEngine() {
        document.getElementById('query-modal').classList.add('open');
        updateQueryUI();
    }
    function closeQueryEngine() { document.getElementById('query-modal').classList.remove('open'); }
    function getNodeSelect(id, label) {
        if (!S.matrixData || !S.matrixData.nodes) return '';
        const opts = S.matrixData.nodes.map(n => `<option value="${n.id}">${n.name} (${n.type||''})</option>`).join('');
        return `<div class="node-detail-label">${label}</div><select id="${id}" style="width:100%">${opts}</select>`;
    }
    function updateQueryUI() {
        const type = document.getElementById('query-type').value;
        const params = document.getElementById('query-params');
        document.getElementById('query-results').innerHTML = '';
        if (type === 'prerequisites' || type === 'unlocks') {
            params.innerHTML = getNodeSelect('query-node', 'Select Movement');
        } else if (type === 'path') {
            params.innerHTML = getNodeSelect('query-node-a', 'Start Node') + '<div style="margin-top:8px">' + getNodeSelect('query-node-b', 'End Node') + '</div>';
        } else if (type === 'cluster') {
            params.innerHTML = getNodeSelect('query-node', 'Center Node') + '<div style="margin-top:8px"><div class="node-detail-label">Depth (steps)</div><input type="number" id="query-depth" value="2" min="1" max="5" style="width:100%"></div>';
        } else if (type === 'pattern') {
            const patterns = [...new Set((S.matrixData?.nodes||[]).map(n => n.pattern).filter(Boolean))];
            params.innerHTML = '<div class="node-detail-label">Pattern</div><select id="query-pattern" style="width:100%">' + patterns.map(p => `<option value="${p}">${p}</option>`).join('') + '</select>';
        } else if (type === 'stage') {
            params.innerHTML = '<div class="node-detail-label">Stage</div><select id="query-stage" style="width:100%"><option value="0">Stage 0</option><option value="1">Stage 1</option><option value="2">Stage 2</option><option value="3">Stage 3</option></select>';
        } else {
            params.innerHTML = '';
        }
    }
    function runQuery() {
        const type = document.getElementById('query-type').value;
        const results = document.getElementById('query-results');
        if (!S.matrixData) { results.innerHTML = '<div style="color:var(--accent-danger)">No matrix data loaded</div>'; return; }
        const nodes = S.matrixData.nodes || [];
        const edges = S.matrixData.edges || [];
        let found = [];
        if (type === 'prerequisites') {
            const nodeId = document.getElementById('query-node')?.value;
            const incoming = edges.filter(e => String(e.target) === String(nodeId));
            found = incoming.map(e => { const n = nodes.find(n => String(n.id) === String(e.source)); return n ? { ...n, relation: 'prerequisite', transfer: e.transfer || e.type } : null; }).filter(Boolean);
        } else if (type === 'unlocks') {
            const nodeId = document.getElementById('query-node')?.value;
            const outgoing = edges.filter(e => String(e.source) === String(nodeId));
            found = outgoing.map(e => { const n = nodes.find(n => String(n.id) === String(e.target)); return n ? { ...n, relation: 'unlocks', transfer: e.transfer || e.type } : null; }).filter(Boolean);
        } else if (type === 'path') {
            const startId = String(document.getElementById('query-node-a')?.value);
            const endId = String(document.getElementById('query-node-b')?.value);
            found = bfsPath(nodes, edges, startId, endId);
        } else if (type === 'cluster') {
            const nodeId = String(document.getElementById('query-node')?.value);
            const depth = parseInt(document.getElementById('query-depth')?.value || '2');
            found = bfsCluster(nodes, edges, nodeId, depth);
        } else if (type === 'pattern') {
            const pattern = document.getElementById('query-pattern')?.value;
            found = nodes.filter(n => n.pattern === pattern);
        } else if (type === 'stage') {
            const stage = parseInt(document.getElementById('query-stage')?.value);
            found = nodes.filter(n => n.stage === stage);
        } else if (type === 'orphans') {
            const connected = new Set();
            edges.forEach(e => { connected.add(String(e.source)); connected.add(String(e.target)); });
            found = nodes.filter(n => !connected.has(String(n.id)));
        }
        renderQueryResults(found, type);
        // Highlight in graph
        if (cy && found.length) {
            cy.elements().removeClass('highlighted');
            found.forEach(n => {
                const cyNode = cy.getElementById(String(n.id));
                if (cyNode.length) cyNode.addClass('highlighted');
            });
        }
    }
    function bfsPath(nodes, edges, startId, endId) {
        const adj = {};
        edges.forEach(e => {
            const s = String(e.source), t = String(e.target);
            if (!adj[s]) adj[s] = [];
            adj[s].push(t);
        });
        const visited = new Set();
        const queue = [[startId]];
        visited.add(startId);
        while (queue.length) {
            const path = queue.shift();
            const last = path[path.length - 1];
            if (last === endId) return path.map(id => nodes.find(n => String(n.id) === id)).filter(Boolean);
            (adj[last] || []).forEach(next => {
                if (!visited.has(next)) { visited.add(next); queue.push([...path, next]); }
            });
        }
        return [{ name: 'No path found', type: 'info', stage: -1 }];
    }
    function bfsCluster(nodes, edges, centerId, depth) {
        const adj = {};
        edges.forEach(e => {
            const s = String(e.source), t = String(e.target);
            if (!adj[s]) adj[s] = [];
            if (!adj[t]) adj[t] = [];
            adj[s].push(t);
            adj[t].push(s);
        });
        const visited = new Set([centerId]);
        let frontier = [centerId];
        for (let d = 0; d < depth; d++) {
            const next = [];
            frontier.forEach(id => {
                (adj[id] || []).forEach(n => {
                    if (!visited.has(n)) { visited.add(n); next.push(n); }
                });
            });
            frontier = next;
        }
        return [...visited].map(id => nodes.find(n => String(n.id) === id)).filter(Boolean);
    }
    function renderQueryResults(found, type) {
        const results = document.getElementById('query-results');
        if (!found.length) { results.innerHTML = '<div style="padding:8px;color:var(--text-tertiary);font-size:11px">No results</div>'; return; }
        const sc = { 0:'#55efc4', 1:'#74b9ff', 2:'#ffeaa7', 3:'#ff7675' };
        results.innerHTML = `<div style="font-size:10px;color:var(--text-tertiary);margin-bottom:8px">${found.length} result${found.length>1?'s':''}</div>` +
            found.map((n, i) => `<div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border-subtle);cursor:pointer" onclick="focusQueryNode('${n.id}')">
                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${sc[n.stage]||'#888'};flex-shrink:0"></span>
                <div style="flex:1">
                    <div style="font-size:11px;color:var(--text-primary)">${type==='path'?(i+1)+'. ':'' }${n.name||'—'}</div>
                    <div style="font-size:9px;color:var(--text-tertiary)">${n.type||''} ${n.pattern?'· '+n.pattern:''} ${n.relation?'· '+n.relation:''} ${n.transfer?'('+n.transfer+')':''}</div>
                </div>
            </div>`).join('');
    }
    function focusQueryNode(id) {
        if (!cy) return;
        const node = cy.getElementById(String(id));
        if (node.length) { cy.animate({ fit: { eles: node, padding: 80 } }, { duration: 400 }); node.select(); showNodeDetail(node.data()); }
        closeQueryEngine();
    }

    // X1-X5: CALENDAR / EXCEL PARSER
    let calendarData = null;
    function initCalendar() {
        if (calendarData) renderCalendar(calendarData);
    }
    function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                calendarData = { fileName: file.name, sheets: {} };
                const sheetList = document.getElementById('excel-sheet-list');
                sheetList.innerHTML = '';
                workbook.SheetNames.forEach((name, idx) => {
                    const sheet = workbook.Sheets[name];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    calendarData.sheets[name] = json;
                    sheetList.innerHTML += `<div class="card" style="padding:8px;cursor:pointer;margin-bottom:4px" onclick="renderCalendarSheet('${name.replace(/'/g,"\\'")}')">
                        <div style="font-size:11px;color:var(--text-primary)">${name}</div>
                        <div style="font-size:9px;color:var(--text-tertiary)">${json.length} rows</div>
                    </div>`;
                });
                if (workbook.SheetNames.length > 0) renderCalendarSheet(workbook.SheetNames[0]);
            } catch(err) { alert('Error parsing file: ' + err.message); }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }
    function renderCalendarSheet(sheetName) {
        if (!calendarData || !calendarData.sheets[sheetName]) return;
        const rows = calendarData.sheets[sheetName];
        const content = document.getElementById('calendar-content');
        if (!rows.length) { content.innerHTML = '<div style="padding:20px;color:var(--text-tertiary)">Empty sheet</div>'; return; }
        // Detect if it looks like a calendar (has day/week columns) or workout data
        const header = rows[0] || [];
        const isCalendar = header.some(h => /week|day|mon|tue|wed|thu|fri|sat|sun/i.test(String(h||'')));
        if (isCalendar) renderCalendarGrid(rows, content);
        else renderDataTable(rows, content);
    }
    function renderCalendarGrid(rows, container) {
        const header = rows[0].map(h => String(h||''));
        const dayIndices = [];
        header.forEach((h, i) => {
            if (/mon|tue|wed|thu|fri|sat|sun|day/i.test(h)) dayIndices.push(i);
        });
        if (!dayIndices.length) { renderDataTable(rows, container); return; }
        let html = `<div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px">${calendarData.fileName} — Calendar View</div>`;
        html += '<div style="display:grid;grid-template-columns:repeat(' + Math.max(dayIndices.length, 1) + ',1fr);gap:8px">';
        // Header row
        dayIndices.forEach(i => {
            html += `<div style="padding:8px;background:var(--accent-glow);border-radius:var(--radius-sm);text-align:center;font-weight:600;color:var(--accent-gold);font-size:11px;text-transform:uppercase">${header[i]}</div>`;
        });
        // Data rows
        for (let r = 1; r < rows.length; r++) {
            const row = rows[r] || [];
            dayIndices.forEach(i => {
                const cell = String(row[i] || '');
                const hasExercise = cell.length > 2;
                html += `<div style="padding:10px;background:${hasExercise?'var(--bg-surface)':'var(--bg-deep)'};border:1px solid var(--border-subtle);border-radius:var(--radius-sm);min-height:60px;font-size:10px;color:${hasExercise?'var(--text-primary)':'var(--text-tertiary)'}">${cell.replace(/\n/g,'<br>') || '—'}</div>`;
            });
        }
        html += '</div>';
        container.innerHTML = html;
    }
    function renderDataTable(rows, container) {
        const header = rows[0] || [];
        let html = `<div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px">${calendarData?.fileName||'Data'} — Table View</div>`;
        html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:10px">';
        html += '<thead><tr>' + header.map(h => `<th style="padding:8px;text-align:left;border-bottom:2px solid var(--accent-gold);color:var(--accent-gold);font-family:var(--font-mono);font-size:9px;text-transform:uppercase;white-space:nowrap">${h||''}</th>`).join('') + '</tr></thead>';
        html += '<tbody>';
        for (let r = 1; r < Math.min(rows.length, 200); r++) {
            const row = rows[r] || [];
            html += '<tr>' + header.map((_, i) => `<td style="padding:6px 8px;border-bottom:1px solid var(--border-subtle);color:var(--text-secondary);white-space:nowrap">${row[i]!==undefined?row[i]:''}</td>`).join('') + '</tr>';
        }
        html += '</tbody></table></div>';
        if (rows.length > 200) html += `<div style="padding:8px;font-size:10px;color:var(--text-tertiary)">Showing 200 of ${rows.length} rows</div>`;
        container.innerHTML = html;
    }
    function renderCalendar(data) {
        if (data && data.sheets) {
            const firstSheet = Object.keys(data.sheets)[0];
            if (firstSheet) renderCalendarSheet(firstSheet);
        }
    }
    function exportCalendarCSV() {
        if (!calendarData) { alert('No data loaded'); return; }
        const sheetName = Object.keys(calendarData.sheets)[0];
        const rows = calendarData.sheets[sheetName];
        const csv = rows.map(r => (r||[]).map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
        dl(calendarData.fileName.replace(/\.\w+$/,'') + '.csv', csv, 'text/csv');
    }
    function exportCalendarPDF() {
        if (!calendarData) { alert('No data loaded'); return; }
        const sheetName = Object.keys(calendarData.sheets)[0];
        const rows = calendarData.sheets[sheetName];
        if (!rows.length) return;
        const header = rows[0].map(h => ({ text: String(h||''), bold: true, fontSize: 8, color: '#ffaa00' }));
        const body = [header];
        for (let r = 1; r < Math.min(rows.length, 100); r++) {
            body.push((rows[r]||[]).map(c => ({ text: String(c||''), fontSize: 7 })));
        }
        // Pad short rows
        const maxCols = Math.max(...body.map(r => r.length));
        body.forEach(r => { while(r.length < maxCols) r.push({ text: '', fontSize: 7 }); });
        const dd = { content: [
            { text: calendarData.fileName, style: 'header', margin: [0,0,0,10] },
            { table: { headerRows: 1, body }, layout: 'lightHorizontalLines' }
        ], styles: { header: { fontSize: 14, bold: true } }, defaultStyle: { fontSize: 8 } };
        pdfMake.createPdf(dd).download(calendarData.fileName.replace(/\.\w+$/,'') + '.pdf');
    }
    function buildWorkoutFromCalendar() {
        if (!calendarData) { alert('No data loaded'); return; }
        const sheetName = Object.keys(calendarData.sheets)[0];
        const rows = calendarData.sheets[sheetName];
        // Extract exercise-like entries from all cells
        const exercises = [];
        for (let r = 1; r < rows.length; r++) {
            (rows[r]||[]).forEach(cell => {
                const val = String(cell||'').trim();
                if (val && val.length > 2 && !/^\d+$/.test(val)) exercises.push(val);
            });
        }
        if (!exercises.length) { alert('No exercises found'); return; }
        // Switch to workout tab and add to builder
        alert('Found ' + exercises.length + ' exercise entries. Switch to Workout tab to use them.');
    }

    // UTILITIES
    function dl(name,content,type) {
        const b=new Blob([content],{type}), u=URL.createObjectURL(b), a=document.createElement('a');
        a.href=u; a.download=name; document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(u); }, 100);
    }
    function save() { try { localStorage.setItem('vbcc1',JSON.stringify(S)); } catch(e) { console.warn('Save failed',e); alert('Save failed — localStorage may be full. Export a backup now.'); } }
    function load() { const d=localStorage.getItem('vbcc1'); if(d) { try { Object.assign(S,JSON.parse(d)); } catch(e) {} } }
    function exportAllState() { dl('command-center-state.json',JSON.stringify(S,null,2),'application/json'); }
    function resetToLastSaved() {
        if(!confirm('Reset all changes to the last saved state? Any unsaved work will be lost.')) return;
        const d=localStorage.getItem('vbcc1');
        if(d) { try { const parsed=JSON.parse(d); Object.keys(parsed).forEach(k=>S[k]=parsed[k]); location.reload(); } catch(e) { alert('Reset failed'); } }
        else { alert('No saved state found'); }
    }

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        load();
        // Re-sync stageNames after load (load replaces S.stageNames reference)
        if (S.stageNames) { for (const k in S.stageNames) stageNames[k] = S.stageNames[k]; }
        S.stageNames = stageNames;
        if (!S.tocs.v3) S.tocs.v3 = [];
        if (!S.vault) S.vault = [];
        if (S.tocs.v1.length === 0) loadExternalTOC().catch(()=>loadDefaultTOC());
        else initTOC();
        loadExternalResearch().catch(()=>{});
        loadMatrix().catch(()=>{});
        // R2: Session recovery
        checkSessionRecovery();
        // V1: Drag-and-drop on HTML upload zone
        const dropZone = document.getElementById('html-drop-zone');
        if (dropZone) {
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent-gold)'; });
            dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#27272a'; });
            dropZone.addEventListener('drop', e => {
                e.preventDefault(); dropZone.style.borderColor = '#27272a';
                const dt = e.dataTransfer;
                if (dt.files.length) { document.getElementById('html-file-upload').files = dt.files; handleHTMLUpload({ target: { files: dt.files, value: '' } }); }
            });
        }

        // Escape key closes gallery preview
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                const gm = document.getElementById('gallery-preview-modal');
                if (gm && gm.classList.contains('open')) closeGalleryPreview();
            }
        });

        // D2: doc-title change syncs to TOC + writing sidebar
        const docTitle = document.getElementById('doc-title');
        if (docTitle) {
            docTitle.addEventListener('change', function() {
                // Find matching chapter in v1 by old stored title and update
                if (S._activeChapterTitle) {
                    const v1 = S.tocs.v1 || [];
                    const match = v1.find(i => i.title === S._activeChapterTitle);
                    if (match) { match.title = this.value; syncTOCEverywhere(); save(); }
                }
                S._activeChapterTitle = this.value;
            });
        }
    });
    </script>
</body>
</html>
